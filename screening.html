<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Functional Shoulder Screening</title>
    <script src="https://cdn.plot.ly/plotly-2.27.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Avenir:wght@400&family=Futura:wght@400&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" xintegrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --app-primary-color: #285484;
            --app-secondary-color: rgb(112, 188, 252);
            --app-tertiary-color: #121630;
            --app-text-on-primary: #ffffff;
            --app-text-on-secondary: var(--app-primary-color);
            --app-button-text-color: var(--app-text-on-primary);
            --app-button-icon-color: var(--app-secondary-color);
            --app-button-gradient-start: var(--app-primary-color);
            --app-button-gradient-end: var(--app-tertiary-color);
            --app-button-hover-gradient-start: #1e3a5c;
            --app-button-hover-gradient-end: #121630;
            --app-button-light-gradient-start: rgba(112, 188, 252, 0.8);
            --app-button-light-gradient-end: rgba(40, 84, 132, 0.9);
            --light-gray: #f8f9fa; /* Main page background */
            --box-background-color: #f0f2f5; /* Intermediate gray for boxes and sidebar */
            --medium-gray: #dee2e6;
            --dark-gray: #495057;
            --text-color: #212529;
            --success-color: #2a9d8f; /* Consistent green for success */
            --success-border-color: #217e72; /* Darker shade of #2a9d8f */
            
            --success-shadow-color: rgba(22, 163, 74, 0.45); 
            --success-gradient-start-color: rgba(22, 163, 74, 1); 

            --warning-color: #facc15;
            --danger-color-dark: #dc2626;
            --white: #ffffff;
            --border-radius: 4px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --sidebar-border-color: var(--medium-gray);
            --header-border-color: var(--medium-gray);
            --subtle-shadow: 0 1px 3px rgba(0,0,0,0.07);
            --left-line-color: #ff7f0e; /* Orange */
            --right-line-color: #1f77b4; /* Blue */

            --norm-poor-bg: rgba(252, 165, 165, 0.5);
            --norm-average-bg: rgba(252, 211, 77, 0.5);
            --norm-good-bg: rgba(167, 243, 208, 0.5);
            --norm-excellent-bg: rgba(52, 211, 153, 0.5);

            --status-success-bg: rgba(74, 222, 128, 0.55);
            --status-error-bg: rgba(220, 38, 38, 0.55);
            --status-info-bg: rgba(250, 204, 21, 0.55);

            --base-font-size: 16px;
            --graph-box-height: 340px; 
            --sidebar-width: 180px;
            --normal-font-weight: 400;
            --semibold-font-weight: 400;
            --bold-font-weight: 700;
            --main-content-margin: 20px;
        }
        body {
            font-family: 'Avenir', sans-serif;
            background-color: var(--light-gray);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            width: 100%;
            box-sizing: border-box;
            line-height: 1.6;
            font-size: var(--base-font-size);
            font-weight: var(--normal-font-weight);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-synthesis: none;
        }
        .app-layout {
            display: none;
            flex-direction: row;
            width: 100%;
            min-height: 100vh;
            margin-top: 0;
        }
        .loading-message {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 1.2em;
            color: var(--app-primary-color);
            text-align: center;
            position: fixed;
            top: 0; left: 0; width: 100%;
            background-color: var(--light-gray);
            z-index: 2000;
        }
        .status-message {
            height: auto;
            padding: 12px 18px;
            border-radius: var(--border-radius);
            min-width: 220px;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            display: none;
            font-size: 0.95rem;
            position: fixed;
            z-index: 2000;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .status-message.success { background-color: var(--status-success-bg); color: var(--text-color); }
        .status-message.error { background-color: var(--status-error-bg); color: var(--text-color); }
        .status-message.info { background-color: var(--status-info-bg); color: var(--text-color); }


        .app-sidebar {
            width: var(--sidebar-width);
            background-color: var(--box-background-color);
            color: var(--text-color);
            padding: 20px 15px;
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            border-right: none;
        }
        .sidebar-logo-placeholder {
           display: flex;
           align-items: center;
           justify-content: center;
           height: 50px;
           margin-bottom: 30px;
           font-size: 1.8rem;
           color: var(--app-primary-color);
        }
        .sidebar-buttons { display: flex; flex-direction: column; gap: 12px; }

        .app-sidebar button, .app-sidebar a > button {
            font-family: 'Avenir', sans-serif;
            font-size: 0.9rem;
            font-weight: var(--normal-font-weight);
            padding: 10px 15px;
            color: var(--app-primary-color);
            background-color: transparent;
            background-image: none;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: none;
            letter-spacing: 0.5px;
            width: 100%;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-sidebar button i, .app-sidebar a > button i {
            width: 20px;
            text-align: center;
            color: var(--app-primary-color);
            transition: color 0.3s ease;
            flex-shrink: 0;
            font-size: 1em;
            line-height: 1;
        }
         .app-sidebar button .button-text, .app-sidebar a > button .button-text {
            line-height: 1;
            flex-grow: 1;
        }

        .app-sidebar button:not(#logout-button):hover,
        .app-sidebar a > button:not(#logout-button):hover {
            background-image: linear-gradient(to right, var(--app-button-light-gradient-start), var(--app-button-light-gradient-end));
            color: var(--app-text-on-primary);
            transform: translateY(-1px);
            border-color: transparent;
        }

        .app-sidebar button:active, .app-sidebar a > button:active {
            transform: translateY(0px);
        }

        .app-sidebar button#logout-button {
            margin-top: 10px;
            background-image: none;
            background-color: transparent;
            color: var(--app-primary-color);
            border: 1px solid var(--app-primary-color);
        }
        .app-sidebar button#logout-button:hover {
            background-color: var(--app-primary-color);
            color: var(--app-text-on-primary);
        }
        .app-sidebar button#logout-button i {
            color: var(--app-primary-color);
        }
        .app-sidebar button#logout-button:hover i {
            color: var(--app-text-on-primary);
        }
        .app-sidebar a { text-decoration: none; display: block; }


        .sidebar-user-info {
            margin-top: auto;
            padding: 15px 10px;
            text-align: center;
            border-top: 1px solid var(--medium-gray);
        }
        .user-details {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }
        #loggedInUserName {
            font-weight: var(--semibold-font-weight);
            font-size: 0.95rem;
            color: var(--app-primary-color);
            overflow-wrap: break-word;
            word-break: break-all;
        }
        #loggedInUserEmailDisplay {
            font-size: 0.75rem;
            color: var(--dark-gray);
            overflow-wrap: break-word;
            word-break: break-all;
        }

        .sidebar-social-links {
            padding-top: 10px;
            margin-bottom: 25px;
            text-align: center;
        }
        .sidebar-social-links a { color: var(--app-primary-color); margin: 0 20px; font-size: 1.5rem; text-decoration: none; transition: color 0.2s ease; }
        .sidebar-social-links a:hover { color: var(--app-secondary-color); }
        .app-main-content {
            flex-grow: 1;
            margin-left: calc(var(--sidebar-width) + var(--main-content-margin));
            padding: 30px 40px;
            background-color: var(--white);
            overflow-y: auto;
            height: 100vh;
            box-sizing: border-box;
        }
        .content-container {
            max-width: 1100px;
            margin: 0 auto;
        }
        h1, h2, h3 { font-family: 'Avenir', sans-serif; margin-bottom: 0.75em; font-weight: var(--normal-font-weight); }
        h1 { text-align: left; font-size: 2.0rem; margin-top: 0; margin-bottom: 1em; color: var(--app-primary-color); font-weight: var(--normal-font-weight); }
        h2.section-title-main {
            font-size: 1.5rem;
            padding-bottom: 0.4em;
            margin-top: 1.8em;
            color: var(--app-secondary-color);
            font-weight: var(--normal-font-weight);
        }
        h3.position-title, h3.normative-title { font-size: 1.15rem; color: var(--app-primary-color); margin-bottom: 0.3em; font-weight: var(--normal-font-weight); }
        h3.normative-title { text-align: center;}
        #report-content { background-color: var(--white); padding: 15px 0; }

        #patient-choice-container {
            background-color: var(--box-background-color);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
        }
        #patient-choice-section {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
        }
        .choice-box {
            background-color: transparent;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            padding: 20px 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 180px;
            box-shadow: none;
        }
        .choice-box:hover {
            background-color: rgba(40, 84, 132, 0.8);
            border-color: transparent;
        }
        .choice-box:hover i,
        .choice-box:hover span {
            color: white;
        }
        .choice-box.active-choice {
            background-color: var(--app-primary-color);
            color: white;
            border-color: var(--app-primary-color);
            box-shadow: var(--subtle-shadow);
        }
        .choice-box.active-choice i,
        .choice-box.active-choice span {
            color: white;
        }

        .choice-box i {
            font-size: 2.2rem;
            color: var(--app-primary-color);
            margin-bottom: 10px;
            display: block;
            transition: color 0.2s ease;
        }
        .choice-box span {
            font-size: 1rem;
            color: var(--text-color);
            font-weight: var(--semibold-font-weight);
            transition: color 0.2s ease;
        }

        #existing-patient-search-container {
            display: none;
            margin-bottom: 25px;
            padding: 20px;
            background-color: var(--box-background-color);
            border-radius: var(--border-radius);
        }
        #existing-patient-search-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: var(--semibold-font-weight);
            color: var(--app-primary-color);
        }
        #existing-patient-search-container input[type="text"] {
            font-family: 'Avenir', sans-serif;
            font-size: 1rem;
            padding: 8px 12px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            background-color: var(--white);
            color: var(--text-color);
            width: 100%;
            box-sizing: border-box;
        }
        #existing-patient-search-container input[type="text"]:focus {
            border-color: var(--app-primary-color);
            outline: 2px solid var(--app-secondary-color);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: rgba(255, 255, 255, 0.1);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            padding: 30px 40px;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            width: auto;
            max-width: 650px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: none;
            color: var(--white);
        }
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 25px;
            color: var(--white);
            text-align: center;
            font-size: 1.6rem;
            font-weight: 300;
        }
        .modal-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .modal-form-item {
            display: flex;
            flex-direction: column;
        }
        .modal-form-item label {
            margin-bottom: 6px;
            font-size: 0.85rem;
            color: rgba(255,255,255,0.8);
            font-weight: 300;
        }
        .modal-form-item input,
        .modal-form-item select {
            padding: 10px 12px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            width: 100%;
            box-sizing: border-box;
            background-color: rgba(255,255,255,0.1);
            color: var(--white);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        .modal-form-item select option {
            color: var(--text-color);
            background-color: var(--white);
        }
        .modal-form-item select {
            color: var(--white);
        }
        .modal-form-item select option[value=""] {
            color: rgba(255,255,255,0.6);
        }
        .modal-form-item input:focus,
        .modal-form-item select:focus {
            border-color: var(--app-secondary-color);
            background-color: rgba(255,255,255,0.15);
            outline: none;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1), 0 0 0 2px rgba(112, 188, 252, 0.4);
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }
        .modal-actions button {
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: var(--semibold-font-weight);
            transition: background-image 0.2s ease-in-out, background-color 0.2s ease, color 0.2s ease;
            border: none;
        }
        .modal-confirm-button {
            background-image: linear-gradient(to right, var(--app-button-light-gradient-start), var(--app-button-light-gradient-end));
            color: var(--app-text-on-primary);
        }
        .modal-confirm-button:hover {
            background-image: linear-gradient(to right, var(--app-button-hover-gradient-start), var(--app-button-hover-gradient-end));
        }
        .modal-cancel-button {
            background-color: transparent;
            color: var(--white);
            border: 1px solid rgba(255,255,255,0.5);
        }
        .modal-cancel-button:hover {
            background-color: rgba(255,255,255,0.1);
            border-color: var(--white);
        }
        .modal-patient-id-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            margin-bottom: 20px;
            height: 150px; 
            width: 640px; 
            overflow-y: auto; 
            padding: 5px;
            border: none;
            border-radius: var(--border-radius);
            align-content: flex-start; 
        }
        .modal-patient-id-button {
            background-color: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--white);
            padding: 8px 12px; 
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            width: 150px; 
            height: 40px; 
            flex-shrink: 0; 
            flex-grow: 0; 
            text-align: center;
            box-sizing: border-box; 
            display: flex; 
            justify-content: center;
            align-items: center;
        }
        .modal-patient-id-button:hover {
            background-color: var(--app-secondary-color);
            color: var(--app-primary-color);
            border-color: var(--app-secondary-color);
        }

        #patient-overview-section {
            display: none;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
            align-items: stretch;
        }

        .overview-column {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .patient-details-column {
            flex: 1 1 280px;
            min-width: 260px;
        }

        .test-log-column {
            flex: 2 1 400px;
            min-width: 300px;
        }

        .patient-card, #selected-patient-tests-container {
            background-color: var(--box-background-color);
            border-radius: var(--border-radius);
            padding: 20px;
            border: none;
            box-shadow: none;
            min-height: 320px;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }
         .patient-profile-title-internal {
            font-size: 1.3rem;
            color: var(--app-primary-color);
            margin-bottom: 10px;
            padding-bottom: 5px;
            margin-top:0;
            border-bottom: 1px solid var(--medium-gray);
            position: relative; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .patient-profile-title-internal .action-buttons {
            display: flex;
            gap: 20px; 
        }
        .edit-profile-button, .delete-patient-btn {
            background-color: transparent; 
            color: var(--app-primary-color); 
            border: none;
            padding: 0; 
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1.2rem; 
            transition: color 0.2s ease; 
            display: flex;
            align-items: center;
            gap: 0; 
            box-shadow: none; 
        }
        .edit-profile-button:hover {
            background-color: transparent; 
            color: var(--app-secondary-color); 
        }
        .edit-profile-button i {
            color: inherit; 
        }
        .delete-patient-btn {
            color: var(--app-primary-color); 
        }
        .delete-patient-btn:hover {
            color: var(--app-secondary-color); 
        }

        .patient-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            justify-content: flex-start;
        }
        .patient-card-icon {
            font-size: 6rem;
            color: var(--app-primary-color);
            margin-right: 50px;
        }
        .patient-card-id-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .patient-card-id-label {
            display: block;
            font-size: 0.9rem;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        .patient-card-id {
            display: block;
            font-size: 1.8rem;
            font-weight: var(--bold-font-weight);
            color: var(--app-primary-color);
        }
        .patient-card-body .info-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            font-size: 0.95rem;
        }
        .patient-card-body .info-item .info-icon {
            color: var(--app-secondary-color);
            margin-right: 12px;
            width: 22px;
            text-align: center;
            font-size: 1.2em;
            line-height: 1; 
        }
        .patient-card-body .info-item .label {
            color: var(--dark-gray);
            font-weight: var(--normal-font-weight);
            margin-right: auto;
        }
        .patient-card-body .info-item .value {
            color: var(--text-color);
            font-weight: var(--bold-font-weight);
            text-align: right;
        }

        #selected-patient-tests-container .test-log-title-internal {
            font-size: 1.3rem;
            color: var(--app-primary-color);
            margin-bottom: 18px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--medium-gray);
            margin-top:0;
            font-weight: var(--normal-font-weight);
        }

        #selected-patient-tests-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            overflow-y: auto;
            flex-grow: 1;
            justify-content: flex-start;
            align-content: flex-start;
        }

        #selected-patient-tests-list li {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px 12px;
            border: 1px solid rgba(40, 84, 132, 0.3);
            background-color: rgba(112, 188, 252, 0.05);
            border-radius: var(--border-radius);
            min-width: 140px;
            width: auto;
            box-sizing: border-box;
            text-align: center;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            cursor: pointer;
        }

        #selected-patient-tests-list li:hover {
            background-color: rgba(112, 188, 252, 0.3);
            border-color: rgba(40, 84, 132, 0.6);
            box-shadow: var(--subtle-shadow);
        }

        #selected-patient-tests-list li.active-test-item,
        #selected-patient-tests-list li.active-test-item:hover {
            background-color: rgba(112, 188, 252, 0.3);
            border-color: var(--app-primary-color);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.05);
        }


        #selected-patient-tests-list li span {
            color: var(--app-primary-color);
            font-size: 0.85rem;
            font-weight: var(--semibold-font-weight);
            margin-bottom: 8px;
        }

        #selected-patient-tests-list button.delete-test-btn {
            background-color: transparent;
            border: 1px solid transparent;
            color: var(--danger-color-dark);
            border-radius: var(--border-radius);
            cursor: pointer;
            padding: 4px 7px;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            width: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #selected-patient-tests-list button.delete-test-btn:hover {
            background-color: var(--danger-color-dark);
            color: white;
            border-color: var(--danger-color-dark);
        }

        #patient-data-container { display:none !important; }


        #save-data-button-container { margin-top: 20px; margin-bottom: 20px; text-align: center; }
        #save-data-button-main {
            background-image: none;
            background-color: transparent;
            color: var(--app-primary-color);
            border: 1px solid var(--app-primary-color);
            padding: 10px 25px;
            font-size: 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: none;
        }
        #save-data-button-main:hover {
            background-color: var(--app-primary-color);
            color: var(--app-text-on-primary);
        }
        #save-data-button-main i {
            color: var(--app-primary-color);
        }
        #save-data-button-main:hover i {
            color: var(--app-text-on-primary);
        }


        #input-section-container { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
        .input-position-box { flex: 1; min-width: 300px; padding: 15px; background: linear-gradient(to top right, rgb(222, 226, 230), rgb(112, 188, 252)); box-shadow: var(--box-shadow); border-radius: var(--border-radius); margin-bottom: 20px; position: relative; overflow: hidden; }
        .input-position-box h4 { font-family: 'Avenir', sans-serif; font-weight: var(--normal-font-weight); font-size: 1.2rem; color: var(--app-primary-color); margin-top: 0; margin-bottom: 20px; text-align: left; border-bottom: none; padding-bottom: 0; position: relative; z-index: 1; }
        .input-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 15px; gap: 5px; position: relative; z-index: 1; }
        .input-row label { font-family: 'Avenir', sans-serif; font-size: 0.9rem; color: var(--text-color); width: 160px; flex-shrink: 0; text-align: left; font-weight: var(--normal-font-weight); padding-bottom: 8px; }
        .input-wrapper { display: flex; align-items: baseline; flex: 1; justify-content: flex-start; }
        .input-position-box .input-row input { font-family: 'Avenir', sans-serif; font-size: 1.5rem; font-weight: var(--normal-font-weight); width: 100px; height: auto; border: none; border-bottom: 1px solid rgba(255, 255, 255, 0.5); border-radius: 0px; padding: 6px 0px 4px 0px; text-align: center; box-sizing: border-box; transition: background-color 0.2s ease, border-color 0.2s ease; background-color: transparent; color: var(--text-color); position: relative; z-index: 1; }
        .input-position-box .input-row input::placeholder { font-size: 0.8rem; color: #ffffff; font-weight: var(--normal-font-weight); opacity: 0.8; }
        .input-position-box .input-row input:focus { outline: none; border-bottom-color: rgba(255, 255, 255, 0.9); background-color: rgba(255, 255, 255, 0.1); }
        .input-position-box .unit-text { font-size: 0.9rem; color: var(--text-color); margin-left: 5px; white-space: nowrap; }
        .unit-text sup { font-size: 0.7em; vertical-align: super; }
        #canvas-container { display: none; } /* For potential future canvas use */
        .position-row { display: flex; flex-wrap: wrap; gap: 30px; margin-bottom: 35px; padding-bottom: 30px; align-items: stretch; }
        .position-row:last-child { border-bottom: none; margin-bottom: 0; }
        .asymmetry-graph-container { flex: 6; min-width: 320px; }
        .normative-graph-container { flex: 4; min-width: 260px; }

        .position-box, .normative-box {
            border: none;
            padding: 10px 20px 15px 20px;
            border-radius: var(--border-radius);
            background-color: var(--box-background-color);
            box-shadow: var(--subtle-shadow);
            margin-bottom: 0;
            transition: box-shadow 0.3s ease, opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            height: var(--graph-box-height); 
            position: relative;
            overflow: hidden;
        }
        .position-box.green-box {
            box-shadow: 0 0 15px 5px var(--success-shadow-color); 
        }
        .position-box::after { 
            content: ''; 
            position: absolute; 
            top: -100px; 
            right: -100px; 
            width: 500px; 
            height: 500px; 
            background-image: radial-gradient(circle at top right, var(--success-gradient-start-color) 0%, rgba(248, 249, 250, 0) 65% ); 
            opacity: 0; 
            pointer-events: none; 
            z-index: 0; 
            border-radius: 50%; 
            transition: opacity 0.3s ease; 
        }
        .position-box.green-box::after { opacity: 0.85; }
        .js-plotly-plot { flex-grow: 1; position: relative; z-index: 1; }
        #normative-placeholder { text-align: center; color: var(--dark-gray); font-style: italic; padding: 20px; background-color: var(--box-background-color); border-radius: var(--border-radius); margin-top: 1em;}
        #bottom-area { margin-top: 30px; padding-top: 15px; border-top: 1px solid var(--medium-gray); min-height: 30px; }
        #preview-exit-button-inline { display: none; position: fixed; top: 15px; right: 15px; background-color: var(--danger-color-dark); color: white; padding: 8px 15px; font-size: 0.9rem; font-weight: var(--normal-font-weight); border: none; border-radius: var(--border-radius); cursor: pointer; z-index: 1001; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.3s ease; font-family: inherit; }
        #preview-exit-button-inline:hover { background-color: #b91c1c; box-shadow: 0 4px 10px rgba(185, 28, 28, 0.3); transform: translateY(-1px); }
        #preview-exit-button-inline:active { transform: translateY(0px); box-shadow: 0 2px 5px rgba(185, 28, 28, 0.2); }
        #preview-exit-button-inline i { margin-right: 6px; }
        .explanation-box { display: none; background-color: var(--box-background-color); border: 1px solid var(--medium-gray); border-left: 5px solid var(--app-primary-color); padding: 15px; margin: 1em 0 2em 0; border-radius: var(--border-radius); font-size: 0.9em; color: var(--dark-gray); }
        .explanation-box h4 { margin-top: 0; color: var(--app-primary-color); font-family: inherit; font-weight: var(--normal-font-weight); }
        .explanation-box p { margin-bottom: 0.5em; }
        .explanation-box ul { margin-top: 0.5em; padding-left: 20px; }

        /* PDF Preview / Print Mode Active */
        body.pdf-preview-active {
            --graph-box-height: 340px !important; 
        }
        body.pdf-preview-active .app-sidebar,
        body.pdf-preview-active #patient-choice-section,
        body.pdf-preview-active #patient-choice-container,
        body.pdf-preview-active #existing-patient-search-container,
        body.pdf-preview-active #patient-data-secondary-controls,
        body.pdf-preview-active #patient-data-container,
        body.pdf-preview-active #patient-overview-section,
        body.pdf-preview-active #patient-card-and-log-title,
        body.pdf-preview-active #input-section-container,
        body.pdf-preview-active #save-data-button-container,
        body.pdf-preview-active #bottom-area,
        body.pdf-preview-active .sidebar-social-links,
        body.pdf-preview-active #loggedInUserContainer,
        body.pdf-preview-active .sidebar-buttons,
        body.pdf-preview-active #patient-details-title,
        body.pdf-preview-active #input-title,
        body.pdf-preview-active #selected-patient-tests-container
        {
            display: none !important;
        }

        body.pdf-preview-active h1,
        body.pdf-preview-active .explanation-box,
        body.pdf-preview-active #results-title,
        body.pdf-preview-active .position-row
        {
            display: block !important;
        }
         body.pdf-preview-active .position-row {
            display: flex !important;
            flex-wrap: wrap !important; 
            gap: 10px !important; 
        }

         body.pdf-preview-active #results-title {
            margin-top: 5mm !important;
            text-align: center !important;
           }


        body.pdf-preview-active .app-main-content {
            margin-left: 0 !important;
            padding: 5mm 50mm !important;
            height: auto !important;
            overflow: visible !important;
            box-shadow: none !important; 
            border: none !important; 
        }
        body.pdf-preview-active .content-container {
            max-width: 100% !important;
        }

        body.pdf-preview-active .explanation-box {
            margin: 0 0 5mm 0 !important;
        }
        body.pdf-preview-active .position-row {
            flex-direction: row !important;
            page-break-inside: avoid !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }
         body.pdf-preview-active .asymmetry-graph-container{
            flex: 6 !important; 
            min-width: 0 !important; 
            margin-bottom: 5mm !important;
            page-break-inside: avoid !important;
           }
         body.pdf-preview-active .normative-graph-container {
            flex: 4 !important; 
            min-width: 0 !important; 
            margin-bottom: 5mm !important;
           }
        body.pdf-preview-active .position-box,
        body.pdf-preview-active .normative-box {
            background-color: var(--box-background-color) !important; 
            box-shadow: var(--subtle-shadow) !important; 
            border: none !important; 
            height: var(--graph-box-height) !important; 
            min-height: var(--graph-box-height) !important; 
            padding: 10px 20px 15px 20px !important; /* Match main view padding */
            overflow: hidden !important;
            display: flex !important;
            flex-direction: column !important;
            width: 100% !important;
        }
        body.pdf-preview-active .position-box.green-box {
             box-shadow: 0 0 15px 5px var(--success-shadow-color) !important; /* Apply green shadow in PDF */
        }
        /* Removed rule that hid ::after in PDF, so fade effect can show */
        /* body.pdf-preview-active .position-box::after { display: none !important; } */

        .js-plotly-plot { width: 100% !important; height: 100% !important; flex-grow: 1 !important; }
        .plotly .scatterlayer .trace.fill { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        
        /* Main View Plotly Annotation Styling */
        .plotly .annotation .norm-label, 
        .plotly .annotation .left-label, 
        .plotly .annotation .right-label, 
        .plotly .annotation .value-display, 
        .plotly .annotation .nkg-combined-text span,
        .plotly .annotation .asymmetry-percent { /* Though .asymmetry-percent is not used by JS for dynamic values */
            fill: black !important; 
            color: black !important; 
            font-weight: normal !important; 
        }
        .plotly .annotation text { 
            font-weight: normal !important; 
        }

        /* PDF Preview Plotly Annotation Styling */
        body.pdf-preview-active .plotly .annotation .norm-label, 
        body.pdf-preview-active .plotly .annotation .left-label, 
        body.pdf-preview-active .plotly .annotation .right-label, 
        body.pdf-preview-active .plotly .annotation .value-display, 
        body.pdf-preview-active .plotly .annotation .nkg-combined-text span,
        body.pdf-preview-active .plotly .annotation .asymmetry-percent {
            fill: black !important; 
            color: black !important; 
            font-weight: normal !important; 
        }
        /* Allow JS to control color of unclassed text annotations in PDF (for percentageDiff) */
        body.pdf-preview-active .plotly .annotation text {
            font-weight: normal !important;
            /* fill: black !important; IS REMOVED HERE to allow JS color */
        }

        .plotly .annotation .norm-value { font-weight: normal !important; } /* This applies to both views */
        .plotly .gtitle { fill: black !important; font-weight: normal !important; }
        .plotly .axistitle { fill: black !important; font-size: 9pt !important; font-weight: normal !important; }
        .plotly .tick text { fill: black !important; font-size: 8pt !important; font-weight: normal !important; }
        /* Removed: body.pdf-preview-active .plotly .legend { display: none !important; } to allow legend in PDF */
        .plotly .modebar { display: none !important; } /* Applies to both views */
        #bar-chart-I, #bar-chart-Y, #bar-chart-T { height: 100% !important; }
        #normative-chart-I, #normative-chart-Y, #normative-chart-T { height: 100% !important; }
        
    </style>
</head>
<body>
    <div id="appLoadingMessage" class="loading-message">Loading Application...</div>
    <div id="appStatusMessage" class="status-message"></div>

    <div id="confirmation-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="confirmation-modal-title">Confirm Action</h3>
            <p id="confirmation-modal-message" style="color: white; margin-bottom: 30px; text-align: center; font-size: 1.1rem;"></p>
            <div class="modal-actions">
                <button type="button" class="modal-cancel-button" id="confirmation-cancel-btn">Cancel</button>
                <button type="button" class="modal-confirm-button" id="confirmation-confirm-btn">Confirm</button>
            </div>
        </div>
    </div>

    <div id="patient-modal-overlay" class="modal-overlay">
        <div class="modal-content" id="patient-modal-content">
            </div>
    </div>

    <div class="app-layout">
        <aside class="app-sidebar">
            <div class="sidebar-logo-placeholder"><i class="fas fa-bars"></i></div>
            <div class="sidebar-buttons">
                <a href="assets/analysis.html" id="analysis-link-button"><button type="button" id="view-analysis-button"><i class="fas fa-history"></i> <span class="button-text">Patient History</span></button></a>
                <button id="pdf-preview-button"><i class="fas fa-file-pdf"></i><span class="button-text">PDF Preview</span></button>
                <button id="export-excel-button"><i class="fas fa-file-excel"></i><span class="button-text">Export Data</span></button>
                <button id="clear-all-button"><i class="fas fa-eraser"></i><span class="button-text">Clear All</span></button>
            </div>
            <div id="loggedInUserContainer" class="sidebar-user-info">
                <div class="user-details">
                    <span id="loggedInUserName">Loading...</span>
                    <span id="loggedInUserEmailDisplay"></span>
                </div>
                <button id="logout-button"><i class="fas fa-sign-out-alt"></i><span class="button-text">Logout</span></button>
            </div>
            <div class="sidebar-social-links">
                <a href="https://www.instagram.com/alphatekofficial" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="https://www.alphatek.no" target="_blank" title="Website"><i class="fas fa-globe"></i></a>
                <a href="#" title="Info/Help"><i class="fas fa-circle-info"></i></a>
            </div>
        </aside>
        <main class="app-main-content">
            <button id="preview-exit-button-inline"><i class="fas fa-times-circle"></i> Exit Preview</button>
            <div class="content-container">
                <div id="report-content">
                    <h1>Functional Shoulder Screening</h1>
                    <h2 class="section-title-main" id="patient-details-title">Patient Selection</h2>

                    <div id="patient-choice-container">
                        <div id="patient-choice-section">
                            <div class="choice-box" id="new-patient-choice">
                                <i class="fas fa-plus"></i>
                                <span>New Patient</span>
                            </div>
                            <div class="choice-box" id="existing-patient-choice">
                                <i class="fas fa-search"></i>
                                <span>Existing Patient</span>
                            </div>
                        </div>
                    </div>


                    <div id="existing-patient-search-container" style="display: none;">
                        <label for="fp-nr-input-search">Search Patient ID:</label>
                        <input id="fp-nr-input-search" type="text" autocomplete="off">
                        </div>

                    <div id="main-screening-content">
                        <div class="explanation-box"><h4>About This Report</h4> <p>This report summarizes the results of the Functional Shoulder Screening using the ASH test (Positions I, Y, T).</p><ul> <li><strong>Asymmetry Graphs:</strong> Show the percentage difference between the injured and uninjured side for key metrics (Max Force, RFD, % Max Force at 100ms). Values closer to 100% indicate better symmetry. Annotations above the bars show the percentage difference relative to the uninjured side (100%). Numbers inside the bars show the absolute values for each side.</li> <li><strong>Normative Graphs:</strong> Visually represent the estimated percentile rank for Max Force / Bodyweight (N/kg) for each side, based on normative thresholds. Background colors indicate performance zones (Poor, Average, Good, Excellent). Vertical dashed lines show the estimated percentile for the Left (Orange) and Right (Blue) values.</li> </ul><p><i>To save as PDF: Click 'PDF Preview', then use your browser's Print function (Ctrl+P or Cmd+P) and select 'Save as PDF'. Click 'Exit Preview' to return.</i></p></div>

                        <h2 class="section-title-main" id="patient-card-and-log-title" style="display: none;">Details</h2>
                        <div id="patient-overview-section">
                            <div class="overview-column patient-details-column">
                                <div id="patient-identity-card" class="patient-card" style="display: none;">
                                    <h3 class="patient-profile-title-internal">Patient Profile
                                        <div class="action-buttons">
                                            <button id="edit-patient-profile-btn" class="edit-profile-button">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button id="delete-patient-profile-btn" class="edit-profile-button delete-patient-btn">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </h3>
                                    <div class="patient-card-header">
                                        <i class="fas fa-address-card patient-card-icon"></i>
                                        <div class="patient-card-id-container">
                                            <span class="patient-card-id-label">Patient ID:</span>
                                            <span class="patient-card-id" id="display-patient-id-card"></span>
                                        </div>
                                    </div>
                                    <div class="patient-card-body">
                                        <div class="info-item"><i class="fas fa-birthday-cake info-icon"></i><span class="label">Age:</span><span class="value" id="display-age-card"></span></div>
                                        <div class="info-item"><i class="fas fa-venus-mars info-icon"></i><span class="label">Gender:</span><span class="value" id="display-gender-card"></span></div>
                                        <div class="info-item"><i class="fas fa-futbol info-icon"></i><span class="label">Sport:</span><span class="value" id="display-sport-card"></span></div>
                                        <div class="info-item"><i class="fas fa-notes-medical info-icon"></i><span class="label">Injury:</span><span class="value" id="display-injury-card"></span></div>
                                        <div class="info-item"><i class="fas fa-user-injured info-icon"></i><span class="label">Injured Side:</span><span class="value" id="display-injured-side-card"></span></div>
                                        <div class="info-item"><i class="fas fa-weight-hanging info-icon"></i><span class="label">Bodyweight:</span><span class="value" id="display-bodyweight-card"></span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="overview-column test-log-column">
                                <div id="selected-patient-tests-container" style="display: none;">
                                        <h3 class="test-log-title-internal">Test Log</h3>
                                    <ul id="selected-patient-tests-list">
                                        </ul>
                                </div>
                            </div>
                        </div>
                        <h2 class="section-title-main" id="input-title">Input Overview</h2>
                        <div id="input-section-container">
                            <div class="input-position-box"><h4>ASH Test Position I</h4><div class="input-row"> <label>Max Force</label> <div class="input-wrapper"> <input id="non-injured-max-force-i" type="number" class="number-input" placeholder="Uninjured"> <span class="unit-text">- N</span> </div> </div><div class="input-row"> <label>RFD 100ms</label> <div class="input-wrapper"> <input id="non-injured-rfd-i" type="number" class="number-input" placeholder="Uninjured"> <span class="unit-text">- Ns<sup>-1</sup></span> </div> </div><div class="input-row"> <label>Max Force</label> <div class="input-wrapper"> <input id="injured-max-force-i" type="number" class="number-input" placeholder="Injured"> <span class="unit-text">- N</span> </div> </div><div class="input-row"> <label>RFD 100ms</label> <div class="input-wrapper"> <input id="injured-rfd-i" type="number" class="number-input" placeholder="Injured"> <span class="unit-text">- Ns<sup>-1</sup></span> </div> </div></div>
                            <div class="input-position-box"><h4>ASH Test Position Y</h4><div class="input-row"> <label>Max Force</label> <div class="input-wrapper"><input id="non-injured-max-force-y" type="number" class="number-input" placeholder="Uninjured"> <span class="unit-text">- N</span></div> </div><div class="input-row"> <label>RFD 100ms</label> <div class="input-wrapper"><input id="non-injured-rfd-y" type="number" class="number-input" placeholder="Uninjured"> <span class="unit-text">- Ns<sup>-1</sup></span></div> </div><div class="input-row"> <label>Max Force</label> <div class="input-wrapper"><input id="injured-max-force-y" type="number" class="number-input" placeholder="Injured"> <span class="unit-text">- N</span></div> </div><div class="input-row"> <label>RFD 100ms</label> <div class="input-wrapper"><input id="injured-rfd-y" type="number" class="number-input" placeholder="Injured"> <span class="unit-text">- Ns<sup>-1</sup></span></div> </div></div>
                            <div class="input-position-box"><h4>ASH Test Position T</h4><div class="input-row"> <label>Max Force</label> <div class="input-wrapper"><input id="non-injured-max-force-t" type="number" class="number-input" placeholder="Uninjured"> <span class="unit-text">- N</span></div> </div><div class="input-row"> <label>RFD 100ms</label> <div class="input-wrapper"><input id="non-injured-rfd-t" type="number" class="number-input" placeholder="Uninjured"> <span class="unit-text">- Ns<sup>-1</sup></span></div> </div><div class="input-row"> <label>Max Force</label> <div class="input-wrapper"><input id="injured-max-force-t" type="number" class="number-input" placeholder="Injured"> <span class="unit-text">- N</span></div> </div><div class="input-row"> <label>RFD 100ms</label> <div class="input-wrapper"><input id="injured-rfd-t" type="number" class="number-input" placeholder="Injured"> <span class="unit-text">- Ns<sup>-1</sup></span></div> </div></div>
                        </div>
                        <div id="save-data-button-container">
                            <button id="save-data-button-main"><i class="fas fa-save"></i> Save Screening Data</button>
                        </div>

                        <h2 class="section-title-main" id="results-title">Results</h2>
                        <div class="position-row"> <div class="asymmetry-graph-container"> <div id="position-box-I" class="position-box"> <h3 class="position-title">Position I - Asymmetry</h3> <div id="bar-chart-I" class="js-plotly-plot"></div> </div> </div> <div class="normative-graph-container"> <div id="normative-chart-container-I" class="normative-box"> <h3 class="normative-title">Position I - Normative Comparison</h3> <div id="normative-chart-I" class="js-plotly-plot"></div> </div> </div> </div>
                        <div class="position-row"> <div class="asymmetry-graph-container"> <div id="position-box-Y" class="position-box"> <h3 class="position-title">Position Y - Asymmetry</h3> <div id="bar-chart-Y" class="js-plotly-plot"></div> </div> </div> <div class="normative-graph-container"> <div id="normative-chart-container-Y" class="normative-box"> <h3 class="normative-title">Position Y - Normative Comparison</h3> <div id="normative-chart-Y" class="js-plotly-plot"></div> </div> </div> </div>
                        <div class="position-row"> <div class="asymmetry-graph-container"> <div id="position-box-T" class="position-box"> <h3 class="position-title">Position T - Asymmetry</h3> <div id="bar-chart-T" class="js-plotly-plot"></div> </div> </div> <div class="normative-graph-container"> <div id="normative-chart-container-T" class="normative-box"> <h3 class="normative-title">Position T - Normative Comparison</h3> <div id="normative-chart-T" class="js-plotly-plot"></div> </div> </div> </div>
                        <div id="normative-placeholder" style="display: none;"> Enter bodyweight to see normative comparisons. </div>
                        <div id="bottom-area"></div>
                            <div id="patient-data-container" style="display:none;">
                                <div id="patient-id-and-secondary-controls">
                                    <div class="patient-id-standalone-item">
                                        <label for="fp-nr-input">Patient ID (Internal):</label>
                                        <input id="fp-nr-input" type="text">
                                    </div>
                                    <div id="patient-data-secondary-controls">
                                        <div class="control-item"><label class="control-label" for="injured-side-radio">Injured Side:</label><select id="injured-side-radio"><option value="Left">Left</option><option value="Right">Right</option></select></div>
                                        <div class="control-item"><label class="control-label" for="bodyweight-input">Bodyweight (kg):</label><input id="bodyweight-input" type="number"></div>
                                    </div>
                                </div>
                                <div id="patient-data-grid">
                                    <div class="patient-data-item"><label for="age-input">Age:</label><input id="age-input" type="number"></div>
                                    <div class="patient-data-item"><label for="gender-select">Gender:</label><select id="gender-select"><option value="">Select...</option><option value="Male">Male</option><option value="Female">Female</option><option value="Other">Other</option><option value="Prefer not to say">Prefer not to say</option></select></div>
                                    <div class="patient-data-item"><label for="sport-input">Sport:</label><input id="sport-input" type="text"></div>
                                    <div class="patient-data-item"><label for="injury-input">Injury (Optional):</label><input id="injury-input" type="text"></div>
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, deleteDoc, updateDoc, orderBy, serverTimestamp, Timestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDhEihuoWm4c5MSOHrSqkkzca7tn86roq4", 
            authDomain: "pwr-analytics.firebaseapp.com",
            projectId: "pwr-analytics",
            storageBucket: "pwr-analytics.appspot.com",
            messagingSenderId: "9839468523",
            appId: "1:9839468523:web:1d994de254b2a24d91c3ae",
            measurementId: "G-N35HQ5CMD5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let currentUserId = null;

        // Global state for current patient and their data
        let currentPatientDataForApp = {
            patientId: null,
            age: '',
            gender: '',
            sport: '',
            injury: '',
            injuredSide: 'Left', 
            bodyweight: '',
            screeningId: null 
        };

        // DOM Element References
        const appLayout = document.querySelector('.app-layout');
        const appLoadingMessage = document.getElementById('appLoadingMessage');
        const appStatusMessage = document.getElementById('appStatusMessage');
        const loggedInUserNameSpan = document.getElementById('loggedInUserName');
        const loggedInUserEmailDisplaySpan = document.getElementById('loggedInUserEmailDisplay');

        const patientChoiceSection = document.getElementById('patient-choice-section');
        const newPatientChoiceButton = document.getElementById('new-patient-choice');
        const existingPatientChoiceButton = document.getElementById('existing-patient-choice');
        const existingPatientSearchContainer = document.getElementById('existing-patient-search-container');
        const fpNrInputSearch = document.getElementById('fp-nr-input-search');
        const mainScreeningContent = document.getElementById('main-screening-content');
        const patientDetailsTitle = document.getElementById('patient-details-title');
        const patientCardAndLogTitle = document.getElementById('patient-card-and-log-title');

        const patientModalOverlay = document.getElementById('patient-modal-overlay');
        const patientModalContent = document.getElementById('patient-modal-content');

        const patientOverviewSection = document.getElementById('patient-overview-section');
        const patientIdentityCard = document.getElementById('patient-identity-card');
        const displayPatientIdCard = document.getElementById('display-patient-id-card');
        const displayAgeCard = document.getElementById('display-age-card');
        const displayGenderCard = document.getElementById('display-gender-card');
        const displaySportCard = document.getElementById('display-sport-card');
        const displayInjuryCard = document.getElementById('display-injury-card');
        const displayInjuredSideCard = document.getElementById('display-injured-side-card');
        const displayBodyweightCard = document.getElementById('display-bodyweight-card');
        const selectedPatientTestsContainer = document.getElementById('selected-patient-tests-container');
        const selectedPatientTestsListUL = document.getElementById('selected-patient-tests-list');
        const editPatientProfileButton = document.getElementById('edit-patient-profile-btn');
        const deletePatientProfileButton = document.getElementById('delete-patient-profile-btn'); 

        // Confirmation Modal Elements
        const confirmationModalOverlay = document.getElementById('confirmation-modal-overlay');
        const confirmationModalTitle = document.getElementById('confirmation-modal-title');
        const confirmationModalMessage = document.getElementById('confirmation-modal-message');
        const confirmationCancelBtn = document.getElementById('confirmation-cancel-btn');
        const confirmationConfirmBtn = document.getElementById('confirmation-confirm-btn');


        const plotlyConfig = { responsive: true, displaylogo: false, modeBarButtonsToRemove: ['sendDataToCloud', 'lasso2d', 'select2d', 'autoScale2d', 'hoverClosestCartesian', 'hoverCompareCartesian', 'toggleSpikelines'] };
        
        const normativeThresholds = {
            I: { poor_max: 1.47, average_mid: 1.65, good_min: 1.85, excellent_min: 2.1 },
            Y: { poor_max: 1.25, average_mid: 1.4, good_min: 1.6, excellent_min: 1.76 },
            T: { poor_max: 1.15, average_mid: 1.25, good_min: 1.4, excellent_min: 1.58 }
        };

        const percentileZones = {
            poor: 30,      
            average: 70,   
            good: 90,      
            excellent: 100 
        };
        const percentileMidpoint = 50; 

        const normZoneColors = {
            poor: getComputedStyle(document.documentElement).getPropertyValue('--norm-poor-bg').trim(),
            average: getComputedStyle(document.documentElement).getPropertyValue('--norm-average-bg').trim(),
            good: getComputedStyle(document.documentElement).getPropertyValue('--norm-good-bg').trim(),
            excellent: getComputedStyle(document.documentElement).getPropertyValue('--norm-excellent-bg').trim()
        };
        const normativeLabels = { poor: 'Poor', average: 'Average', good: 'Good', excellent: 'Excellent' };
        
        const asymmetryChartDivs = ['bar-chart-I', 'bar-chart-Y', 'bar-chart-T'];
        const asymmetryPositionBoxDivs = ['position-box-I', 'position-box-Y', 'position-box-T'];
        const normativeChartDivs = ['normative-chart-I', 'normative-chart-Y', 'normative-chart-T'];
        const normativePlaceholder = document.getElementById('normative-placeholder');

        const injuredSideRadio = document.getElementById('injured-side-radio');
        const bodyweightInput = document.getElementById('bodyweight-input');
        const fpNrInput = document.getElementById('fp-nr-input');
        const ageInput = document.getElementById('age-input');
        const genderSelect = document.getElementById('gender-select');
        const sportInput = document.getElementById('sport-input');
        const injuryInput = document.getElementById('injury-input');

        const saveDataButton = document.getElementById('save-data-button-main');
        const pdfPreviewButton = document.getElementById('pdf-preview-button');
        const exportExcelButton = document.getElementById('export-excel-button');
        const clearAllButton = document.getElementById('clear-all-button');
        const logoutButton = document.getElementById('logout-button');
        const previewExitButtonInline = document.getElementById('preview-exit-button-inline');
        const explanationBox = document.querySelector('.explanation-box');

        const inputSectionContainer = document.getElementById('input-section-container');
        const resultsTitle = document.getElementById('results-title');
        const positionRows = document.querySelectorAll('.position-row');
        const saveDataButtonContainer = document.getElementById('save-data-button-container');

        const inputFieldMap = {
            'I': { nonInjured: [document.getElementById('non-injured-max-force-i'), document.getElementById('non-injured-rfd-i')], injured: [document.getElementById('injured-max-force-i'), document.getElementById('injured-rfd-i')] },
            'Y': { nonInjured: [document.getElementById('non-injured-max-force-y'), document.getElementById('non-injured-rfd-y')], injured: [document.getElementById('injured-max-force-y'), document.getElementById('injured-rfd-y')] },
            'T': { nonInjured: [document.getElementById('non-injured-max-force-t'), document.getElementById('non-injured-rfd-t')], injured: [document.getElementById('injured-max-force-t'), document.getElementById('injured-rfd-t')] }
        };
        const allNumberInputs = Array.from(document.querySelectorAll('#input-section-container input[type="number"]'));
        
        let allPatientIds = [];

        onAuthStateChanged(auth, async (user) => {
            if (appLoadingMessage) appLoadingMessage.style.display = 'flex';
            if (appLayout) appLayout.style.display = 'none';

            if (user) {
                currentUser = user;
                currentUserId = user.uid;
                if (appLoadingMessage) appLoadingMessage.textContent = `Welcome, loading data...`;

                try {
                    const userDocRef = doc(db, "users", currentUserId);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        loggedInUserNameSpan.textContent = `Hi ${userData.firstName || 'User'}!`;
                        loggedInUserEmailDisplaySpan.textContent = currentUser.email || '';
                    } else {
                        loggedInUserNameSpan.textContent = 'Hi User!';
                        loggedInUserEmailDisplaySpan.textContent = currentUser.email || '';
                    }
                } catch (error) {
                    console.error("Error fetching user data:", error);
                    loggedInUserNameSpan.textContent = 'Hi User!';
                    loggedInUserEmailDisplaySpan.textContent = currentUser.email || '';
                }

                await initializeAppUI();
                if (appLoadingMessage) appLoadingMessage.style.display = 'none';
                if (appLayout) appLayout.style.display = 'flex';

            } else {
                currentUser = null;
                currentUserId = null;
                if (appLoadingMessage) appLoadingMessage.textContent = 'Redirecting to login...';
                localStorage.setItem('redirectToAfterLogin', window.location.pathname + window.location.search);
                window.location.href = window.location.origin + "/index.html"; 
            }
        });

        async function initializeAppUI() {
            createEmptyPlot('bar-chart-I', 'Enter Data', 300, 20);
            createEmptyPlot('bar-chart-Y', 'Enter Data', 300, 20);
            createEmptyPlot('bar-chart-T', 'Enter Data', 300, 20);
            createEmptyPlot('normative-chart-I', 'Enter Bodyweight', 250, 35);
            createEmptyPlot('normative-chart-Y', 'Enter Bodyweight', 250, 35);
            createEmptyPlot('normative-chart-T', 'Enter Bodyweight', 250, 35);
            loadInputsFromLocalStorage();
            
            if (currentPatientDataForApp.patientId) {
                displayPatientInfoInCard(currentPatientDataForApp);
                await displayTestsForPatientFromFirestore(currentPatientDataForApp.patientId);
                if (patientCardAndLogTitle) patientCardAndLogTitle.style.display = 'block';
                if (patientChoiceSection) patientChoiceSection.style.display = 'flex';
                if (existingPatientSearchContainer) existingPatientSearchContainer.style.display = 'none';
                if (patientOverviewSection) patientOverviewSection.style.display = 'flex';
            } else {
                showInitialScreenState();
            }
            updateGraphsAndTable();
        }

        function showStatusMessage(message, type = 'info', duration = 3000) {
            if (!appStatusMessage) return;
            appStatusMessage.textContent = message;
            appStatusMessage.className = `status-message ${type}`;
            appStatusMessage.style.display = 'block';
            setTimeout(() => {
                appStatusMessage.style.display = 'none';
            }, duration);
        }
        function hexToRgba(hex, alpha) { hex = hex.replace('#', ''); const r = parseInt(hex.substring(0, 2), 16); const g = parseInt(hex.substring(2, 4), 16); const b = parseInt(hex.substring(4, 6), 16); return `rgba(${r}, ${g}, ${b}, ${alpha})`; }
        
        function createEmptyPlot(targetDivId, title = 'Enter Data', height, topMargin = 20) {
            const targetDiv = document.getElementById(targetDivId);
            if (!targetDiv) { console.error(`Target div '${targetDivId}' not found for empty plot.`); return; }
            try {
                Plotly.react(targetDiv, [{ x: [], y: [], type: 'bar' }], {
                    title: { text: title, font: { family: 'Avenir, sans-serif', size: 16, color: getComputedStyle(document.documentElement).getPropertyValue('--app-primary-color').trim(), weight: 400 } },
                    height: height, 
                    margin: { l: 60, r: 40, b: 40, t: topMargin, pad: 4 },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    xaxis: { visible: false },
                    yaxis: { showgrid: false, zeroline: true, gridcolor: getComputedStyle(document.documentElement).getPropertyValue('--medium-gray').trim(), showticklabels: false },
                    font: { family: 'Avenir, sans-serif', size: 12, weight: 400 }
                }, plotlyConfig);
            } catch (error) { console.error(`Error creating empty plot for '${targetDivId}':`, error); targetDiv.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">Error displaying chart.</p>`; }
        }
        function processInputAndCalculate(position) { const inputs = inputFieldMap[position]; if (!inputs) return null; const nonInjuredMaxForceVal = inputs.nonInjured[0].value; const nonInjuredRfdVal = inputs.nonInjured[1].value; const injuredMaxForceVal = inputs.injured[0].value; const injuredRfdVal = inputs.injured[1].value; if (nonInjuredMaxForceVal === '' && nonInjuredRfdVal === '' && injuredMaxForceVal === '' && injuredRfdVal === '') return null; const nonInjuredMaxForce = parseFloat(nonInjuredMaxForceVal) || 0; const nonInjuredRfd = parseFloat(nonInjuredRfdVal) || 0; const injuredMaxForce = parseFloat(injuredMaxForceVal) || 0; const injuredRfd = parseFloat(injuredRfdVal) || 0; const selectedInjuredSide = currentPatientDataForApp.injuredSide || 'Left'; let leftData = {}; let rightData = {}; if (selectedInjuredSide === 'Left') { leftData = { max_force: injuredMaxForce, rfd: injuredRfd }; rightData = { max_force: nonInjuredMaxForce, rfd: nonInjuredRfd }; } else { leftData = { max_force: nonInjuredMaxForce, rfd: nonInjuredRfd }; rightData = { max_force: injuredMaxForce, rfd: injuredRfd }; } return { left: leftData, right: rightData }; }
        
        function createAsymmetryChart(positionData, injuredSide, posLabel) {
            if (!positionData?.left || !positionData?.right) return [{}, false];
            const leftDataRaw = positionData.left;
            const rightDataRaw = positionData.right;
            const leftPctMaxAt100ms = leftDataRaw.max_force !== 0 ? (leftDataRaw.rfd * 0.1 / leftDataRaw.max_force) * 100 : 0;
            const rightPctMaxAt100ms = rightDataRaw.max_force !== 0 ? (rightDataRaw.rfd * 0.1 / rightDataRaw.max_force) * 100 : 0;
            const leftData = [leftDataRaw.max_force, leftDataRaw.rfd, leftPctMaxAt100ms];
            const rightData = [rightDataRaw.max_force, rightDataRaw.rfd, rightPctMaxAt100ms];
            const baseData = injuredSide === 'Right' ? leftData : rightData;
            const metricNames = [ 'Max Force (N)', 'RFD 100ms (Ns⁻¹)', '% Max @ 100ms (%)' ];
            const barDataRatios = {};
            const leftTextsAbsolute = [];
            const rightTextsAbsolute = [];
            metricNames.forEach((metricName, index) => {
                let leftValue = leftData[index];
                let rightValue = rightData[index];
                let baseValue = baseData[index];
                const leftRatio = baseValue !== 0 ? (leftValue / baseValue) * 100 : (leftValue === 0 ? 100 : Infinity);
                const rightRatio = baseValue !== 0 ? (rightValue / baseValue) * 100 : (rightValue === 0 ? 100 : Infinity);
                barDataRatios[metricName] = [rightRatio, leftRatio];
                const decimals = metricName.includes('% Max @ 100ms') ? 1 : 0;
                leftTextsAbsolute.push(leftValue.toFixed(decimals));
                rightTextsAbsolute.push(rightValue.toFixed(decimals));
            });
            const plotX = metricNames;
            const plotYLeft = plotX.map(name => barDataRatios[name][1]);
            const plotYRight = plotX.map(name => barDataRatios[name][0]);
            if (plotX.length !== 3 || plotYLeft.length !== 3 || plotYRight.length !== 3) return [{}, false];
            const leftColorHex = getComputedStyle(document.documentElement).getPropertyValue('--left-line-color').trim();
            const rightColorHex = getComputedStyle(document.documentElement).getPropertyValue('--right-line-color').trim();
            const leftColorRgba = hexToRgba(leftColorHex, 0.8);
            const rightColorRgba = hexToRgba(rightColorHex, 0.8);
            const thresholdLineColor = getComputedStyle(document.documentElement).getPropertyValue('--dark-gray').trim();
            const darkGrayColor = getComputedStyle(document.documentElement).getPropertyValue('--dark-gray').trim();
            const whiteColor = getComputedStyle(document.documentElement).getPropertyValue('--white').trim();
            const validRatios = plotYLeft.concat(plotYRight).filter(isFinite);
            const maxYValue = validRatios.length > 0 ? Math.max(110, ...validRatios) : 110;
            const annotationYTop = maxYValue + 8;
            const yAxisUpperBound = annotationYTop + 15;

            const isPdfPreview = document.body.classList.contains('pdf-preview-active');
            const plotHeight = isPdfPreview ? 340 : 300;

            const fig = {
                data: [
                    { type: 'bar', name: 'Left', x: plotX, y: plotYLeft, marker: { color: leftColorRgba }, text: leftTextsAbsolute, texttemplate: '%{text}', textposition: 'none', hoverinfo: 'x+name', hovertemplate: 'Left: %{y:.0f}%<extra></extra>' },
                    { type: 'bar', name: 'Right', x: plotX, y: plotYRight, marker: { color: rightColorRgba }, text: rightTextsAbsolute, texttemplate: '%{text}', textposition: 'none', hoverinfo: 'x+name', hovertemplate: 'Right: %{y:.0f}%<extra></extra>' },
                    { x: [null], y: [null], mode: 'lines', name: '90% Threshold', line: { color: thresholdLineColor, width: 1, dash: 'dash' }, hoverinfo: 'none', showlegend: true } 
                ],
                layout: {
                    height: plotHeight,
                    barmode: 'group',
                    font: { color: darkGrayColor, family: 'Avenir, sans-serif', size: 12, weight: 400 },
                    yaxis: { title: "Injured Side Asymmetry (%)", titlefont: { size: 13, family: 'Avenir, sans-serif', weight: 400, color: darkGrayColor }, tickfont: { size: 11, family: 'Avenir, sans-serif', weight: 400, color: darkGrayColor }, range: [18, yAxisUpperBound], tickmode: 'array', tickvals: [50, 90, 100], showgrid: false, zeroline: false, }, 
                    xaxis: { showgrid: false, zeroline: false, showline: false, showticklabels: true, tickangle: 0, tickfont: { size: 11, family: 'Avenir, sans-serif', weight: 400, color: darkGrayColor }, automargin: true, fixedrange: true },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    legend: { orientation: "h", yanchor: "bottom", y: -0.30, xanchor: "center", x: 0.5, font: { size: 12, family: 'Avenir, sans-serif', weight: 400, color: darkGrayColor } },
                    margin: { l: 70, r: 30, b: 85, t: 20, pad: 10 },
                    shapes: [ 
                        { type: "line", xref: "paper", x0: 0, x1: 1, yref: "y", y0: 90, y1: 90, line: { color: thresholdLineColor, width: 1, dash: "dash" }, layer: "below" }, 
                    ],
                    annotations: []
                }
            };
            let allGreen = true;
            const metricsNamesForAnnotation = plotX;
            for (let i = 0; i < metricsNamesForAnnotation.length; i++) {
                const metricName = metricsNamesForAnnotation[i];
                const injuredRatio = injuredSide === 'Right' ? plotYRight[i] : plotYLeft[i];
                const leftRatio = plotYLeft[i];
                const rightRatio = plotYRight[i];
                if (!isFinite(injuredRatio)) {
                    fig.layout.annotations.push({ x: metricName, y: annotationYTop, text: "N/A", showarrow: false, font: { color: 'grey', size: 22, family: 'Avenir, sans-serif', weight: 400 }, xanchor: 'center', yanchor: 'bottom' });
                    allGreen = false;
                } else {
                    const percentageDiff = injuredRatio - 100;
                    let color;
                    if (percentageDiff >= -10) {
                        color = 'rgb(42, 157, 143)'; 
                    } else if (percentageDiff >= -15) {
                        color = 'rgb(238, 155, 0)'; 
                    } else if (percentageDiff >= -20) {
                        color = 'rgb(232, 93, 4)';  
                    } else {
                        color = 'rgb(174, 32, 18)'; 
                    }
                    
                    if (percentageDiff < -10) { 
                        allGreen = false;
                    }

                    fig.layout.annotations.push({ x: metricName, y: annotationYTop, text: `${percentageDiff.toFixed(0)}%`, showarrow: false, font: { color: color, size: 22, family: 'Avenir, sans-serif', weight: 400 }, xanchor: 'center', yanchor: 'bottom' });
                }
                const barTextYPosition = 31;
                const barTextFontSize = 17;
                const categoryIndex = i;
                const numberOfBars = 2;
                const groupWidth = 0.8;
                const barWidthFraction = groupWidth / numberOfBars;
                const leftBarCenter = categoryIndex - (groupWidth / 2) + (barWidthFraction / 2);
                const rightBarCenter = categoryIndex + (groupWidth / 2) - (barWidthFraction / 2);
                if (leftRatio > barTextYPosition + (barTextFontSize / 2)) {
                    fig.layout.annotations.push({ x: leftBarCenter, y: barTextYPosition, xref: 'x', yref: 'y', text: leftTextsAbsolute[i], showarrow: false, font: { color: whiteColor, size: barTextFontSize, family: 'Avenir, sans-serif', weight: 400 }, xanchor: 'center', yanchor: 'middle' });
                }
                if (rightRatio > barTextYPosition + (barTextFontSize / 2)) {
                    fig.layout.annotations.push({ x: rightBarCenter, y: barTextYPosition, xref: 'x', yref: 'y', text: rightTextsAbsolute[i], showarrow: false, font: { color: whiteColor, size: barTextFontSize, family: 'Avenir, sans-serif', weight: 400 }, xanchor: 'center', yanchor: 'middle' });
                }
            }
            return [fig, allGreen];
        }

        function mapNkgToPercentile(nkgValue, positionLabel) {
            const thresholds = normativeThresholds[positionLabel];
            if (!thresholds || typeof nkgValue !== 'number' || !isFinite(nkgValue)) return 0;

            const pMap = [
                { v: 0, p: 0 }, 
                { v: thresholds.poor_max, p: percentileZones.poor },         
                { v: thresholds.average_mid, p: percentileMidpoint },       
                { v: thresholds.good_min, p: percentileZones.average },     
                { v: thresholds.excellent_min, p: percentileZones.good },   
                { v: thresholds.excellent_min * 1.25, p: percentileZones.excellent } 
            ];
            pMap.sort((a, b) => a.v - b.v);


            const minVal = pMap[0].v;
            const maxVal = pMap[pMap.length - 1].v;
            const clampedValue = Math.max(minVal, Math.min(nkgValue, maxVal));

            let lowerPoint = pMap[0];
            let upperPoint = pMap[pMap.length - 1];

            for (let i = 0; i < pMap.length - 1; i++) {
                if (clampedValue >= pMap[i].v && clampedValue <= pMap[i + 1].v) {
                    lowerPoint = pMap[i];
                    upperPoint = pMap[i + 1];
                    break;
                }
            }
             if (clampedValue === upperPoint.v) { 
                return upperPoint.p;
            }
            if (clampedValue === lowerPoint.v) { 
                return lowerPoint.p;
            }


            let percentile = lowerPoint.p;
            const valueRange = upperPoint.v - lowerPoint.v;
            const percentileRange = upperPoint.p - lowerPoint.p;

            if (valueRange > 0) {
                percentile += ((clampedValue - lowerPoint.v) / valueRange) * percentileRange;
            }
            return Math.max(0, Math.min(percentile, 100));
        }
        
        function createNormativeComparisonChart(positionData, bodyweight, positionLabel) {
            const bwVal = parseFloat(bodyweight);
            if (isNaN(bwVal) || bwVal <= 0 || !positionData) return {};
            const leftNkg = positionData.left.max_force / bwVal;
            const rightNkg = positionData.right.max_force / bwVal;
            const thresholds = normativeThresholds[positionLabel];
            if (!thresholds) return {};
            
            const leftPercentile = mapNkgToPercentile(leftNkg, positionLabel);
            const rightPercentile = mapNkgToPercentile(rightNkg, positionLabel);
            
            const baseCurveX = [];
            const baseCurveY = [];
            const mean = 55; 
            const stdDev = 22; 
            const amplitude = 0.9; 
            for (let i = 0; i <= 100; i += 0.5) { 
                baseCurveX.push(i);
                const y = amplitude * Math.exp(-Math.pow(i - mean, 2) / (2 * Math.pow(stdDev, 2)));
                baseCurveY.push(y);
            }

            const zoneBoundaries = [0, percentileZones.poor, percentileZones.average, percentileZones.good, percentileZones.excellent];
            const traces = [];
            const zoneColorsList = [normZoneColors.poor, normZoneColors.average, normZoneColors.good, normZoneColors.excellent];
            
            for (let i = 0; i < zoneBoundaries.length - 1; i++) {
                const x0 = zoneBoundaries[i];
                const x1 = zoneBoundaries[i+1];
                const zoneFillColor = zoneColorsList[i];
                const segmentX = [x0];
                const segmentY = [0];
                for(let j=0; j < baseCurveX.length; j++) {
                    if (baseCurveX[j] >= x0 && baseCurveX[j] <= x1) {
                        segmentX.push(baseCurveX[j]);
                        segmentY.push(baseCurveY[j]);
                    }
                }
                segmentX.push(x1);
                segmentY.push(0);
                traces.push({ x: segmentX, y: segmentY, type: 'scatter', mode: 'lines', line: { width: 0 }, fill: 'tozeroy', fillcolor: zoneFillColor, hoverinfo: 'none', name: Object.keys(normativeLabels)[i], showlegend: false });
            }
            traces.push({ x: baseCurveX, y: baseCurveY, type: 'scatter', mode: 'lines', line: { color: '#ffffff', width: 1.5, shape: 'spline' }, hoverinfo: 'none', name: 'Distribution (Visual)', showlegend: false });
            
            const isPdfPreview = document.body.classList.contains('pdf-preview-active');
            const plotHeight = isPdfPreview ? 340 : 250;

            const layout = {
                height: plotHeight,
                margin: { t: 35, b: 95, l: 30, r: 30 }, 
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                xaxis: { title: '', range: [0, 100], showgrid: false, zeroline: false, showticklabels: false },
                yaxis: { range: [0, 1.1], showgrid: false, zeroline: false, showticklabels: false, title: '' },
                shapes: [],
                annotations: [],
                font: { family: 'Avenir, sans-serif', size: 11, weight: 400, color: getComputedStyle(document.documentElement).getPropertyValue('--dark-gray').trim() },
                showlegend: false
            };

            const nkgAnnotationY = -0.08; 
            const nkgAnnotationFont = { family: 'Avenir, sans-serif', size: 10, weight: 400, color: getComputedStyle(document.documentElement).getPropertyValue('--app-primary-color').trim() };

            layout.annotations.push({ xref: 'x', yref: 'paper', x: percentileZones.poor, y: nkgAnnotationY, text: `<span class="norm-value">${thresholds.poor_max.toFixed(2)}</span>`, showarrow: false, xanchor: 'center', yanchor: 'top', font: nkgAnnotationFont }); 
            layout.annotations.push({ xref: 'x', yref: 'paper', x: percentileZones.average, y: nkgAnnotationY, text: `<span class="norm-value">${thresholds.good_min.toFixed(2)}</span>`, showarrow: false, xanchor: 'center', yanchor: 'top', font: nkgAnnotationFont }); 
            layout.annotations.push({ xref: 'x', yref: 'paper', x: percentileZones.good, y: nkgAnnotationY, text: `<span class="norm-value">${thresholds.excellent_min.toFixed(2)}</span>`, showarrow: false, xanchor: 'center', yanchor: 'top', font: nkgAnnotationFont }); 
            
            layout.shapes.push({ type: 'line', xref: 'x', yref: 'paper', x0: percentileMidpoint, x1: percentileMidpoint, y0: 0, y1: 1, line: { color: getComputedStyle(document.documentElement).getPropertyValue('--medium-gray').trim(), width: 1.5, dash: 'dot' }, layer: 'below' });
            layout.annotations.push({ xref: 'x', yref: 'paper', x: percentileMidpoint, y: nkgAnnotationY, text: `<span class="value-display">${thresholds.average_mid.toFixed(2)}</span>`, showarrow: false, xanchor: 'center', yanchor: 'top', align: 'center', font: { family: 'Avenir, sans-serif', size: 10, color: getComputedStyle(document.documentElement).getPropertyValue('--dark-gray').trim(), weight: 400 } });
            
            const labelYPosition = 1.08; 
            const labelFont = { family: 'Avenir, sans-serif', size: 11, weight: 400, color: getComputedStyle(document.documentElement).getPropertyValue('--dark-gray').trim() };
            layout.annotations.push({ xref: 'x', yref: 'paper', x: zoneBoundaries[0] + (zoneBoundaries[1] - zoneBoundaries[0])/2, y: labelYPosition, text: `<span class="norm-label">${normativeLabels.poor}</span>`, showarrow: false, xanchor: 'center', yanchor: 'bottom', font: labelFont });
            layout.annotations.push({ xref: 'x', yref: 'paper', x: zoneBoundaries[1] + (zoneBoundaries[2] - zoneBoundaries[1])/2, y: labelYPosition, text: `<span class="norm-label">${normativeLabels.average}</span>`, showarrow: false, xanchor: 'center', yanchor: 'bottom', font: labelFont });
            layout.annotations.push({ xref: 'x', yref: 'paper', x: zoneBoundaries[2] + (zoneBoundaries[3] - zoneBoundaries[2])/2, y: labelYPosition, text: `<span class="norm-label">${normativeLabels.good}</span>`, showarrow: false, xanchor: 'center', yanchor: 'bottom', font: labelFont });
            layout.annotations.push({ xref: 'x', yref: 'paper', x: zoneBoundaries[3] + (zoneBoundaries[4] - zoneBoundaries[3])/2, y: labelYPosition, text: `<span class="norm-label">${normativeLabels.excellent}</span>`, showarrow: false, xanchor: 'center', yanchor: 'bottom', font: labelFont });

            const leftColor = getComputedStyle(document.documentElement).getPropertyValue('--left-line-color').trim();
            const rightColor = getComputedStyle(document.documentElement).getPropertyValue('--right-line-color').trim();
            const lineY0 = 0.05;
            const lineY1 = 0.95;
            layout.shapes.push({ type: 'line', xref: 'x', yref: 'paper', x0: leftPercentile, x1: leftPercentile, y0: lineY0, y1: lineY1, line: { color: leftColor, width: 2, dash: 'dash' } });
            layout.annotations.push({ xref: 'x', yref: 'paper', x: leftPercentile, y: 0.90, text: 'L', showarrow: true, ax: 0, ay: -15, arrowhead: 0, arrowwidth: 1, arrowcolor: leftColor, font: {color: leftColor, size: 14, family: 'Avenir, sans-serif', weight: 400} });
            layout.shapes.push({ type: 'line', xref: 'x', yref: 'paper', x0: rightPercentile, x1: rightPercentile, y0: lineY0, y1: lineY1, line: { color: rightColor, width: 2, dash: 'dash' } });
            layout.annotations.push({ xref: 'x', yref: 'paper', x: rightPercentile, y: 0.90, text: 'R', showarrow: true, ax: 0, ay: -15, arrowhead: 0, arrowwidth: 1, arrowcolor: rightColor, font: {color: rightColor, size: 14, family: 'Avenir, sans-serif', weight: 400} });
            
            const combinedNkgText = `<span class='nkg-combined-text'>Left: <span class='left-label'>${leftNkg.toFixed(2)}</span> (Nkg<sup>-1</sup>) &nbsp;&nbsp;|&nbsp;&nbsp; Right: <span class='right-label'>${rightNkg.toFixed(2)}</span> (Nkg<sup>-1</sup>)</span>`;
            layout.annotations.push({ xref: 'paper', yref: 'paper', x: 0.5, y: -0.35, text: combinedNkgText, showarrow: false, xanchor: 'center', yanchor: 'top', align: 'center', font: { size: 15, color: getComputedStyle(document.documentElement).getPropertyValue('--dark-gray').trim(), family: 'Avenir, sans-serif', weight: 400 } });
            
            return { data: traces, layout };
        }
        function updateGraphsAndTable() {
            const injuredSide = currentPatientDataForApp.injuredSide || (injuredSideRadio ? injuredSideRadio.value : 'Left');
            const bodyweightValue = currentPatientDataForApp.bodyweight || (bodyweightInput ? bodyweightInput.value : '');
            const bwVal = parseFloat(bodyweightValue);
            const bodyweightValid = !isNaN(bwVal) && bwVal > 0;
            if (normativePlaceholder) { normativePlaceholder.style.display = bodyweightValid ? 'none' : 'block'; }
            normativeChartDivs.forEach(divId => {
                const container = document.getElementById(divId)?.closest('.normative-graph-container');
                if (container) { container.style.display = bodyweightValid ? 'block' : 'none'; }
            });
            const positions = ['I', 'Y', 'T'];
            positions.forEach((pos, i) => {
                const asymmetryChartDivId = asymmetryChartDivs[i];
                const asymmetryPositionBoxDivId = asymmetryPositionBoxDivs[i];
                const asymmetryPositionBoxDiv = document.getElementById(asymmetryPositionBoxDivId);
                const normativeChartDivId = normativeChartDivs[i];
                if (!asymmetryPositionBoxDiv || !document.getElementById(asymmetryChartDivId) || !document.getElementById(normativeChartDivId)) return;
                const positionData = processInputAndCalculate(pos);
                if (positionData) {
                    try {
                        const [fig, allGreen] = createAsymmetryChart(positionData, injuredSide, pos);
                        if (fig?.data && fig?.layout) {
                            Plotly.react(asymmetryChartDivId, fig.data, fig.layout, plotlyConfig);
                            if (allGreen) asymmetryPositionBoxDiv.classList.add('green-box');
                            else asymmetryPositionBoxDiv.classList.remove('green-box');
                        } else { throw new Error("Generated asymmetry figure invalid."); }
                    } catch (error) { console.error(`Error creating asymmetry chart for ${pos}:`, error); createEmptyPlot(asymmetryChartDivId, 'Error loading asymmetry data', 300, 20); asymmetryPositionBoxDiv.classList.remove('green-box'); }
                } else { createEmptyPlot(asymmetryChartDivId, 'Enter Data', 300, 20); asymmetryPositionBoxDiv.classList.remove('green-box'); }
                if (bodyweightValid && positionData) {
                    try {
                        const config = createNormativeComparisonChart(positionData, bodyweightValue, pos);
                        if (config?.data && config?.layout) Plotly.react(normativeChartDivId, config.data, config.layout, plotlyConfig);
                        else throw new Error("Generated normative figure invalid.");
                    } catch (error) { console.error(`Error creating normative chart for ${pos}:`, error); createEmptyPlot(normativeChartDivId, 'Error Loading Data', 250, 35); }
                } else if (!bodyweightValid) { createEmptyPlot(normativeChartDivId, 'Enter Bodyweight', 250, 35); }
                else { createEmptyPlot(normativeChartDivId, 'Enter Data', 250, 35); }
            });
            setTimeout(() => window.dispatchEvent(new Event('resize')), 100);
        }
        function enterPreviewMode() {
            document.body.classList.add('pdf-preview-active');
            if(previewExitButtonInline) previewExitButtonInline.style.display = 'inline-block';
            if(explanationBox) explanationBox.style.display = 'block';
            setTimeout(() => {
                asymmetryChartDivs.concat(normativeChartDivs).forEach(divId => {
                    const gd = document.getElementById(divId);
                    if (gd && gd.classList.contains('js-plotly-plot') && typeof gd.layout !== 'undefined') {
                        try {
                            Plotly.Plots.resize(gd);
                        } catch (e) { console.warn("Error resizing plot for PDF preview:", divId, e); }
                    }
                });
            }, 150);
        }

        function exitPreviewMode() {
            document.body.classList.remove('pdf-preview-active');
            if(previewExitButtonInline) previewExitButtonInline.style.display = 'none';
            if(explanationBox) explanationBox.style.display = 'none';
             setTimeout(() => {
                asymmetryChartDivs.concat(normativeChartDivs).forEach(divId => {
                    const gd = document.getElementById(divId);
                     if (gd && gd.classList.contains('js-plotly-plot') && typeof gd.layout !== 'undefined') { 
                         try {
                            Plotly.Plots.resize(gd);
                         } catch (e) { /* Ignore resize errors if plot not fully rendered */ }
                    }
                });
            }, 150);
        }
        function exportTableToCsv() { const fpNr = currentPatientDataForApp.patientId || ''; const age = currentPatientDataForApp.age || ''; const gender = currentPatientDataForApp.gender || ''; const sport = currentPatientDataForApp.sport || ''; const injuryValue = currentPatientDataForApp.injury || ''; const bodyweightValue = currentPatientDataForApp.bodyweight || ''; const injuredSide = currentPatientDataForApp.injuredSide || ''; const date = new Date(); const year = date.getFullYear(); const month = (date.getMonth() + 1).toString().padStart(2, '0'); const day = date.getDate().toString().padStart(2, '0'); const dateString = `${year}-${month}-${day}`; const safeFpNr = fpNr.replace(/[^a-z0-9]/gi, '_') || 'Unknown'; const filename = `ASH_${safeFpNr}_${dateString}.csv`; const headers = [ "Patient ID", "Age", "Gender", "Sport", "Injury", "Bodyweight (kg)", "Injured Side", "Position", "Metric", "Left Value", "Right Value" ]; let csv = [headers.join(',')]; const positions = ['I', 'Y', 'T']; const metricsForCsv = ['Max Force (N)', 'RFD 100ms (N/s)']; positions.forEach(pos => { const positionName = `ASH Test Position ${pos}`; const positionData = processInputAndCalculate(pos); metricsForCsv.forEach(metricDisplay => { let leftVal = ''; let rightVal = ''; let metricIdentifier = metricDisplay; if (metricDisplay === 'Max Force (N)') { if (positionData) { leftVal = positionData.left.max_force; rightVal = positionData.right.max_force; } } else if (metricDisplay === 'RFD 100ms (N/s)') { if (positionData) { leftVal = positionData.left.rfd; rightVal = positionData.right.rfd; } metricIdentifier = 'RFD 100ms (N/s)'; } const rowData = [ `"${fpNr}"`, `"${age}"`, `"${gender}"`, `"${sport}"`, `"${injuryValue}"`, `"${bodyweightValue}"`, `"${injuredSide}"`, `"${positionName}"`, `"${metricIdentifier}"`, `"${leftVal}"`, `"${rightVal}"` ]; csv.push(rowData.join(',')); }); }); const csvString = "\uFEFF" + csv.join('\n'); const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); if (link.download !== undefined) { const url = URL.createObjectURL(blob); link.setAttribute('href', url); link.setAttribute('download', filename); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); showStatusMessage("Data exported to CSV.", "success"); } else { alert("CSV export is not directly supported in this browser. Please try a modern browser."); } }

        function resetPatientDataForApp() {
            currentPatientDataForApp = { patientId: null, age: '', gender: '', sport: '', injury: '', injuredSide: 'Left', bodyweight: '', screeningId: null };
            if (fpNrInput) fpNrInput.value = '';
            if (ageInput) ageInput.value = '';
            if (genderSelect) genderSelect.value = '';
            if (sportInput) sportInput.value = '';
            if (injuryInput) injuryInput.value = '';
            if (injuredSideRadio) injuredSideRadio.value = 'Left';
            if (bodyweightInput) bodyweightInput.value = '';
        }

        function clearActiveTestItemState() {
            if (selectedPatientTestsListUL) {
                const allTestItems = selectedPatientTestsListUL.querySelectorAll('li');
                allTestItems.forEach(item => item.classList.remove('active-test-item'));
            }
        }

        function resetScreeningInputFields() {
            allNumberInputs.forEach(input => { input.value = ''; });
            if (currentPatientDataForApp) currentPatientDataForApp.screeningId = null;
            clearActiveTestItemState();
        }

        function clearAllFields() {
            resetPatientDataForApp();
            resetScreeningInputFields();
            if(patientOverviewSection) patientOverviewSection.style.display = 'none';
            if(patientIdentityCard) patientIdentityCard.style.display = 'none';
            if(selectedPatientTestsContainer) selectedPatientTestsContainer.style.display = 'none';
            if(selectedPatientTestsListUL) selectedPatientTestsListUL.innerHTML = '';
            if (patientCardAndLogTitle) patientCardAndLogTitle.style.display = 'none';

            updateGraphsAndTable();
            saveInputsToLocalStorage();
            showInitialScreenState();
            showStatusMessage("All fields cleared.", "info");
        }

        const localStorageKey = 'screeningAppData_vFirebase_01_EN';
        function saveInputsToLocalStorage() {
            const dataToSave = {
                currentPatient: { ...currentPatientDataForApp },
                ashTest: {}
            };
            ['I', 'Y', 'T'].forEach(pos => {
                dataToSave.ashTest[pos] = {
                    nonInjuredMaxForce: inputFieldMap[pos].nonInjured[0].value,
                    nonInjuredRfd: inputFieldMap[pos].nonInjured[1].value,
                    injuredMaxForce: inputFieldMap[pos].injured[0].value,
                    injuredRfd: inputFieldMap[pos].injured[1].value,
                };
            });
            try {
                localStorage.setItem(localStorageKey, JSON.stringify(dataToSave));
            } catch (error) {
                console.error('Error saving inputs to localStorage:', error);
            }
        }
        function loadInputsFromLocalStorage() {
            try {
                const savedDataString = localStorage.getItem(localStorageKey);
                if (savedDataString) {
                    const savedData = JSON.parse(savedDataString);
                    if (savedData.currentPatient) {
                        currentPatientDataForApp = { ...savedData.currentPatient };
                        if(fpNrInput) fpNrInput.value = currentPatientDataForApp.patientId || '';
                        if(ageInput) ageInput.value = currentPatientDataForApp.age || '';
                        if(genderSelect) genderSelect.value = currentPatientDataForApp.gender || '';
                        if(sportInput) sportInput.value = currentPatientDataForApp.sport || '';
                        if(injuryInput) injuryInput.value = currentPatientDataForApp.injury || '';
                        if(injuredSideRadio) injuredSideRadio.value = currentPatientDataForApp.injuredSide || 'Left';
                        if(bodyweightInput) bodyweightInput.value = currentPatientDataForApp.bodyweight || '';
                    }
                    if (savedData.ashTest) {
                        ['I', 'Y', 'T'].forEach(pos => {
                            if (savedData.ashTest[pos]) {
                                inputFieldMap[pos].nonInjured[0].value = savedData.ashTest[pos].nonInjuredMaxForce || '';
                                inputFieldMap[pos].nonInjured[1].value = savedData.ashTest[pos].nonInjuredRfd || '';
                                inputFieldMap[pos].injured[0].value = savedData.ashTest[pos].injuredMaxForce || '';
                                inputFieldMap[pos].injured[1].value = savedData.ashTest[pos].injuredRfd || '';
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading inputs from localStorage:', error);
            }
        }

        function showInitialScreenState() {
            if(patientDetailsTitle) patientDetailsTitle.style.display = 'block';
            if(patientChoiceSection) patientChoiceSection.style.display = 'flex';
            if(newPatientChoiceButton) newPatientChoiceButton.classList.remove('active-choice');
            if(existingPatientChoiceButton) existingPatientChoiceButton.classList.remove('active-choice');
            if(existingPatientSearchContainer) existingPatientSearchContainer.style.display = 'none';
            if(patientOverviewSection) patientOverviewSection.style.display = 'none';
            if (patientCardAndLogTitle) patientCardAndLogTitle.style.display = 'none';

            if(mainScreeningContent) mainScreeningContent.style.display = 'block';
            if(inputSectionContainer) inputSectionContainer.style.display = 'flex';
            if(resultsTitle) resultsTitle.style.display = 'block';
            if(positionRows) positionRows.forEach(row => row.style.display = 'flex');
            if(saveDataButtonContainer) saveDataButtonContainer.style.display = 'block';
        }

        function showConfirmationModal(message, onConfirmCallback) {
            confirmationModalMessage.textContent = message;
            confirmationModalOverlay.style.display = 'flex';

            const handleConfirmClick = () => {
                onConfirmCallback();
                confirmationModalOverlay.style.display = 'none';
                confirmationConfirmBtn.removeEventListener('click', handleConfirmClick);
                confirmationCancelBtn.removeEventListener('click', handleCancelClick);
            };

            const handleCancelClick = () => {
                confirmationModalOverlay.style.display = 'none';
                confirmationConfirmBtn.removeEventListener('click', handleConfirmClick);
                confirmationCancelBtn.removeEventListener('click', handleCancelClick);
            };

            confirmationConfirmBtn.removeEventListener('click', handleConfirmClick);
            confirmationCancelBtn.removeEventListener('click', handleCancelClick);

            confirmationConfirmBtn.addEventListener('click', handleConfirmClick);
            confirmationCancelBtn.addEventListener('click', handleCancelClick);
        }

        async function openPatientModal(type, patientIdToEdit = null) {
            if (!currentUserId) {
                showStatusMessage("You must be logged in.", "error");
                return;
            }
            patientModalOverlay.style.display = 'flex';
            let modalHTML = '';
            let tempPatientData = {};

            if (type === 'new') {
                tempPatientData = { patientId: '', age: '', gender: '', sport: '', injury: '', injuredSide: 'Left', bodyweight: '' };
                modalHTML = `
                    <h3>Register New Patient</h3>
                    <div class="modal-form-grid">
                        <div class="modal-form-item"><label for="modal-fp-nr">Patient ID:</label><input type="text" id="modal-fp-nr" value="${tempPatientData.patientId}" autocomplete="off"></div>
                        <div class="modal-form-item"><label for="modal-injured-side">Injured Side:</label><select id="modal-injured-side"></select></div>
                        <div class="modal-form-item"><label for="modal-bodyweight">Bodyweight (kg):</label><input type="number" id="modal-bodyweight" value="${tempPatientData.bodyweight}"></div>
                        <div class="modal-form-item"><label for="modal-age">Age:</label><input type="number" id="modal-age" value="${tempPatientData.age}"></div>
                        <div class="modal-form-item"><label for="modal-gender">Gender:</label><select id="modal-gender"></select></div>
                        <div class="modal-form-item"><label for="modal-sport">Sport:</label><input type="text" id="modal-sport" value="${tempPatientData.sport}"></div>
                        <div class="modal-form-item full-width" style="grid-column: 1 / -1;"><label for="modal-injury">Injury (Optional):</label><input type="text" id="modal-injury" value="${tempPatientData.injury}"></div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="modal-cancel-button" id="modal-cancel-new">Cancel</button>
                        <button type="button" class="modal-confirm-button" id="modal-confirm-new">Confirm</button>
                    </div>`;
            } else if (type === 'existing-search') {
                modalHTML = `
                    <h3>Select Existing Patient</h3>
                    <div class="modal-form-item">
                        <label for="modal-search-fp-nr">Select Patient:</label>
                        <input type="text" id="modal-search-fp-nr" autocomplete="off">
                    </div>
                    <div class="modal-patient-id-buttons" id="modal-patient-id-button-container">
                        </div>
                    <div class="modal-actions">
                        <button type="button" class="modal-cancel-button" id="modal-cancel-search">Cancel</button>
                    </div>`;
            } else if (type === 'existing-edit' && patientIdToEdit) {
                try {
                    const patientDocRef = doc(db, "users", currentUserId, "patients", patientIdToEdit);
                    const patientDocSnap = await getDoc(patientDocRef);
                    if (patientDocSnap.exists()) {
                        tempPatientData = { patientId: patientIdToEdit, ...patientDocSnap.data() };
                    } else {
                        showStatusMessage(`Patient data for ${patientIdToEdit} not found. Cannot edit.`, "error");
                        tempPatientData = { patientId: patientIdToEdit, age: '', gender: '', sport: '', injury: '', injuredSide: 'Left', bodyweight: '' };
                    }
                } catch(error) {
                    console.error("Error fetching patient data for edit:", error);
                    showStatusMessage("Could not fetch patient data for editing.", "error");
                    tempPatientData = { patientId: patientIdToEdit, age: '', gender: '', sport: '', injury: '', injuredSide: 'Left', bodyweight: '' };
                }
                modalHTML = `
                    <h3>Edit Patient: ${patientIdToEdit}</h3>
                    <div class="modal-form-grid">
                        <div class="modal-form-item"><label>Patient ID:</label><input type="text" value="${tempPatientData.patientId}" disabled></div> <div class="modal-form-item"><label for="modal-injured-side">Injured Side:</label><select id="modal-injured-side"></select></div>
                        <div class="modal-form-item"><label for="modal-bodyweight">Bodyweight (kg):</label><input type="number" id="modal-bodyweight" value="${tempPatientData.bodyweight || ''}"></div>
                        <div class="modal-form-item"><label for="modal-age">Age:</label><input type="number" id="modal-age" value="${tempPatientData.age || ''}"></div>
                        <div class="modal-form-item"><label for="modal-gender">Gender:</label><select id="modal-gender"></select></div>
                        <div class="modal-form-item"><label for="modal-sport">Sport:</label><input type="text" id="modal-sport" value="${tempPatientData.sport || ''}"></div>
                        <div class="modal-form-item full-width" style="grid-column: 1 / -1;"><label for="modal-injury">Injury:</label><input type="text" id="modal-injury" value="${tempPatientData.injury || ''}"></div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="modal-cancel-button" id="modal-cancel-edit">Cancel</button>
                        <button type="button" class="modal-confirm-button" id="modal-confirm-edit">Done</button>
                    </div>`;
            }
            patientModalContent.innerHTML = modalHTML;

            if (type === 'existing-edit' || type === 'new') {
                const genderModalSelect = patientModalContent.querySelector('#modal-gender');
                const injuredSideModalSelect = patientModalContent.querySelector('#modal-injured-side');

                if(genderModalSelect) genderModalSelect.innerHTML = '';
                if(injuredSideModalSelect) injuredSideModalSelect.innerHTML = '';


                if (genderModalSelect) {
                    ['', 'Male', 'Female', 'Other'].forEach(val => genderModalSelect.add(new Option(val === '' ? 'Select...' : val, val)));
                    genderModalSelect.value = tempPatientData.gender || '';
                }
                if (injuredSideModalSelect) {
                    ['Left', 'Right'].forEach(val => injuredSideModalSelect.add(new Option(val, val)));
                    injuredSideModalSelect.value = tempPatientData.injuredSide || 'Left';
                }
            }

            if (type === 'new') {
                patientModalContent.querySelector('#modal-confirm-new')?.addEventListener('click', handleNewPatientConfirm);
                patientModalContent.querySelector('#modal-cancel-new')?.addEventListener('click', closePatientModal);
            } else if (type === 'existing-search') {
                await populateModalPatientButtons(); 
                const modalSearchInput = patientModalContent.querySelector('#modal-search-fp-nr');
                
                if (modalSearchInput) {
                    modalSearchInput.addEventListener('input', (e) => {
                        filterModalPatientButtons(e.target.value.trim());
                    });
                }
                patientModalContent.querySelector('#modal-cancel-search')?.addEventListener('click', closePatientModal);
            } else if (type === 'existing-edit') {
                const capturedIdForEdit = patientIdToEdit;
                patientModalContent.querySelector('#modal-confirm-edit')?.addEventListener('click', () => {
                    handleExistingPatientDone(capturedIdForEdit);
                });
                patientModalContent.querySelector('#modal-cancel-edit')?.addEventListener('click', closePatientModal);
            }
        }

        function closePatientModal() {
            patientModalOverlay.style.display = 'none';
            patientModalContent.innerHTML = '';
        }

        async function populateModalPatientButtons() {
            const container = document.getElementById('modal-patient-id-button-container');

            if (!container || !currentUserId) return;

            container.innerHTML = ''; 

            if (allPatientIds.length === 0) { 
                const patientsCollectionRef = collection(db, "users", currentUserId, "patients");
                try {
                    const querySnapshot = await getDocs(patientsCollectionRef);
                    querySnapshot.forEach((docSnap) => {
                        allPatientIds.push(docSnap.id);
                    });
                    allPatientIds.sort(); 
                } catch (error) {
                    console.error("Error fetching patient IDs for modal:", error);
                    container.textContent = 'Error loading patients.';
                    return;
                }
            }
            filterModalPatientButtons(''); 
        }

        function filterModalPatientButtons(filterText) {
            const container = document.getElementById('modal-patient-id-button-container');
            if (!container) return;
            container.innerHTML = ''; 

            const filteredIds = allPatientIds.filter(id =>
                id.toLowerCase().includes(filterText.toLowerCase())
            );

            if (filteredIds.length === 0) {
                container.textContent = 'No matching patients found.';
                return;
            }

            filteredIds.forEach((patientId) => {
                const button = document.createElement('button');
                button.textContent = patientId;
                button.classList.add('modal-patient-id-button');
                button.addEventListener('click', () => {
                    loadAndDisplayPatient(patientId);
                });
                container.appendChild(button);
            });
        }


        async function handleNewPatientConfirm() {
            if (!currentUserId) {
                showStatusMessage("You must be logged in to add patients.", "error");
                return;
            }
            const newPatientId = patientModalContent.querySelector('#modal-fp-nr').value.trim();
            if (!newPatientId) {
                showStatusMessage("Patient ID is required.", "error");
                return;
            }

            const patientDocRef = doc(db, "users", currentUserId, "patients", newPatientId);
            try {
                const docSnap = await getDoc(patientDocRef);
                if (docSnap.exists()) {
                    showStatusMessage(`Patient ID "${newPatientId}" already exists. Choose a different ID or edit existing.`, "error");
                    return;
                }
            } catch (error) {
                console.error("Error checking patient ID existence:", error);
                showStatusMessage("Error checking patient ID.", "error");
                return;
            }

            currentPatientDataForApp = {
                patientId: newPatientId,
                age: patientModalContent.querySelector('#modal-age').value,
                gender: patientModalContent.querySelector('#modal-gender').value,
                sport: patientModalContent.querySelector('#modal-sport').value,
                injury: patientModalContent.querySelector('#modal-injury').value,
                injuredSide: patientModalContent.querySelector('#modal-injured-side').value,
                bodyweight: patientModalContent.querySelector('#modal-bodyweight').value,
                screeningId: null
            };

            const patientDataToSave = {
                age: currentPatientDataForApp.age ? parseInt(currentPatientDataForApp.age) : null,
                gender: currentPatientDataForApp.gender || null,
                sport: currentPatientDataForApp.sport || null,
                injury: currentPatientDataForApp.injury || null,
                injuredSide: currentPatientDataForApp.injuredSide || 'Left',
                bodyweight: parseFloat(currentPatientDataForApp.bodyweight) || null,
                firstRegisteredAt: serverTimestamp(),
                lastUpdatedAt: serverTimestamp()
            };

            try {
                await setDoc(patientDocRef, patientDataToSave);
                showStatusMessage(`New patient "${newPatientId}" saved. Ready for screening.`, "success");
                displayPatientInfoInCard(currentPatientDataForApp);
                if (patientCardAndLogTitle) patientCardAndLogTitle.style.display = 'block';
                allPatientIds.push(newPatientId); 
                allPatientIds.sort(); 
                closePatientModal();

                if(fpNrInput) fpNrInput.value = currentPatientDataForApp.patientId;
                if(ageInput) ageInput.value = currentPatientDataForApp.age;
                if(genderSelect) genderSelect.value = currentPatientDataForApp.gender;
                if(sportInput) sportInput.value = currentPatientDataForApp.sport;
                if(injuryInput) injuryInput.value = currentPatientDataForApp.injury;
                if(injuredSideRadio) injuredSideRadio.value = currentPatientDataForApp.injuredSide;
                if(bodyweightInput) bodyweightInput.value = currentPatientDataForApp.bodyweight;

                if (newPatientChoiceButton) newPatientChoiceButton.classList.remove('active-choice');
                if (existingPatientChoiceButton) existingPatientChoiceButton.classList.remove('active-choice');
                if (existingPatientSearchContainer) existingPatientSearchContainer.style.display = 'none';
                if (patientOverviewSection) patientOverviewSection.style.display = 'flex';


                resetScreeningInputFields();
                updateGraphsAndTable();
                await displayTestsForPatientFromFirestore(newPatientId);
                saveInputsToLocalStorage();
            } catch (error) {
                console.error("Error saving new patient:", error);
                showStatusMessage("Error saving patient data.", "error");
            }
        }

        async function handleExistingPatientDone(patientIdToUpdate) {
            console.log("handleExistingPatientDone called with ID:", patientIdToUpdate);
            if (!currentUserId || !patientIdToUpdate) {
                console.warn("handleExistingPatientDone: Missing currentUserId or patientIdToUpdate.", currentUserId, patientIdToUpdate);
                return;
            }

            const updatedPatientDataFromModal = {
                patientId: patientIdToUpdate,
                age: patientModalContent.querySelector('#modal-age').value,
                gender: patientModalContent.querySelector('#modal-gender').value,
                sport: patientModalContent.querySelector('#modal-sport').value,
                injury: patientModalContent.querySelector('#modal-injury').value,
                injuredSide: patientModalContent.querySelector('#modal-injured-side').value,
                bodyweight: patientModalContent.querySelector('#modal-bodyweight').value,
                screeningId: null 
            };
            currentPatientDataForApp = { ...updatedPatientDataFromModal };

            const patientDataToUpdateFirestore = {
                age: updatedPatientDataFromModal.age ? parseInt(updatedPatientDataFromModal.age) : null,
                gender: updatedPatientDataFromModal.gender || null,
                sport: updatedPatientDataFromModal.sport || null,
                injury: updatedPatientDataFromModal.injury || null,
                injuredSide: updatedPatientDataFromModal.injuredSide || 'Left',
                bodyweight: parseFloat(updatedPatientDataFromModal.bodyweight) || null,
                lastUpdatedAt: serverTimestamp()
            };

            try {
                const patientDocRef = doc(db, "users", currentUserId, "patients", patientIdToUpdate);
                await updateDoc(patientDocRef, patientDataToUpdateFirestore);
                showStatusMessage(`Details for patient "${patientIdToUpdate}" updated.`, "success");

                if(fpNrInput) fpNrInput.value = currentPatientDataForApp.patientId;
                if(ageInput) ageInput.value = currentPatientDataForApp.age;
                if(genderSelect) genderSelect.value = currentPatientDataForApp.gender;
                if(sportInput) sportInput.value = currentPatientDataForApp.sport;
                if(injuryInput) injuryInput.value = currentPatientDataForApp.injury;
                if(injuredSideRadio) injuredSideRadio.value = currentPatientDataForApp.injuredSide;
                if(bodyweightInput) bodyweightInput.value = currentPatientDataForApp.bodyweight;

                displayPatientInfoInCard(currentPatientDataForApp);
                if (patientCardAndLogTitle) patientCardAndLogTitle.style.display = 'block';
                await displayTestsForPatientFromFirestore(patientIdToUpdate);

                resetScreeningInputFields(); 

                closePatientModal();

                if (newPatientChoiceButton) newPatientChoiceButton.classList.remove('active-choice');
                if (existingPatientChoiceButton) existingPatientChoiceButton.classList.remove('active-choice');
                if (existingPatientSearchContainer) existingPatientSearchContainer.style.display = 'none';
                if (patientOverviewSection) patientOverviewSection.style.display = 'flex';

                updateGraphsAndTable();
                saveInputsToLocalStorage();
            } catch (error) {
                console.error("Error updating patient data:", error);
                showStatusMessage("Error updating patient data.", "error");
            }
        }

        async function deletePatientAndScreenings(patientId) {
            if (!currentUserId || !patientId) {
                showStatusMessage("Error: Cannot delete patient. Missing user or patient ID.", "error");
                return;
            }

            showStatusMessage(`Deleting patient "${patientId}" and all their data...`, "info", 5000);

            try {
                const screeningsRef = collection(db, "users", currentUserId, "patients", patientId, "screenings");
                const q = query(screeningsRef);
                const querySnapshot = await getDocs(q);

                const deletePromises = [];
                querySnapshot.forEach((docSnap) => {
                    deletePromises.push(deleteDoc(doc(db, "users", currentUserId, "patients", patientId, "screenings", docSnap.id)));
                });
                await Promise.all(deletePromises);
                console.log(`Deleted ${deletePromises.length} screenings for patient ${patientId}.`);

                const patientDocRef = doc(db, "users", currentUserId, "patients", patientId);
                await deleteDoc(patientDocRef);

                showStatusMessage(`Patient "${patientId}" and all data deleted successfully.`, "success");
                allPatientIds = allPatientIds.filter(id => id !== patientId);
                clearAllFields(); 
                showInitialScreenState(); 
            } catch (error) {
                console.error("Error deleting patient and screenings:", error);
                showStatusMessage(`Error deleting patient "${patientId}".`, "error");
            }
        }

        function displayPatientInfoInCard(data) {
            const card = document.getElementById('patient-identity-card');
            const overview = document.getElementById('patient-overview-section');
            const testsContainer = document.getElementById('selected-patient-tests-container');
            const overviewTitle = document.getElementById('patient-card-and-log-title');


            if (!card || !overview || !testsContainer || !overviewTitle) {
                console.error("One or more patient info card elements are missing.");
                return;
            }

            const idCard = document.getElementById('display-patient-id-card');
            const ageCard = document.getElementById('display-age-card');
            const genderCard = document.getElementById('display-gender-card');
            const sportCard = document.getElementById('display-sport-card');
            const injuryCard = document.getElementById('display-injury-card');
            const injuredSideCard = document.getElementById('display-injured-side-card');
            const bodyweightCard = document.getElementById('display-bodyweight-card');

            if (idCard) idCard.textContent = data.patientId || 'N/A';
            if (ageCard) ageCard.textContent = data.age || 'N/A';
            if (genderCard) genderCard.textContent = data.gender || 'N/A';
            if (sportCard) sportCard.textContent = data.sport || 'N/A';
            if (injuryCard) injuryCard.textContent = data.injury || 'N/A';
            if (injuredSideCard) injuredSideCard.textContent = data.injuredSide || 'N/A';
            if (bodyweightCard) bodyweightCard.textContent = data.bodyweight ? `${data.bodyweight} kg` : 'N/A';

            card.style.display = 'flex';
            testsContainer.style.display = 'flex';
            overview.style.display = 'flex';
            overviewTitle.style.display = 'block';
        }
        
        async function populatePatientIdDatalistFromFirestore() {
            if (!currentUserId) return;
            const patientsCollectionRef = collection(db, "users", currentUserId, "patients");
            
            try {
                const querySnapshot = await getDocs(patientsCollectionRef);
                const patientIds = new Set();
                querySnapshot.forEach((docSnap) => patientIds.add(docSnap.id));
                allPatientIds = Array.from(patientIds);
                allPatientIds.sort();
            } catch (error) {
                console.error("Error populating patient ID list from Firestore:", error);
                showStatusMessage("Error loading patient list.", "error");
            }
        }

        async function displayTestsForPatientFromFirestore(patientId) {
            const localTestsContainer = document.getElementById('selected-patient-tests-container');
            const localTestsListUL = document.getElementById('selected-patient-tests-list');
            const localPatientOverviewSection = document.getElementById('patient-overview-section');
            const overviewTitle = document.getElementById('patient-card-and-log-title');


            if (!currentUserId || !patientId) {
                if (localTestsListUL) localTestsListUL.innerHTML = '<li>Select a patient to see tests.</li>';
                if (localTestsContainer) localTestsContainer.style.display = 'flex';
                if (overviewTitle) overviewTitle.style.display = (document.getElementById('patient-identity-card')?.style.display === 'flex') ? 'block' : 'none';
                if (localPatientOverviewSection && document.getElementById('patient-identity-card')?.style.display === 'flex') {
                    localPatientOverviewSection.style.display = 'flex';
                }
                return;
            }

            if (!localTestsListUL || !localTestsContainer || !overviewTitle ) {
                return;
            }
            overviewTitle.style.display = 'block';
            localTestsListUL.innerHTML = '<li>Loading tests...</li>';
            localTestsContainer.style.display = 'flex';
            if (localPatientOverviewSection) localPatientOverviewSection.style.display = 'flex';

            const screeningsPath = `users/${currentUserId}/patients/${patientId}/screenings`;
            const screeningsRef = collection(db, screeningsPath);
            const q = query(screeningsRef, orderBy("testTimestamp", "asc"));

            try {
                const querySnapshot = await getDocs(q);
                localTestsListUL.innerHTML = '';
                if (querySnapshot.empty) {
                    localTestsListUL.innerHTML = '<li>No tests found for this patient.</li>';
                    return;
                }

                querySnapshot.forEach((docSnap) => {
                    const screening = docSnap.data();
                    const screeningDocId = docSnap.id;
                    const li = document.createElement('li');
                    li.dataset.screeningId = screeningDocId;
                    li.addEventListener('click', () => loadScreeningDataFromFirestore(patientId, screeningDocId));

                    const dateSpan = document.createElement('span');
                    const screeningTimestampDate = screening.testTimestamp?.toDate();
                    if (screeningTimestampDate instanceof Date && !isNaN(screeningTimestampDate)) {
                        dateSpan.textContent = screeningTimestampDate.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
                    } else {
                        dateSpan.textContent = "Invalid date";
                    }
                    dateSpan.title = "Load this test";

                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteButton.title = "Delete this test";
                    deleteButton.classList.add('delete-test-btn');
                    deleteButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showConfirmationModal(
                            `Are you sure you want to delete the test for patient "${patientId}" from ${dateSpan.textContent}? This action cannot be undone.`,
                            async () => {
                                await deleteScreeningFromFirestore(patientId, screeningDocId, screeningTimestampDate || new Date());
                            }
                        );
                    });
                    li.appendChild(dateSpan);
                    li.appendChild(deleteButton);
                    localTestsListUL.appendChild(li);
                });
            } catch (error) {
                localTestsListUL.innerHTML = '<li>Error loading tests. Check console for details.</li>';
                showStatusMessage("Error loading patient tests.", "error");
            }
        }


        async function loadScreeningDataFromFirestore(patientId, screeningDocId) {
            if (!currentUserId) return;
            try {
                const screeningDocRef = doc(db, "users", currentUserId, "patients", patientId, "screenings", screeningDocId);
                const docSnap = await getDoc(screeningDocRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentPatientDataForApp = {
                        patientId: data.patientId,
                        age: data.ageAtScreening,
                        gender: data.genderAtScreening,
                        sport: data.sportAtScreening,
                        injury: data.injuryAtScreening,
                        bodyweight: data.bodyweightAtScreening,
                        injuredSide: data.injuredSideAtScreening,
                        screeningId: screeningDocId 
                    };

                    if(fpNrInput) fpNrInput.value = currentPatientDataForApp.patientId || '';
                    if(ageInput) ageInput.value = currentPatientDataForApp.age || '';
                    if(genderSelect) genderSelect.value = currentPatientDataForApp.gender || '';
                    if(sportInput) sportInput.value = currentPatientDataForApp.sport || '';
                    if(injuryInput) injuryInput.value = currentPatientDataForApp.injury || '';
                    if(bodyweightInput) bodyweightInput.value = currentPatientDataForApp.bodyweight || '';
                    if(injuredSideRadio) injuredSideRadio.value = currentPatientDataForApp.injuredSide || 'Left';

                    ['I', 'Y', 'T'].forEach(pos => {
                        const testPosData = data.ashTest ? data.ashTest[pos] : null;
                        if (inputFieldMap[pos]?.nonInjured[0]) inputFieldMap[pos].nonInjured[0].value = testPosData?.nonInjuredMaxForce || '';
                        if (inputFieldMap[pos]?.nonInjured[1]) inputFieldMap[pos].nonInjured[1].value = testPosData?.nonInjuredRfd || '';
                        if (inputFieldMap[pos]?.injured[0]) inputFieldMap[pos].injured[0].value = testPosData?.injuredMaxForce || '';
                        if (inputFieldMap[pos]?.injured[1]) inputFieldMap[pos].injured[1].value = testPosData?.injuredRfd || '';
                    });

                    updateGraphsAndTable();
                    saveInputsToLocalStorage(); 
                    showStatusMessage('Test data loaded.', 'success');
                    displayPatientInfoInCard(currentPatientDataForApp);
                     if (patientCardAndLogTitle) patientCardAndLogTitle.style.display = 'block';

                    clearActiveTestItemState();
                    const activeLi = selectedPatientTestsListUL.querySelector(`li[data-screening-id="${screeningDocId}"]`);
                    if (activeLi) {
                        activeLi.classList.add('active-test-item');
                    }

                } else {
                    showStatusMessage("Could not find selected test data.", "error");
                }
            } catch (error) {
                console.error("Error loading screening data:", error);
                showStatusMessage("Error loading test data.", "error");
            }
        }

        async function deleteScreeningFromFirestore(patientId, screeningDocId, dateObject) {
            if (!currentUserId) return;
            const formattedDate = dateObject instanceof Date && !isNaN(dateObject)
                ? dateObject.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' })
                : "unknown date";

            showStatusMessage("Deleting test...", "info", 1500);
            try {
                const screeningDocRef = doc(db, "users", currentUserId, "patients", patientId, "screenings", screeningDocId);
                await deleteDoc(screeningDocRef);
                showStatusMessage('Test deleted.', 'success');

                if (currentPatientDataForApp.screeningId === screeningDocId && currentPatientDataForApp.patientId === patientId) {
                    resetScreeningInputFields(); 
                    updateGraphsAndTable();
                    saveInputsToLocalStorage(); 
                }
                await displayTestsForPatientFromFirestore(patientId);
            } catch (error) {
                console.error("Error deleting screening:", error);
                showStatusMessage("Error deleting test.", "error");
            }
        }

        async function saveScreeningToFirestore() {
            if (!currentUserId || !currentPatientDataForApp || !currentPatientDataForApp.patientId) {
                showStatusMessage("No patient selected or user not logged in. Please select or create a patient first.", "error");
                openPatientModal('new');
                return;
            }
            const patientId = currentPatientDataForApp.patientId;
            const screeningData = {
                userId: currentUserId,
                patientId: patientId,
                testTimestamp: Timestamp.fromDate(new Date()),
                ageAtScreening: currentPatientDataForApp.age ? parseInt(currentPatientDataForApp.age) : null,
                genderAtScreening: currentPatientDataForApp.gender || null,
                sportAtScreening: currentPatientDataForApp.sport || null,
                injuryAtScreening: currentPatientDataForApp.injury || null,
                bodyweightAtScreening: currentPatientDataForApp.bodyweight ? parseFloat(currentPatientDataForApp.bodyweight) : null,
                injuredSideAtScreening: currentPatientDataForApp.injuredSide || 'Left',
                ashTest: {}
            };

            let dataEnteredForAsh = false;
            ['I', 'Y', 'T'].forEach(pos => {
                const niMaxF = parseFloat(inputFieldMap[pos].nonInjured[0].value) || null;
                const niRfd = parseFloat(inputFieldMap[pos].nonInjured[1].value) || null;
                const iMaxF = parseFloat(inputFieldMap[pos].injured[0].value) || null;
                const iRfd = parseFloat(inputFieldMap[pos].injured[1].value) || null;

                if (niMaxF !== null || niRfd !== null || iMaxF !== null || iRfd !== null) {
                    dataEnteredForAsh = true;
                }
                screeningData.ashTest[pos] = { nonInjuredMaxForce: niMaxF, nonInjuredRfd: niRfd, injuredMaxForce: iMaxF, injuredRfd: iRfd };
            });

            if (!dataEnteredForAsh) {
                showStatusMessage("No ASH test data entered to save.", "warning"); return;
            }

            try {
                const screeningsCollectionRef = collection(db, "users", currentUserId, "patients", patientId, "screenings");
                const docRef = await addDoc(screeningsCollectionRef, screeningData);
                currentPatientDataForApp.screeningId = docRef.id; 
                showStatusMessage("Screening saved!", "success");
                await displayTestsForPatientFromFirestore(patientId); 
                const activeLi = selectedPatientTestsListUL.querySelector(`li[data-screening-id="${docRef.id}"]`);
                if (activeLi) {
                    clearActiveTestItemState();
                    activeLi.classList.add('active-test-item');
                }
                displayPatientInfoInCard(currentPatientDataForApp);
                 if (patientCardAndLogTitle) patientCardAndLogTitle.style.display = 'block';
                 saveInputsToLocalStorage(); 
            } catch (error) {
                console.error("Error saving screening:", error);
                showStatusMessage("Error saving screening.", "error");
            }
        }
        
        async function loadAndDisplayPatient(patientId) {
            if (!currentUserId || !patientId) {
                showStatusMessage("Invalid patient ID or not logged in.", "error");
                return;
            }
            try {
                const patientDocRef = doc(db, "users", currentUserId, "patients", patientId);
                const patientDocSnap = await getDoc(patientDocRef);
                if (patientDocSnap.exists()) {
                    currentPatientDataForApp = { patientId: patientId, ...patientDocSnap.data(), screeningId: null }; 

                    if(fpNrInput) fpNrInput.value = currentPatientDataForApp.patientId;
                    if(ageInput) ageInput.value = currentPatientDataForApp.age;
                    if(genderSelect) genderSelect.value = currentPatientDataForApp.gender;
                    if(sportInput) sportInput.value = currentPatientDataForApp.sport;
                    if(injuryInput) injuryInput.value = currentPatientDataForApp.injury;
                    if(injuredSideRadio) injuredSideRadio.value = currentPatientDataForApp.injuredSide;
                    if(bodyweightInput) bodyweightInput.value = currentPatientDataForApp.bodyweight;

                    displayPatientInfoInCard(currentPatientDataForApp);
                    if (patientCardAndLogTitle) patientCardAndLogTitle.style.display = 'block';
                    await displayTestsForPatientFromFirestore(patientId);
                    resetScreeningInputFields(); 
                    updateGraphsAndTable();
                    saveInputsToLocalStorage(); 

                    if (patientOverviewSection) patientOverviewSection.style.display = 'flex';
                    showStatusMessage(`Patient "${patientId}" loaded successfully.`, "success");
                    closePatientModal(); 
                } else {
                    showStatusMessage(`Patient data for ${patientId} not found.`, "error");
                }
            } catch (error) {
                console.error("Error loading patient data:", error);
                showStatusMessage("Error loading patient data.", "error");
            }
        }


        if (newPatientChoiceButton) {
            newPatientChoiceButton.addEventListener('click', () => {
                openPatientModal('new');
            });
        }
        if (existingPatientChoiceButton) {
            existingPatientChoiceButton.addEventListener('click', () => {
                openPatientModal('existing-search');
            });
        }
        if (fpNrInputSearch) {
            fpNrInputSearch.addEventListener('input', async (e) => {
                const enteredPatientId = e.target.value.trim();
                
                if (enteredPatientId && currentUserId) {
                    try {
                        const patientDocRef = doc(db, "users", currentUserId, "patients", enteredPatientId);
                        const patientDocSnap = await getDoc(patientDocRef);
                        if (patientDocSnap.exists()) {
                            currentPatientDataForApp = { patientId: enteredPatientId, ...patientDocSnap.data(), screeningId: null };

                            if(fpNrInput) fpNrInput.value = currentPatientDataForApp.patientId;
                            if(ageInput) ageInput.value = currentPatientDataForApp.age;
                            if(genderSelect) genderSelect.value = currentPatientDataForApp.gender;
                            if(sportInput) sportInput.value = currentPatientDataForApp.sport;
                            if(injuryInput) injuryInput.value = currentPatientDataForApp.injury;
                            if(injuredSideRadio) injuredSideRadio.value = currentPatientDataForApp.injuredSide;
                            if(bodyweightInput) bodyweightInput.value = currentPatientDataForApp.bodyweight;

                            displayPatientInfoInCard(currentPatientDataForApp);
                            if (patientCardAndLogTitle) patientCardAndLogTitle.style.display = 'block';
                            await displayTestsForPatientFromFirestore(enteredPatientId);
                            resetScreeningInputFields(); 
                            updateGraphsAndTable();
                            saveInputsToLocalStorage(); 

                            if (patientOverviewSection) patientOverviewSection.style.display = 'flex';
                            showStatusMessage(`Patient "${enteredPatientId}" data displayed. Select a test from the log.`, "info");
                        } else {
                            showStatusMessage(`Patient ID not found: ${enteredPatientId}`, "warning");
                            clearAllFields(); 
                        }
                    } catch (error) {
                        console.error("Error fetching patient on main page search:", error);
                        showStatusMessage("Error loading patient data.", "error");
                    }
                } else if (!enteredPatientId) {
                    clearAllFields();
                }
            });
        }
        
        if (editPatientProfileButton) {
            editPatientProfileButton.addEventListener('click', () => {
                if (currentPatientDataForApp.patientId) {
                    openPatientModal('existing-edit', currentPatientDataForApp.patientId);
                } else {
                    showStatusMessage("No patient selected to edit.", "info");
                }
            });
        }
        
        if (deletePatientProfileButton) {
            deletePatientProfileButton.addEventListener('click', () => {
                if (currentPatientDataForApp.patientId) {
                    showConfirmationModal(
                        `Are you sure you want to delete patient "${currentPatientDataForApp.patientId}" and all their associated test data? This action cannot be undone.`,
                        async () => {
                            await deletePatientAndScreenings(currentPatientDataForApp.patientId);
                        }
                    );
                } else {
                    showStatusMessage("No patient selected to delete.", "info");
                }
            });
        }

        function updateCurrentPatientDataAndSave(key, value) {
            if (currentPatientDataForApp) {
                currentPatientDataForApp[key] = value;
                if(currentPatientDataForApp.patientId) {
                    displayPatientInfoInCard(currentPatientDataForApp);
                     if (patientCardAndLogTitle) patientCardAndLogTitle.style.display = 'block';
                }
                if (key === 'bodyweight' || key === 'injuredSide') {
                    updateGraphsAndTable();
                }
                saveInputsToLocalStorage();
            }
        }
        if (injuredSideRadio) injuredSideRadio.addEventListener('change', (e) => updateCurrentPatientDataAndSave('injuredSide', e.target.value));
        if (bodyweightInput) bodyweightInput.addEventListener('input', (e) => updateCurrentPatientDataAndSave('bodyweight', e.target.value));
        if (ageInput) ageInput.addEventListener('input', (e) => updateCurrentPatientDataAndSave('age', e.target.value));
        if (genderSelect) genderSelect.addEventListener('change', (e) => updateCurrentPatientDataAndSave('gender', e.target.value));
        if (sportInput) sportInput.addEventListener('input', (e) => updateCurrentPatientDataAndSave('sport', e.target.value));
        if (injuryInput) injuryInput.addEventListener('input', (e) => updateCurrentPatientDataAndSave('injury', e.target.value));

        allNumberInputs.forEach(input => {
            input.addEventListener('input', updateGraphsAndTable);
            input.addEventListener('change', saveInputsToLocalStorage);
        });
        if (pdfPreviewButton) pdfPreviewButton.addEventListener('click', enterPreviewMode);
        if (exportExcelButton) exportExcelButton.addEventListener('click', exportTableToCsv);
        if (previewExitButtonInline) previewExitButtonInline.addEventListener('click', exitPreviewMode); 
        if (clearAllButton) clearAllButton.addEventListener('click', clearAllFields);
        if(saveDataButton) saveDataButton.addEventListener('click', saveScreeningToFirestore);

        if(logoutButton) {
            logoutButton.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    localStorage.removeItem(localStorageKey);
                } catch (error) {
                    console.error("Logout error:", error);
                    showStatusMessage("Error logging out. Please try again.", "error");
                }
            });
        }
        window.addEventListener('load', () => { setTimeout(() => window.dispatchEvent(new Event('resize')), 200); });
        window.addEventListener('resize', () => {
            asymmetryChartDivs.concat(normativeChartDivs).forEach(divId => {
                const gd = document.getElementById(divId);
                if (gd && gd.classList.contains('js-plotly-plot') && typeof gd.layout !== 'undefined') { 
                     try {
                        Plotly.Plots.resize(gd);
                     } catch (e) { /* Ignore resize errors if plot not fully rendered */ }
                }
            });
        });

    </script>
</body>
</html>
