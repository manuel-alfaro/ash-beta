<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Functional Shoulder Screening</title>
    <script src="https://cdn.plot.ly/plotly-2.27.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Avenir:wght@400&family=Futura:wght@400&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" xintegrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --app-primary-color: #285484;
            --app-secondary-color: rgb(112, 188, 252);
            --app-tertiary-color: #121630;
            --app-text-on-primary: #ffffff;
            --app-text-on-secondary: var(--app-primary-color);
            --app-button-text-color: var(--app-text-on-primary);
            --app-button-icon-color: var(--app-secondary-color);
            --app-button-gradient-start: var(--app-primary-color);
            --app-button-gradient-end: var(--app-tertiary-color);
            --app-button-hover-gradient-start: #1e3a5c;
            --app-button-hover-gradient-end: var(--app-primary-color);
            --app-button-light-gradient-start: var(--app-secondary-color);
            --app-button-light-gradient-end: var(--app-primary-color);
            --app-button-light-hover-gradient-start: var(--app-primary-color);
            --app-button-light-hover-gradient-end: #1e3a5c;
            --light-gray: #f8f9fa;
            --medium-gray: #dee2e6;
            --dark-gray: #495057;
            --text-color: #212529;
            --success-color: #16a34a;
            --success-border-color: #15803d;
            --success-shadow-color: rgba(22, 163, 74, 0.45);
            --success-gradient-start-color: rgba(22, 163, 74, 1);
            --warning-color: #facc15;
            --danger-color-dark: #dc2626;
            --injured-input-bg: rgba(255, 224, 224, 0.7);
            --injured-input-border: #fca5a5;
            --white: #ffffff;
            --border-radius: 4px; 
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); 
            --sidebar-border-color: var(--medium-gray);
            --header-border-color: var(--medium-gray);
            --subtle-shadow: 0 1px 3px rgba(0,0,0,0.07); /* Litt dusere skygge */
            --left-line-color: #ff7f0e;
            --right-line-color: #1f77b4;
            --norm-poor-bg: rgba(252, 165, 165, 0.5);
            --norm-average-bg: rgba(252, 211, 77, 0.5);
            --norm-good-bg: rgba(167, 243, 208, 0.5);
            --norm-excellent-bg: rgba(52, 211, 153, 0.5);
            --base-font-size: 16px;
            --graph-box-height: 340px;
            --sidebar-width: 180px;
            --normal-font-weight: 400;
            --semibold-font-weight: 400; 
            --bold-font-weight: 700;    
            --main-content-margin: 20px;
        }
        body {
            font-family: 'Avenir', sans-serif;
            background-color: var(--light-gray);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            width: 100%;
            box-sizing: border-box;
            line-height: 1.6;
            font-size: var(--base-font-size);
            font-weight: var(--normal-font-weight);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-synthesis: none;
        }
        .app-layout {
            display: none;
            flex-direction: row;
            width: 100%;
            min-height: 100vh;
            margin-top: 0;
        }
        .loading-message, .status-message {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 1.2em;
            color: var(--app-primary-color);
            text-align: center;
            position: fixed;
            top: 0; left: 0; width: 100%;
            background-color: var(--light-gray);
            z-index: 2000;
        }
        .status-message {
            height: auto;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            min-width: 200px;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            display: none;
            font-size: 0.9rem;
        }
        .status-message.success { background-color: var(--norm-good-bg); color: var(--text-color); }
        .status-message.error { background-color: var(--norm-poor-bg); color: var(--text-color); }
        
        .app-sidebar { 
            width: var(--sidebar-width); 
            background-color: var(--light-gray); 
            color: var(--text-color); 
            padding: 20px 15px; 
            /* box-shadow: none; */ /* Skygge fjernet */
            /* border-right: 1px solid var(--sidebar-border-color); */ /* Kantlinje fjernet */
            display: flex; 
            flex-direction: column; 
            position: fixed; 
            top: 0; 
            left: 0; 
            height: 100vh; 
            overflow-y: auto; 
            z-index: 100; 
        }
        .sidebar-logo-placeholder { 
            height: 50px; 
            margin-bottom: 30px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.8rem; 
            color: var(--app-primary-color); 
        }
        .sidebar-buttons { display: flex; flex-direction: column; gap: 12px; }
        
        .sidebar-user-info {
            margin-top: auto; 
            padding: 15px 10px;
            text-align: center;
            border-top: 1px solid var(--medium-gray);
        }
        .user-details {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }
        .user-details i.fa-user-circle {
            font-size: 2.5rem; 
            color: var(--app-primary-color);
        }
        #loggedInUserName {
            font-weight: var(--semibold-font-weight);
            font-size: 0.95rem;
            color: var(--app-primary-color);
            overflow-wrap: break-word;
            word-break: break-all;
        }
        #loggedInUserEmailDisplay {
            font-size: 0.75rem;
            color: var(--dark-gray);
            overflow-wrap: break-word;
            word-break: break-all;
        }

        .sidebar-social-links {
            padding-top: 10px;
            margin-bottom: 25px;
            text-align: center;
        }
        .sidebar-social-links a { color: var(--app-secondary-color); margin: 0 20px; font-size: 1.5rem; text-decoration: none; transition: color 0.2s ease; }
        .sidebar-social-links a:hover { color: var(--app-primary-color); }
        .app-main-content { flex-grow: 1; margin-left: calc(var(--sidebar-width) + var(--main-content-margin)); padding: 30px 40px 30px 40px; background-color: var(--white); overflow-y: auto; height: 100vh; box-sizing: border-box; }
        .app-sidebar button, .app-sidebar a button { font-family: 'Avenir', sans-serif; font-size: 0.9rem; font-weight: var(--normal-font-weight); padding: 10px 15px; color: var(--app-primary-color); background-color: transparent; background-image: none; border: none; border-radius: var(--border-radius); cursor: pointer; transition: all 0.3s ease; box-shadow: none; letter-spacing: 0.5px; width: 100%; text-align: left; display: flex; align-items: center; gap: 10px; }
        
        .app-sidebar button#logout-button { 
            margin-top: 10px; 
            background-image: none; 
            background-color: transparent;
            color: var(--app-primary-color); 
            border: 1px solid var(--app-primary-color); 
        }
        .app-sidebar button#logout-button:hover {
            background-color: var(--app-primary-color); 
            color: var(--app-text-on-primary); 
        }
        .app-sidebar button#logout-button i { color: var(--app-primary-color); } 
        .app-sidebar button#logout-button:hover i { color: var(--app-text-on-primary); } 


        .app-sidebar button i { width: 20px; text-align: center; color: var(--app-primary-color); transition: color 0.3s ease; }
        .app-sidebar button:not(#logout-button):hover, 
        .app-sidebar a button:hover { 
            background-image: linear-gradient(to right, var(--app-button-light-gradient-start), var(--app-button-light-gradient-end)); 
            color: var(--app-text-on-primary); 
            transform: translateY(-1px); 
            border-color: transparent; 
        }
        .app-sidebar button:active, .app-sidebar a button:active { transform: translateY(0px); }
        .app-sidebar button:not(#logout-button):hover i, 
        .app-sidebar a button:hover i, 
        .app-sidebar button:not(#logout-button):active i, 
        .app-sidebar a button:active i { 
            color: var(--app-text-on-primary); 
        }
        .app-sidebar a { text-decoration: none; display: block; }
        .content-container { max-width: 1100px; margin: 0 auto; }
        h1, h2, h3 { font-family: 'Avenir', sans-serif; margin-bottom: 0.75em; font-weight: var(--normal-font-weight); }
        h1 { text-align: left; font-size: 2.0rem; margin-top: 0; margin-bottom: 1em; color: var(--app-primary-color); font-weight: var(--normal-font-weight); }
        h2 { font-size: 1.5rem; padding-bottom: 0.4em; margin-top: 1.8em; color: var(--app-secondary-color); font-weight: var(--normal-font-weight); }
        h3.position-title, h3.normative-title { font-size: 1.15rem; color: var(--app-primary-color); margin-bottom: 0.3em; font-weight: var(--normal-font-weight); }
        h3.normative-title { text-align: center;}
        #report-content { background-color: var(--white); padding: 15px 0; }
        #top-controls { display: flex; justify-content: flex-start; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; background-color: transparent; border: none; border-radius: 0; padding: 0; box-shadow: none; }
        #top-controls .control-item { border: none; border-radius: var(--border-radius); background-color: var(--light-gray); padding: 15px 20px; display: flex; align-items: center; gap: 8px; box-shadow: none; transition: none; }
        #top-controls .control-item:focus-within { border-color: transparent; }
        #top-controls .control-label { font-family: 'Avenir', sans-serif; font-size: 0.9rem; color: var(--dark-gray); font-weight: var(--normal-font-weight); }
        #top-controls #injured-side-radio, #top-controls #bodyweight-input { font-family: 'Avenir', sans-serif; font-size: 0.9rem; padding: 5px 8px; border: 1px solid var(--medium-gray); border-radius: var(--border-radius); background-color: var(--white); color: var(--text-color); transition: background-color 0.3s ease; font-weight: var(--normal-font-weight); width: 80px; }
        #top-controls #injured-side-radio:focus, #top-controls #bodyweight-input:focus { border-color: var(--app-primary-color); outline: 2px solid var(--app-secondary-color); background-color: var(--white); }
        #top-controls #bodyweight-input { width: 60px; }
        #top-controls #injured-side-radio { appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23212529'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        
        #patient-data-container { 
            display: block; 
            background-color: var(--light-gray); 
            padding: 20px; 
            border-radius: var(--border-radius); 
            margin-bottom: 25px; 
            border: none; /* Fjernet kantlinje */
            box-shadow: none; /* Fjernet skygge */
        }
        #patient-data-grid { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
        .patient-data-item { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 150px; }
        .patient-data-item label { font-family: 'Avenir', sans-serif; font-size: 0.9rem; color: var(--dark-gray); font-weight: var(--normal-font-weight); }
        #patient-data-container input[type="text"], #patient-data-container input[type="number"], #patient-data-container select { font-family: 'Avenir', sans-serif; font-size: 0.9rem; padding: 6px 10px; border: none; /* Fjernet kantlinje fra felter */ border-radius: var(--border-radius); background-color: var(--white); color: var(--text-color); transition: border-color 0.2s ease; width: 100%; box-sizing: border-box; font-weight: var(--normal-font-weight); }
        #patient-data-container input[type="text"]:focus, #patient-data-container input[type="number"]:focus, #patient-data-container select:focus { border-color: var(--app-primary-color); outline: 2px solid var(--app-secondary-color); background-color: var(--white); }
        #patient-data-container select { appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23212529'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        #fp-nr-input {
            padding: 8px 12px; 
            font-size: 1rem;
            border: 1px solid var(--medium-gray); /* Legg tilbake en subtil border for input-feltet */
        }
        #fp-nr-input:focus {
            border-color: var(--app-primary-color);
        }


        /* === CSS for visning av lagrede tester === */
        #selected-patient-tests-container { 
            background-color: var(--light-gray); 
            padding: 20px;
            margin-top: 30px;
            margin-bottom: 30px;
            box-shadow: none; 
            border-radius: var(--border-radius); 
            border: 1px solid var(--medium-gray); 
        }

        #selected-patient-tests-container h3 { 
            margin-top: 0;
            margin-bottom: 18px;
            font-size: 1.2rem; 
            color: var(--app-primary-color);
            border-bottom: 1px solid var(--medium-gray); 
            padding-bottom: 12px;
            font-weight: var(--normal-font-weight); 
        }

        #selected-patient-tests-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex; 
            flex-wrap: wrap; 
            gap: 12px; /* Økt gap for bedre separasjon */
        }

        #selected-patient-tests-list li {
            display: flex;
            flex-direction: column; 
            justify-content: space-between;
            align-items: center; 
            padding: 12px 15px; /* Økt padding */
            border: 1px solid var(--app-secondary-color); /* Blå kantlinje */
            background-color: rgba(112, 188, 252, 0.08); /* Veldig lys blå bakgrunn */
            border-radius: var(--border-radius);
            min-width: 160px; /* Litt bredere */
            box-sizing: border-box;
            text-align: center;
            transition: background-color 0.2s ease, transform 0.2s ease;
            cursor: pointer; /* Hele kortet er klikkbart for å laste */
        }
        
        #selected-patient-tests-list li:hover { 
            background-color: rgba(112, 188, 252, 0.15); 
            transform: translateY(-2px); /* Liten løfteeffekt */
        }

        #selected-patient-tests-list li span { 
            color: var(--app-primary-color); 
            font-size: 0.9rem;
            font-weight: var(--semibold-font-weight);
            margin-bottom: 10px; /* Mer plass til knappen */
        }
        /* fjerner hover for span siden hele li nå er hoverable */
        /* #selected-patient-tests-list li span:hover { color: var(--app-tertiary-color); } */


        #selected-patient-tests-list button.delete-test-btn {
            background-color: transparent;
            border: 1px solid var(--danger-color-dark);
            color: var(--danger-color-dark);
            border-radius: var(--border-radius);
            cursor: pointer;
            padding: 5px 8px; /* Litt mer padding */
            font-size: 0.85rem; 
            transition: all 0.2s ease;
            width: auto; 
            display: flex; /* For å sentrere ikon */
            align-items: center;
            justify-content: center;
        }
        #selected-patient-tests-list button.delete-test-btn:hover {
            background-color: var(--danger-color-dark);
            color: white;
        }
        #selected-patient-tests-list button.delete-test-btn i {
            /* margin-right: 5px; Fjernet, da teksten er borte */
        }
        /* === Slutt på CSS for testliste-container === */

        #save-data-button-container { margin-top: 20px; margin-bottom: 20px; text-align: center; }
        #save-data-button-main {
            background-image: none; 
            background-color: transparent;
            color: var(--app-primary-color); 
            border: 1px solid var(--app-primary-color); 
            padding: 10px 25px;
            font-size: 1rem;
            border-radius: var(--border-radius); 
            cursor: pointer;
            transition: all 0.3s ease; 
            box-shadow: none; 
        }
        #save-data-button-main:hover {
            background-color: var(--app-primary-color); 
            color: var(--app-text-on-primary); 
        }
        #save-data-button-main i { 
             color: var(--app-primary-color);
        }
        #save-data-button-main:hover i {
            color: var(--app-text-on-primary);
        }


        #input-section-container { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
        .input-position-box { flex: 1; min-width: 300px; padding: 15px; background: linear-gradient(to top right, rgb(222, 226, 230), rgb(112, 188, 252)); box-shadow: var(--box-shadow); border-radius: var(--border-radius); margin-bottom: 20px; position: relative; overflow: hidden; }
        .input-position-box h4 { font-family: 'Avenir', sans-serif; font-weight: var(--normal-font-weight); font-size: 1.2rem; color: var(--app-primary-color); margin-top: 0; margin-bottom: 20px; text-align: left; border-bottom: none; padding-bottom: 0; position: relative; z-index: 1; }
        .input-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 15px; gap: 5px; position: relative; z-index: 1; }
        .input-row label { font-family: 'Avenir', sans-serif; font-size: 0.9rem; color: var(--text-color); width: 160px; flex-shrink: 0; text-align: left; font-weight: var(--normal-font-weight); padding-bottom: 8px; }
        .input-wrapper { display: flex; align-items: baseline; flex: 1; justify-content: flex-start; }
        .input-position-box .input-row input { font-family: 'Avenir', sans-serif; font-size: 1.5rem; font-weight: var(--normal-font-weight); width: 100px; height: auto; border: none; border-bottom: 1px solid rgba(255, 255, 255, 0.5); border-radius: 0px; padding: 6px 0px 4px 0px; text-align: center; box-sizing: border-box; transition: background-color 0.2s ease, border-color 0.2s ease; background-color: transparent; color: var(--text-color); position: relative; z-index: 1; }
        .input-position-box .input-row input::placeholder { font-size: 0.8rem; color: #ffffff; font-weight: var(--normal-font-weight); opacity: 0.8; }
        .input-position-box .input-row input:focus { outline: none; border-bottom-color: rgba(255, 255, 255, 0.9); background-color: rgba(255, 255, 255, 0.1); }
        .input-position-box .unit-text { font-size: 0.9rem; color: var(--text-color); margin-left: 5px; white-space: nowrap; }
        .unit-text sup { font-size: 0.7em; vertical-align: super; }
        #canvas-container { display: none; }
        .position-row { display: flex; flex-wrap: wrap; gap: 30px; margin-bottom: 35px; padding-bottom: 30px; align-items: stretch; }
        .position-row:last-child { border-bottom: none; margin-bottom: 0; }
        .asymmetry-graph-container { flex: 6; min-width: 320px; }
        .normative-graph-container { flex: 4; min-width: 260px; }
        
        /* Grafbokser - gjenopprettet skygge, fjernet unødvendig border */
        .position-box, .normative-box { 
            border: none; /* Fjernet ekstra border */
            padding: 10px 20px 15px 20px; 
            border-radius: var(--border-radius); 
            background-color: var(--light-gray); 
            box-shadow: var(--subtle-shadow); /* Gjenopprettet skygge */
            margin-bottom: 0; 
            transition: box-shadow 0.3s ease, opacity 0.3s ease; /* Beholdt shadow transition */
            display: flex; 
            flex-direction: column; 
            height: var(--graph-box-height); 
            position: relative; 
            overflow: hidden; 
        }
        .position-box.green-box { 
            box-shadow: 0 0 15px 5px var(--success-shadow-color); /* Beholdt spesiell skygge for green-box */
            border-color: var(--success-border-color); 
        }
        .position-box::after { content: ''; position: absolute; top: -100px; right: -100px; width: 500px; height: 500px; background-image: radial-gradient(circle at top right, var(--success-gradient-start-color) 0%, rgba(from var(--light-gray) r g b / 0) 65% ); opacity: 0; pointer-events: none; z-index: 0; border-radius: 50%; transition: opacity 0.3s ease; }
        .position-box.green-box::after { opacity: 0.85; }
        .js-plotly-plot { flex-grow: 1; position: relative; z-index: 1; }
        #normative-placeholder { text-align: center; color: var(--dark-gray); font-style: italic; padding: 20px; background-color: var(--light-gray); border-radius: var(--border-radius); margin-top: 1em;}
        #bottom-area { margin-top: 30px; padding-top: 15px; border-top: 1px solid var(--medium-gray); min-height: 30px; }
        #preview-exit-button-inline { display: none; position: fixed; top: 15px; right: 15px; background-color: var(--danger-color-dark); color: white; padding: 8px 15px; font-size: 0.9rem; font-weight: var(--normal-font-weight); border: none; border-radius: var(--border-radius); cursor: pointer; z-index: 1001; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.3s ease; font-family: inherit; }
        #preview-exit-button-inline:hover { background-color: #b91c1c; box-shadow: 0 4px 10px rgba(185, 28, 28, 0.3); transform: translateY(-1px); }
        #preview-exit-button-inline:active { transform: translateY(0px); box-shadow: 0 2px 5px rgba(185, 28, 28, 0.2); }
        #preview-exit-button-inline i { margin-right: 6px; }
        .explanation-box { display: none; background-color: var(--light-gray); border: 1px solid var(--medium-gray); border-left: 5px solid var(--app-primary-color); padding: 15px; margin: 1em 0 2em 0; border-radius: var(--border-radius); font-size: 0.9em; color: var(--dark-gray); }
        .explanation-box h4 { margin-top: 0; color: var(--app-primary-color); font-family: inherit; font-weight: var(--normal-font-weight); }
        .explanation-box p { margin-bottom: 0.5em; }
        .explanation-box ul { margin-top: 0.5em; padding-left: 20px; }
        
        body.pdf-preview-active .app-sidebar,
        body.pdf-preview-active #top-controls,
        body.pdf-preview-active #patient-data-container, 
        body.pdf-preview-active #selected-patient-tests-container, 
        body.pdf-preview-active #input-section-container,
        body.pdf-preview-active #save-data-button-container,
        body.pdf-preview-active #bottom-area,
        body.pdf-preview-active .sidebar-social-links,
        body.pdf-preview-active #loggedInUserContainer, 
        body.pdf-preview-active .sidebar-buttons
        {
            display: none !important;
        }
        body.pdf-preview-active .app-main-content {
            margin-left: 0 !important;
            padding: 15px !important; 
            height: auto !important;
            overflow: visible !important;
        }
        body.pdf-preview-active .content-container {
            max-width: 100% !important; 
        }
         body.pdf-preview-active .explanation-box {
            display: block !important; 
        }


        @media (max-width: 992px) { :root { --sidebar-width: 70px; } .app-main-content { margin-left: calc(var(--sidebar-width) + var(--main-content-margin)); padding: 25px 30px; } .app-sidebar { padding: 20px 10px; top: 0; height: 100vh; } .app-sidebar .sidebar-logo-placeholder { height: 40px; margin-bottom: 40px; font-size: 1.3rem; } .app-sidebar .button-text { display: none; } .app-sidebar button, .app-sidebar a button { justify-content: center; padding: 10px 0; gap: 0; font-size: 0.85rem; } .app-sidebar button i { width: auto; margin: 0; } .sidebar-social-links { display: none; } .position-row { flex-direction: column; align-items: stretch; } .asymmetry-graph-container, .normative-graph-container { flex: none; width: 100%; min-width: unset; } .position-box, .normative-box { height: auto; min-height: unset; } #patient-data-grid { /*grid-template-columns: 1fr;*/ } #input-section-container { flex-direction: column; } .input-position-box { min-width: unset; } body.pdf-preview-active .app-main-content { padding: 15px 30px; } body.pdf-preview-active .position-row { align-items: stretch; } body.pdf-preview-active .position-box, body.pdf-preview-active .normative-box { height: auto; min-height: unset; } }
        @media (max-width: 768px) { .app-layout { flex-direction: column; min-height: 100vh; } .app-sidebar { width: 100%; height: auto; position: relative; top: 0; flex-direction: row; flex-wrap: wrap; justify-content: center; padding: 10px; /* box-shadow: 0 2px 5px rgba(0,0,0,0.1); */ border-bottom: 1px solid var(--sidebar-border-color); border-right: none; z-index: 5; overflow-y: visible; } .sidebar-logo-placeholder { display: none; } .sidebar-buttons { flex-direction: row; flex-wrap: wrap; justify-content: center; width: 100%; flex-grow: 0; } .app-sidebar button, .app-sidebar a button { width: auto; flex-grow: 1; max-width: 180px; justify-content: center; font-size: 0.85rem; font-weight: var(--normal-font-weight); padding: 8px 10px; margin: 5px; gap: 8px; } .app-sidebar .button-text { display: inline-block; } .app-sidebar button i { width: auto; margin-right: 5px; } .sidebar-social-links { display: block; width: 100%; margin-top: 10px; padding-top: 0; border-top: none; text-align: center; } .sidebar-social-links a { margin: 0 10px; font-size: 1.1rem; } .app-main-content { margin-left: 0; padding: 20px 15px; height: auto; } h1 { font-size: 1.6rem; font-weight: var(--normal-font-weight);} h2 { font-size: 1.3rem; font-weight: var(--normal-font-weight);} h3.position-title, h3.normative-title { font-size: 1.0rem; font-weight: var(--normal-font-weight);} #top-controls { flex-direction: column; align-items: stretch; gap: 10px; margin-bottom: 15px; padding-bottom: 10px;} .control-item { justify-content: space-between; } .input-row { flex-direction: column; align-items: flex-start; gap: 5px; } .input-row label { flex-basis: auto; width: 100%; text-align: left; margin-bottom: 3px;} .input-row .input-wrapper { flex-basis: auto; width: 100%; justify-content: flex-start; } .input-row input { width: auto; font-size: 1.2rem; font-weight: var(--normal-font-weight); } .input-row input::placeholder { font-size: 0.8rem; font-weight: var(--normal-font-weight);} .unit-text { margin-left: 8px; } .position-box, .normative-box { padding: 10px; margin-bottom: 0;} #preview-exit-button-inline { top: 10px; right: 10px; font-size: 0.8rem; padding: 6px 10px; } body.pdf-preview-active .app-main-content { padding: 10px 15px; } }
        @media (max-width: 480px) { h1 { font-size: 1.4rem; font-weight: var(--normal-font-weight);} h2 { font-size: 1.1rem; font-weight: var(--normal-font-weight);} .app-sidebar button, .app-sidebar a button { font-size: 0.8rem; padding: 6px 8px; max-width: 150px; font-weight: var(--normal-font-weight);} }
        
        @media print { 
            body { background-color: white !important; color: black !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; font-size: 9pt !important; padding: 0 !important; display: block !important; font-weight: normal !important;} 
            .app-sidebar, 
            #top-controls, 
            #patient-data-container, 
            #selected-patient-tests-container,
            #input-section-container, 
            #save-data-button-container,
            #canvas-container, 
            #bottom-area, 
            .print-instruction, 
            #preview-exit-button-inline,
            .sidebar-social-links,
            #loggedInUserContainer,
            .sidebar-buttons
             { 
                display: none !important; 
            } 
            .app-layout { display: block !important; } 
            .app-main-content { margin: 0 !important; padding: 5mm !important; width: 100% !important; max-width: 100% !important; box-shadow: none !important; border: none !important; height: auto !important; overflow: visible !important; } 
            .content-container { margin: 0 !important; padding: 0 !important; max-width: 100% !important; } 
            .explanation-box { display: block !important; margin: 10mm 0 !important; border-left-color: black !important; } 
            h1 { font-size: 16pt !important; margin-bottom: 5mm !important; text-align: center !important; display: block !important; color: black !important; font-weight: normal !important; } 
            h2 { display: block !important; font-size: 12pt !important; margin-top: 8mm; margin-bottom: 4mm; border: none !important; color: black !important; font-weight: normal !important; } 
            h3 { font-size: 10pt !important; margin-bottom: 3mm !important; color: black !important; font-weight: normal !important; } 
            #report-content { padding: 0 !important; } 
            .position-row { display: block !important; width: 100% !important; page-break-inside: avoid !important; border: none !important; margin-bottom: 5mm !important; padding: 0 !important;} 
            .asymmetry-graph-container, .normative-graph-container { width: 100% !important; display: block !important; margin-bottom: 5mm; page-break-inside: avoid !important; padding: 0 !important; } 
            .position-box, .normative-box { box-shadow: none !important; border: 1px solid #ccc !important; margin-bottom: 3mm; height: auto !important; min-height: unset !important; padding: 5px !important; page-break-inside: avoid !important; background-color: var(--white) !important; } 
            .position-box.green-box { box-shadow: none !important; border: 1px solid #ccc !important; } 
            .position-box::after { display: none !important; } 
            .js-plotly-plot { width: 100% !important; height: auto !important; } 
            .plotly .scatterlayer .trace.fill { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } 
            .plotly .annotation text, .plotly .annotation .norm-label, .plotly .annotation .left-label, .plotly .annotation .right-label, .plotly .annotation .value-display, .plotly .annotation .nkg-combined-text span, .plotly .annotation .asymmetry-percent { fill: black !important; color: black !important; font-weight: normal !important; } 
            .plotly .annotation .norm-value { font-weight: normal !important; } 
            .plotly .gtitle { fill: black !important; font-weight: normal !important; } 
            .plotly .axistitle { fill: black !important; font-size: 9pt !important; font-weight: normal !important; } 
            .plotly .tick text { fill: black !important; font-size: 8pt !important; font-weight: normal !important; } 
            .plotly .legend { display: none !important; } 
            .plotly .modebar { display: none !important; } 
            #bar-chart-I, #bar-chart-Y, #bar-chart-T { height: 180px !important; } 
            #normative-chart-I, #normative-chart-Y, #normative-chart-T { height: 180px !important; } 
        }
    </style>
</head>
<body>
    <div id="appLoadingMessage" class="loading-message">Authenticating... Please wait.</div>
    <div id="appStatusMessage" class="status-message"></div>

    <div class="app-layout">
        <aside class="app-sidebar">
            <div class="sidebar-logo-placeholder"><i class="fas fa-bars"></i></div> 
            <div class="sidebar-buttons">
                <a href="assets/analysis.html" id="analysis-link-button"><button type="button" id="view-analysis-button"><i class="fas fa-history"></i> <span class="button-text">Patient History</span></button></a>
                <button id="pdf-preview-button"><i class="fas fa-file-pdf"></i><span class="button-text">PDF Preview</span></button>
                <button id="export-excel-button"><i class="fas fa-file-excel"></i><span class="button-text">Export Data</span></button>
                <button id="clear-all-button"><i class="fas fa-eraser"></i><span class="button-text">Clear All</span></button>
            </div>
            <div id="loggedInUserContainer" class="sidebar-user-info">
                <div class="user-details">
                    <i class="fas fa-user-circle"></i>
                    <span id="loggedInUserName">Loading user...</span>
                    <span id="loggedInUserEmailDisplay"></span>
                </div>
                <button id="logout-button"><i class="fas fa-sign-out-alt"></i><span class="button-text">Logout</span></button>
            </div>
            <div class="sidebar-social-links">
                <a href="https://www.instagram.com/alphatekofficial" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="https://www.alphatek.no" target="_blank" title="Website"><i class="fas fa-globe"></i></a>
                <a href="#" title="Info/Help"><i class="fas fa-circle-info"></i></a>
            </div>
        </aside>
        <main class="app-main-content">
            <button id="preview-exit-button-inline"><i class="fas fa-times-circle"></i> Exit Preview</button>
            <div class="content-container">
                <div id="report-content">
                    <h1>Functional Shoulder Screening</h1>
                    <h2 id="patient-details-title">Patient Details</h2>
                    <div id="top-controls">
                        <div class="control-item"><label class="control-label" for="injured-side-radio">Injured Side:</label><select id="injured-side-radio"><option value="Left">Left</option><option value="Right">Right</option></select></div>
                        <div class="control-item"><label class="control-label" for="bodyweight-input">Bodyweight (kg):</label><input id="bodyweight-input" type="number" placeholder="kg"></div>
                    </div>
                    <div class="explanation-box"><h4>About This Report</h4> <p>This report summarizes the results of the Functional Shoulder Screening using the ASH test (Positions I, Y, T).</p><ul> <li><strong>Asymmetry Graphs:</strong> Show the percentage difference between the injured and uninjured side for key metrics (Max Force, RFD, % Max Force at 100ms). Values closer to 100% indicate better symmetry. Annotations above the bars show the percentage difference relative to the uninjured side (100%). Numbers inside the bars show the absolute values for each side.</li> <li><strong>Normative Graphs:</strong> Visually represent the estimated percentile rank for Max Force / Bodyweight (N/kg) for each side, based on normative thresholds. Background colors indicate performance zones (Poor, Average, Good, Excellent). Vertical dashed lines show the estimated percentile for the Left (Orange) and Right (Blue) values.</li> </ul><p><i>To save as PDF: Click 'PDF Preview', then use your browser's Print function (Ctrl+P or Cmd+P) and select 'Save as PDF'. Click 'Exit Preview' to return.</i></p></div>
                    
                    <div id="patient-data-container"> <div id="patient-data-grid">
                            <div class="patient-data-item">
                                <label for="fp-nr-input">Patient ID:</label>
                                <input id="fp-nr-input" type="text" placeholder="Enter or select Patient ID" list="existing-patient-ids">
                                <datalist id="existing-patient-ids"></datalist>
                            </div>
                            <div class="patient-data-item"><label for="age-input">Age:</label><input id="age-input" type="number" placeholder="Years"></div>
                            <div class="patient-data-item"><label for="gender-select">Gender:</label><select id="gender-select"><option value="">Select...</option><option value="Male">Male</option><option value="Female">Female</option><option value="Other">Other</option><option value="Prefer not to say">Prefer not to say</option></select></div>
                            <div class="patient-data-item"><label for="sport-input">Sport:</label><input id="sport-input" type="text" placeholder="Main Sport"></div>
                            <div class="patient-data-item"><label for="injury-input">Injury (Optional):</label><input id="injury-input" type="text" placeholder="e.g., Rotator Cuff Tear"></div>
                        </div>
                    </div> 
    
                    <div id="selected-patient-tests-container" style="display: none;"> 
                        <h3 id="selected-patient-tests-title-new">Saved Tests for Patient: <span id="current-patient-for-tests"></span></h3>
                        <ul id="selected-patient-tests-list"></ul>
                    </div>
    
                    <h2 id="input-title">Input Overview</h2>
                    <div id="input-section-container">
                        <div class="input-position-box"><h4>ASH Test Position I</h4><div class="input-row"> <label>Max Force</label> <div class="input-wrapper"> <input id="non-injured-max-force-i" type="number" class="number-input" placeholder="Non-Injured"> <span class="unit-text">- N</span> </div> </div><div class="input-row"> <label>RFD 100ms</label> <div class="input-wrapper"> <input id="non-injured-rfd-i" type="number" class="number-input" placeholder="Non-Injured"> <span class="unit-text">- Ns<sup>-1</sup></span> </div> </div><div class="input-row"> <label>Max Force</label> <div class="input-wrapper"> <input id="injured-max-force-i" type="number" class="number-input" placeholder="Injured"> <span class="unit-text">- N</span> </div> </div><div class="input-row"> <label>RFD 100ms</label> <div class="input-wrapper"> <input id="injured-rfd-i" type="number" class="number-input" placeholder="Injured"> <span class="unit-text">- Ns<sup>-1</sup></span> </div> </div></div>
                        <div class="input-position-box"><h4>ASH Test Position Y</h4><div class="input-row"> <label>Max Force</label> <div class="input-wrapper"><input id="non-injured-max-force-y" type="number" class="number-input" placeholder="Non-Injured"> <span class="unit-text">- N</span></div> </div><div class="input-row"> <label>RFD 100ms</label> <div class="input-wrapper"><input id="non-injured-rfd-y" type="number" class="number-input" placeholder="Non-Injured"> <span class="unit-text">- Ns<sup>-1</sup></span></div> </div><div class="input-row"> <label>Max Force</label> <div class="input-wrapper"><input id="injured-max-force-y" type="number" class="number-input" placeholder="Injured"> <span class="unit-text">- N</span></div> </div><div class="input-row"> <label>RFD 100ms</label> <div class="input-wrapper"><input id="injured-rfd-y" type="number" class="number-input" placeholder="Injured"> <span class="unit-text">- Ns<sup>-1</sup></span></div> </div></div>
                        <div class="input-position-box"><h4>ASH Test Position T</h4><div class="input-row"> <label>Max Force</label> <div class="input-wrapper"><input id="non-injured-max-force-t" type="number" class="number-input" placeholder="Non-Injured"> <span class="unit-text">- N</span></div> </div><div class="input-row"> <label>RFD 100ms</label> <div class="input-wrapper"><input id="non-injured-rfd-t" type="number" class="number-input" placeholder="Non-Injured"> <span class="unit-text">- Ns<sup>-1</sup></span></div> </div><div class="input-row"> <label>Max Force</label> <div class="input-wrapper"><input id="injured-max-force-t" type="number" class="number-input" placeholder="Injured"> <span class="unit-text">- N</span></div> </div><div class="input-row"> <label>RFD 100ms</label> <div class="input-wrapper"><input id="injured-rfd-t" type="number" class="number-input" placeholder="Injured"> <span class="unit-text">- Ns<sup>-1</sup></span></div> </div></div>
                    </div>
                    <div id="save-data-button-container">
                        <button id="save-data-button-main"><i class="fas fa-save"></i> Save Screening Data</button>
                    </div>
                    
                    <h2 id="results-title">Results</h2>
                    <div class="position-row"> <div class="asymmetry-graph-container"> <div id="position-box-I" class="position-box"> <h3 class="position-title">Position I - Asymmetry</h3> <div id="bar-chart-I" class="js-plotly-plot"></div> </div> </div> <div class="normative-graph-container"> <div id="normative-chart-container-I" class="normative-box"> <h3 class="normative-title">Position I - Normative Comparison</h3> <div id="normative-chart-I" class="js-plotly-plot"></div> </div> </div> </div>
                    <div class="position-row"> <div class="asymmetry-graph-container"> <div id="position-box-Y" class="position-box"> <h3 class="position-title">Position Y - Asymmetry</h3> <div id="bar-chart-Y" class="js-plotly-plot"></div> </div> </div> <div class="normative-graph-container"> <div id="normative-chart-container-Y" class="normative-box"> <h3 class="normative-title">Position Y - Normative Comparison</h3> <div id="normative-chart-Y" class="js-plotly-plot"></div> </div> </div> </div>
                    <div class="position-row"> <div class="asymmetry-graph-container"> <div id="position-box-T" class="position-box"> <h3 class="position-title">Position T - Asymmetry</h3> <div id="bar-chart-T" class="js-plotly-plot"></div> </div> </div> <div class="normative-graph-container"> <div id="normative-chart-container-T" class="normative-box"> <h3 class="normative-title">Position T - Normative Comparison</h3> <div id="normative-chart-T" class="js-plotly-plot"></div> </div> </div> </div>
                    <div id="normative-placeholder" style="display: none;"> Enter bodyweight to see normative comparisons. </div>
                    <div id="bottom-area"></div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, orderBy, doc, getDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Config & Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyDhEihuoWm4c5MSOHrSqkkzca7tn86roq4", 
            authDomain: "pwr-analytics.firebaseapp.com",
            projectId: "pwr-analytics",
            storageBucket: "pwr-analytics.appspot.com",
            messagingSenderId: "9839468523",
            appId: "1:9839468523:web:1d994de254b2a24d91c3ae",
            measurementId: "G-N35HQ5CMD5"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const loginPageUrl = 'index.html';

        // --- UI Element References ---
        const appLayout = document.querySelector('.app-layout');
        const appLoadingMessage = document.getElementById('appLoadingMessage');
        const appStatusMessage = document.getElementById('appStatusMessage');
        const loggedInUserNameSpan = document.getElementById('loggedInUserName');
        const loggedInUserEmailDisplaySpan = document.getElementById('loggedInUserEmailDisplay');

        const plotlyConfig = {
            displaylogo: false,
            modeBarButtonsToRemove: ['sendDataToCloud', 'lasso2d', 'select2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'resetScale2d', 'hoverClosestCartesian', 'hoverCompareCartesian'],
            modeBarButtonsToAdd: [{
                name: 'Download plot as PNG',
                icon: Plotly.Icons.camera,
                click: function(gd) {
                    const titleText = (gd.layout.title?.text || 'plot').replace(/<br>/g, ' ');
                    Plotly.downloadImage(gd, { format: 'png', width: gd._fullLayout.width, height: gd._fullLayout.height, filename: titleText });
                }
            }]
        };
        const normativeThresholds = {
            'I': { poor_max: 1.47, average_mid: 1.65, good_min: 1.85, excellent_min: 2.1 },
            'Y': { poor_max: 1.25, average_mid: 1.4,  good_min: 1.6,  excellent_min: 1.76 },
            'T': { poor_max: 1.15, average_mid: 1.25, good_min: 1.4,  excellent_min: 1.58 }
        };
        const percentileZones = { poor: 30, average: 70, good: 90, excellent: 100 };
        const percentileMidpoint = 50;
        const normZoneColors = {
            poor: getComputedStyle(document.documentElement).getPropertyValue('--norm-poor-bg').trim() || 'rgba(252, 165, 165, 0.5)',
            average: getComputedStyle(document.documentElement).getPropertyValue('--norm-average-bg').trim() || 'rgba(252, 211, 77, 0.5)',
            good: getComputedStyle(document.documentElement).getPropertyValue('--norm-good-bg').trim() || 'rgba(167, 243, 208, 0.5)',
            excellent: getComputedStyle(document.documentElement).getPropertyValue('--norm-excellent-bg').trim() || 'rgba(52, 211, 153, 0.5)'
        };
        const normativeLabels = { poor: 'Poor', average: 'Average', good: 'Good', excellent: 'Excellent' };
        const asymmetryChartDivs = ['bar-chart-I', 'bar-chart-Y', 'bar-chart-T'];
        const asymmetryPositionBoxDivs = ['position-box-I', 'position-box-Y', 'position-box-T'];
        const normativeChartDivs = ['normative-chart-I', 'normative-chart-Y', 'normative-chart-T'];
        const normativePlaceholder = document.getElementById('normative-placeholder');

        const injuredSideRadio = document.getElementById('injured-side-radio');
        const bodyweightInput = document.getElementById('bodyweight-input');
        // const registerPatientButton = document.getElementById('register-patient-button'); // Fjernet
        const saveDataButton = document.getElementById('save-data-button-main');
        const pdfPreviewButton = document.getElementById('pdf-preview-button');
        const exportExcelButton = document.getElementById('export-excel-button');
        const clearAllButton = document.getElementById('clear-all-button');
        const logoutButton = document.getElementById('logout-button');
        const previewExitButtonInline = document.getElementById('preview-exit-button-inline');
        const explanationBox = document.querySelector('.explanation-box');
        const patientDataContainer = document.getElementById('patient-data-container');
        const fpNrInput = document.getElementById('fp-nr-input');
        const ageInput = document.getElementById('age-input');
        const genderSelect = document.getElementById('gender-select');
        const sportInput = document.getElementById('sport-input');
        const injuryInput = document.getElementById('injury-input');
        const inputFieldMap = {
            'I': { nonInjured: [document.getElementById('non-injured-max-force-i'), document.getElementById('non-injured-rfd-i')], injured: [document.getElementById('injured-max-force-i'), document.getElementById('injured-rfd-i')] },
            'Y': { nonInjured: [document.getElementById('non-injured-max-force-y'), document.getElementById('non-injured-rfd-y')], injured: [document.getElementById('injured-max-force-y'), document.getElementById('injured-rfd-y')] },
            'T': { nonInjured: [document.getElementById('non-injured-max-force-t'), document.getElementById('non-injured-rfd-t')], injured: [document.getElementById('injured-max-force-t'), document.getElementById('injured-rfd-t')] }
        };
        const allNumberInputs = Array.from(document.querySelectorAll('#input-section-container input[type="number"]'));
        
        const existingPatientIdsDatalist = document.getElementById('existing-patient-ids');
        const selectedPatientTestsContainer = document.getElementById('selected-patient-tests-container'); 
        const selectedPatientTestsListUL = document.getElementById('selected-patient-tests-list');
        const currentPatientForTestsSpan = document.getElementById('current-patient-for-tests');


        // --- Utility Functions ---
        function showStatusMessage(message, type = 'info', duration = 3000) {
            if (!appStatusMessage) return;
            appStatusMessage.textContent = message;
            appStatusMessage.className = `status-message ${type}`;
            appStatusMessage.style.display = 'block';
            setTimeout(() => {
                appStatusMessage.style.display = 'none';
            }, duration);
        }
        function hexToRgba(hex, alpha) { hex = hex.replace('#', ''); const r = parseInt(hex.substring(0, 2), 16); const g = parseInt(hex.substring(2, 4), 16); const b = parseInt(hex.substring(4, 6), 16); return `rgba(${r}, ${g}, ${b}, ${alpha})`; }
        function createEmptyPlot(targetDivId, title = 'Enter Data', height = 300, topMargin = 20) { const targetDiv = document.getElementById(targetDivId); if (!targetDiv) { return; } try { Plotly.react(targetDiv, [{ x: [], y: [], type: 'bar' }], { title: { text: title, font: { family: 'Avenir, sans-serif', size: 16, color: getComputedStyle(document.documentElement).getPropertyValue('--app-primary-color').trim(), weight: 400 } }, height: height, margin: { l: 60, r: 40, b: 40, t: topMargin, pad: 4 }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', xaxis: { visible: false }, yaxis: { showgrid: false, zeroline: true, gridcolor: getComputedStyle(document.documentElement).getPropertyValue('--medium-gray').trim(), showticklabels: false }, font: { family: 'Avenir, sans-serif', size: 12, weight: 400 } }, plotlyConfig); } catch (error) { console.error(`Error creating empty plot in ${targetDivId}:`, error); targetDiv.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">Error displaying chart.</p>`; } }
        function processInputAndCalculate(position) { const inputs = inputFieldMap[position]; if (!inputs) return null; const nonInjuredMaxForceVal = inputs.nonInjured[0].value; const nonInjuredRfdVal = inputs.nonInjured[1].value; const injuredMaxForceVal = inputs.injured[0].value; const injuredRfdVal = inputs.injured[1].value; if (nonInjuredMaxForceVal === '' && nonInjuredRfdVal === '' && injuredMaxForceVal === '' && injuredRfdVal === '') return null; const nonInjuredMaxForce = parseFloat(nonInjuredMaxForceVal) || 0; const nonInjuredRfd = parseFloat(nonInjuredRfdVal) || 0; const injuredMaxForce = parseFloat(injuredMaxForceVal) || 0; const injuredRfd = parseFloat(injuredRfdVal) || 0; const selectedInjuredSide = injuredSideRadio.value; let leftData = {}; let rightData = {}; if (selectedInjuredSide === 'Left') { leftData = { max_force: injuredMaxForce, rfd: injuredRfd }; rightData = { max_force: nonInjuredMaxForce, rfd: nonInjuredRfd }; } else { leftData = { max_force: nonInjuredMaxForce, rfd: nonInjuredRfd }; rightData = { max_force: injuredMaxForce, rfd: injuredRfd }; } return { left: leftData, right: rightData }; }
        function createAsymmetryChart(positionData, injuredSide, posLabel) { if (!positionData?.left || !positionData?.right) return [{}, false]; const leftDataRaw = positionData.left; const rightDataRaw = positionData.right; const leftPctMaxAt100ms = leftDataRaw.max_force !== 0 ? (leftDataRaw.rfd * 0.1 / leftDataRaw.max_force) * 100 : 0; const rightPctMaxAt100ms = rightDataRaw.max_force !== 0 ? (rightDataRaw.rfd * 0.1 / rightDataRaw.max_force) * 100 : 0; const leftData = [leftDataRaw.max_force, leftDataRaw.rfd, leftPctMaxAt100ms]; const rightData = [rightDataRaw.max_force, rightDataRaw.rfd, rightPctMaxAt100ms]; const baseData = injuredSide === 'Right' ? leftData : rightData; const metricNames = [ 'Max Force (N)', 'RFD 100ms (Ns⁻¹)', '% Max @ 100ms (%)' ]; const barDataRatios = {}; const leftTextsAbsolute = []; const rightTextsAbsolute = []; metricNames.forEach((metricName, index) => { let leftValue = leftData[index]; let rightValue = rightData[index]; let baseValue = baseData[index]; const leftRatio = baseValue !== 0 ? (leftValue / baseValue) * 100 : (leftValue === 0 ? 100 : Infinity); const rightRatio = baseValue !== 0 ? (rightValue / baseValue) * 100 : (rightValue === 0 ? 100 : Infinity); barDataRatios[metricName] = [rightRatio, leftRatio]; const decimals = metricName.includes('% Max @ 100ms') ? 1 : 0; leftTextsAbsolute.push(leftValue.toFixed(decimals)); rightTextsAbsolute.push(rightValue.toFixed(decimals)); }); const plotX = metricNames; const plotYLeft = plotX.map(name => barDataRatios[name][1]); const plotYRight = plotX.map(name => barDataRatios[name][0]); if (plotX.length !== 3 || plotYLeft.length !== 3 || plotYRight.length !== 3) return [{}, false]; const leftColorHex = getComputedStyle(document.documentElement).getPropertyValue('--left-line-color').trim(); const rightColorHex = getComputedStyle(document.documentElement).getPropertyValue('--right-line-color').trim(); const leftColorRgba = hexToRgba(leftColorHex, 0.8); const rightColorRgba = hexToRgba(rightColorHex, 0.8); const thresholdLineColor = getComputedStyle(document.documentElement).getPropertyValue('--dark-gray').trim(); const darkGrayColor = getComputedStyle(document.documentElement).getPropertyValue('--dark-gray').trim(); const whiteColor = getComputedStyle(document.documentElement).getPropertyValue('--white').trim(); const validRatios = plotYLeft.concat(plotYRight).filter(isFinite); const maxYValue = validRatios.length > 0 ? Math.max(110, ...validRatios) : 110; const annotationYTop = maxYValue + 8; const yAxisUpperBound = annotationYTop + 15; const fig = { data: [ { type: 'bar', name: 'Left', x: plotX, y: plotYLeft, marker: { color: leftColorRgba }, text: leftTextsAbsolute, texttemplate: '%{text}', textposition: 'none', hoverinfo: 'x+name', hovertemplate: 'Left: %{y:.0f}%<extra></extra>' }, { type: 'bar', name: 'Right', x: plotX, y: plotYRight, marker: { color: rightColorRgba }, text: rightTextsAbsolute, texttemplate: '%{text}', textposition: 'none', hoverinfo: 'x+name', hovertemplate: 'Right: %{y:.0f}%<extra></extra>' }, { x: [null], y: [null], mode: 'lines', name: '±10% Thresholds', line: { color: thresholdLineColor, width: 1, dash: 'dash' }, hoverinfo: 'none', showlegend: true } ], layout: { height: 300, barmode: 'group', font: { color: darkGrayColor, family: 'Avenir, sans-serif', size: 12, weight: 400 }, yaxis: { title: "Injured Side Asymmetry (%)", titlefont: { size: 13, family: 'Avenir, sans-serif', weight: 400, color: darkGrayColor }, tickfont: { size: 11, family: 'Avenir, sans-serif', weight: 400, color: darkGrayColor }, range: [18, yAxisUpperBound], tickmode: 'array', tickvals: [50, 100], showgrid: false, zeroline: false, }, xaxis: { showgrid: false, zeroline: false, showline: false, showticklabels: true, tickangle: 0, tickfont: { size: 11, family: 'Avenir, sans-serif', weight: 400, color: darkGrayColor }, automargin: true, fixedrange: true }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', legend: { orientation: "h", yanchor: "bottom", y: -0.30, xanchor: "center", x: 0.5, font: { size: 12, family: 'Avenir, sans-serif', weight: 400, color: darkGrayColor } }, margin: { l: 70, r: 30, b: 85, t: 20, pad: 10 }, shapes: [ { type: "line", xref: "paper", x0: 0, x1: 1, yref: "y", y0: 90, y1: 90, line: { color: thresholdLineColor, width: 1, dash: "dash" }, layer: "below" }, { type: "line", xref: "paper", x0: 0, x1: 1, yref: "y", y0: 110, y1: 110, line: { color: thresholdLineColor, width: 1, dash: "dash" }, layer: "below" } ], annotations: [] } }; let allGreen = true; const metricsNamesForAnnotation = plotX; for (let i = 0; i < metricsNamesForAnnotation.length; i++) { const metricName = metricsNamesForAnnotation[i]; const injuredRatio = injuredSide === 'Right' ? plotYRight[i] : plotYLeft[i]; const leftRatio = plotYLeft[i]; const rightRatio = plotYRight[i]; if (!isFinite(injuredRatio)) { fig.layout.annotations.push({ x: metricName, y: annotationYTop, text: "N/A", showarrow: false, font: { color: 'grey', size: 22, family: 'Avenir, sans-serif', weight: 400 }, xanchor: 'center', yanchor: 'bottom' }); allGreen = false; } else { const percentageDiff = injuredRatio - 100; let color; if (percentageDiff >= -10) { color = '#2a9d8f'; } else { allGreen = false; if (percentageDiff >= -15) { color = '#ee9b00'; } else if (percentageDiff >= -20) { color = '#e85d04'; } else { color = '#ae2012'; } } fig.layout.annotations.push({ x: metricName, y: annotationYTop, text: `${percentageDiff.toFixed(0)}%`, showarrow: false, font: { color: color, size: 22, family: 'Avenir, sans-serif', weight: 400 }, xanchor: 'center', yanchor: 'bottom' }); } const barTextYPosition = 31; const barTextFontSize = 17; const categoryIndex = i; const numberOfBars = 2; const groupWidth = 0.8; const barWidthFraction = groupWidth / numberOfBars; const leftBarCenter = categoryIndex - (groupWidth / 2) + (barWidthFraction / 2); const rightBarCenter = categoryIndex + (groupWidth / 2) - (barWidthFraction / 2); if (leftRatio > barTextYPosition + (barTextFontSize / 2)) { fig.layout.annotations.push({ x: leftBarCenter, y: barTextYPosition, xref: 'x', yref: 'y', text: leftTextsAbsolute[i], showarrow: false, font: { color: whiteColor, size: barTextFontSize, family: 'Avenir, sans-serif', weight: 400 }, xanchor: 'center', yanchor: 'middle' }); } if (rightRatio > barTextYPosition + (barTextFontSize / 2)) { fig.layout.annotations.push({ x: rightBarCenter, y: barTextYPosition, xref: 'x', yref: 'y', text: rightTextsAbsolute[i], showarrow: false, font: { color: whiteColor, size: barTextFontSize, family: 'Avenir, sans-serif', weight: 400 }, xanchor: 'center', yanchor: 'middle' }); } } return [fig, allGreen]; }
        function mapNkgToPercentile(nkgValue, positionLabel) { const thresholds = normativeThresholds[positionLabel]; if (!thresholds || typeof nkgValue !== 'number' || !isFinite(nkgValue)) return 0; const pMap = [ { v: 0.5, p: 0 }, { v: thresholds.poor_max, p: percentileZones.poor }, { v: thresholds.average_mid, p: percentileMidpoint }, { v: thresholds.good_min, p: percentileZones.average }, { v: thresholds.excellent_min, p: percentileZones.good }, { v: thresholds.excellent_min * 1.25, p: percentileZones.excellent } ]; const minVal = pMap[0].v; const maxVal = pMap[pMap.length - 1].v; const clampedValue = Math.max(minVal, Math.min(nkgValue, maxVal)); let lowerPoint = pMap[0]; let upperPoint = pMap[pMap.length - 1]; for (let i = 0; i < pMap.length - 1; i++) { if (clampedValue === pMap[i].v) { lowerPoint = upperPoint = pMap[i]; break; } if (clampedValue > pMap[i].v && clampedValue <= pMap[i + 1].v) { lowerPoint = pMap[i]; upperPoint = pMap[i + 1]; break; } } if (clampedValue === upperPoint.v) { lowerPoint = upperPoint; } let percentile = lowerPoint.p; const valueRange = upperPoint.v - lowerPoint.v; const percentileRange = upperPoint.p - lowerPoint.p; if (valueRange > 0) { percentile += ((clampedValue - lowerPoint.v) / valueRange) * percentileRange; } return Math.max(0, Math.min(percentile, 100)); }
        function createNormativeComparisonChart(positionData, bodyweight, positionLabel) { const bwVal = parseFloat(bodyweight); if (isNaN(bwVal) || bwVal <= 0 || !positionData) return {}; const leftNkg = positionData.left.max_force / bwVal; const rightNkg = positionData.right.max_force / bwVal; const thresholds = normativeThresholds[positionLabel]; if (!thresholds) return {}; const leftPercentile = mapNkgToPercentile(leftNkg, positionLabel); const rightPercentile = mapNkgToPercentile(rightNkg, positionLabel); const baseCurveX = []; const baseCurveY = []; const mean = 55; const stdDev = 22; const amplitude = 0.9; for (let i = 0; i <= 100; i += 0.5) { baseCurveX.push(i); const y = amplitude * Math.exp(-Math.pow(i - mean, 2) / (2 * Math.pow(stdDev, 2))); baseCurveY.push(y); } const zoneBoundaries = [0, percentileZones.poor, percentileZones.average, percentileZones.good, percentileZones.excellent]; const traces = []; const zoneColorsList = [normZoneColors.poor, normZoneColors.average, normZoneColors.good, normZoneColors.excellent]; for (let i = 0; i < zoneBoundaries.length - 1; i++) { const x0 = zoneBoundaries[i]; const x1 = zoneBoundaries[i+1]; const zoneFillColor = zoneColorsList[i]; const segmentX = [x0]; const segmentY = [0]; for(let j=0; j < baseCurveX.length; j++) { if (baseCurveX[j] >= x0 && baseCurveX[j] <= x1) { segmentX.push(baseCurveX[j]); segmentY.push(baseCurveY[j]); } } segmentX.push(x1); segmentY.push(0); traces.push({ x: segmentX, y: segmentY, type: 'scatter', mode: 'lines', line: { width: 0 }, fill: 'tozeroy', fillcolor: zoneFillColor, hoverinfo: 'none', name: Object.keys(normativeLabels)[i], showlegend: false }); } traces.push({ x: baseCurveX, y: baseCurveY, type: 'scatter', mode: 'lines', line: { color: '#ffffff', width: 1.5, shape: 'spline' }, hoverinfo: 'none', name: 'Distribution (Visual)', showlegend: false }); const layout = { height: 250, margin: { t: 35, b: 95, l: 30, r: 30 }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', xaxis: { title: '', range: [0, 100], showgrid: false, zeroline: false, showticklabels: false }, yaxis: { range: [0, 1.1], showgrid: false, zeroline: false, showticklabels: false, title: '' }, shapes: [], annotations: [], font: { family: 'Avenir, sans-serif', size: 11, weight: 400, color: getComputedStyle(document.documentElement).getPropertyValue('--dark-gray').trim() }, showlegend: false }; const thresholdAnnotations = [ { p: percentileZones.poor, val: thresholds.poor_max }, { p: percentileZones.average, val: thresholds.good_min }, { p: percentileZones.good, val: thresholds.excellent_min } ]; thresholdAnnotations.forEach(t => { layout.annotations.push({ xref: 'x', yref: 'paper', x: t.p, y: -0.08, text: `<span class="norm-value">${t.val.toFixed(2)}</span>`, showarrow: false, xanchor: 'center', yanchor: 'top', font: { family: 'Avenir, sans-serif', size: 10, weight: 400, color: getComputedStyle(document.documentElement).getPropertyValue('--app-primary-color').trim() } }); }); layout.shapes.push({ type: 'line', xref: 'x', yref: 'paper', x0: percentileMidpoint, x1: percentileMidpoint, y0: 0, y1: 1, line: { color: getComputedStyle(document.documentElement).getPropertyValue('--medium-gray').trim(), width: 1.5, dash: 'dot' }, layer: 'below' }); const avgValueForPos = thresholds.average_mid.toFixed(2); layout.annotations.push({ xref: 'x', yref: 'paper', x: percentileMidpoint, y: -0.08, text: `<span class="value-display">${avgValueForPos}</span>`, showarrow: false, xanchor: 'center', yanchor: 'top', font: { family: 'Avenir, sans-serif', size: 10, color: getComputedStyle(document.documentElement).getPropertyValue('--dark-gray').trim(), weight: 400 } }); const labelYPosition = 1.10; layout.annotations.push({ xref: 'x', yref: 'paper', x: 15, y: labelYPosition, text: `<span class="norm-label">${normativeLabels.poor}</span>`, showarrow: false, xanchor: 'center', yanchor: 'bottom', font: { family: 'Avenir, sans-serif', size: 11, weight: 400, color: getComputedStyle(document.documentElement).getPropertyValue('--dark-gray').trim() } }); layout.annotations.push({ xref: 'x', yref: 'paper', x: 50, y: labelYPosition, text: `<span class="norm-label">${normativeLabels.average}</span>`, showarrow: false, xanchor: 'center', yanchor: 'bottom', font: { family: 'Avenir, sans-serif', size: 11, weight: 400, color: getComputedStyle(document.documentElement).getPropertyValue('--dark-gray').trim() }, align: 'center' }); layout.annotations.push({ xref: 'x', yref: 'paper', x: 80, y: labelYPosition, text: `<span class="norm-label">${normativeLabels.good}</span>`, showarrow: false, xanchor: 'center', yanchor: 'bottom', font: { family: 'Avenir, sans-serif', size: 11, weight: 400, color: getComputedStyle(document.documentElement).getPropertyValue('--dark-gray').trim() } }); layout.annotations.push({ xref: 'x', yref: 'paper', x: 95, y: labelYPosition, text: `<span class="norm-label">${normativeLabels.excellent}</span>`, showarrow: false, xanchor: 'center', yanchor: 'bottom', font: { family: 'Avenir, sans-serif', size: 11, weight: 400, color: getComputedStyle(document.documentElement).getPropertyValue('--dark-gray').trim() } }); const leftColor = getComputedStyle(document.documentElement).getPropertyValue('--left-line-color').trim(); const rightColor = getComputedStyle(document.documentElement).getPropertyValue('--right-line-color').trim(); const lineY0 = 0.05; const lineY1 = 0.95; layout.shapes.push({ type: 'line', xref: 'x', yref: 'paper', x0: leftPercentile, x1: leftPercentile, y0: lineY0, y1: lineY1, line: { color: leftColor, width: 2, dash: 'dash' } }); layout.annotations.push({ xref: 'x', yref: 'paper', x: leftPercentile, y: 0.90, text: 'L', showarrow: true, ax: 0, ay: -15, arrowhead: 0, arrowwidth: 1, arrowcolor: leftColor, font: {color: leftColor, size: 14, family: 'Avenir, sans-serif', weight: 400} }); layout.shapes.push({ type: 'line', xref: 'x', yref: 'paper', x0: rightPercentile, x1: rightPercentile, y0: lineY0, y1: lineY1, line: { color: rightColor, width: 2, dash: 'dash' } }); layout.annotations.push({ xref: 'x', yref: 'paper', x: rightPercentile, y: 0.90, text: 'R', showarrow: true, ax: 0, ay: -15, arrowhead: 0, arrowwidth: 1, arrowcolor: rightColor, font: {color: rightColor, size: 14, family: 'Avenir, sans-serif', weight: 400} }); const combinedNkgText = `<span class='nkg-combined-text'>Left: <span class='left-label'>${leftNkg.toFixed(2)}</span> (Nkg<sup>-1</sup>) &nbsp;&nbsp;|&nbsp;&nbsp; Right: <span class='right-label'>${rightNkg.toFixed(2)}</span> (Nkg<sup>-1</sup>)</span>`; layout.annotations.push({ xref: 'paper', yref: 'paper', x: 0.5, y: -0.30, text: combinedNkgText, showarrow: false, xanchor: 'center', yanchor: 'top', align: 'center', font: { size: 15, color: getComputedStyle(document.documentElement).getPropertyValue('--dark-gray').trim(), family: 'Avenir, sans-serif', weight: 400 } }); return { data: traces, layout }; }
        function updateGraphsAndTable() { const injuredSide = injuredSideRadio.value; const bodyweight = bodyweightInput.value; const bwVal = parseFloat(bodyweight); const bodyweightValid = !isNaN(bwVal) && bwVal > 0; if (normativePlaceholder) { normativePlaceholder.style.display = bodyweightValid ? 'none' : 'block'; } normativeChartDivs.forEach(divId => { const container = document.getElementById(divId)?.closest('.normative-graph-container'); if (container) { container.style.display = bodyweightValid ? 'block' : 'none'; } }); const positions = ['I', 'Y', 'T']; positions.forEach((pos, i) => { const asymmetryChartDivId = asymmetryChartDivs[i]; const asymmetryPositionBoxDivId = asymmetryPositionBoxDivs[i]; const asymmetryPositionBoxDiv = document.getElementById(asymmetryPositionBoxDivId); const normativeChartDivId = normativeChartDivs[i]; if (!asymmetryPositionBoxDiv || !document.getElementById(asymmetryChartDivId) || !document.getElementById(normativeChartDivId)) return; const positionData = processInputAndCalculate(pos); if (positionData) { try { const [fig, allGreen] = createAsymmetryChart(positionData, injuredSide, pos); if (fig?.data && fig?.layout) { Plotly.react(asymmetryChartDivId, fig.data, fig.layout, plotlyConfig); if (allGreen) asymmetryPositionBoxDiv.classList.add('green-box'); else asymmetryPositionBoxDiv.classList.remove('green-box'); } else { throw new Error("Generated asymmetry figure invalid."); } } catch (error) { console.error(`Error creating asymmetry chart for ${pos}:`, error); createEmptyPlot(asymmetryChartDivId, 'Error loading asymmetry data', 300, 20); asymmetryPositionBoxDiv.classList.remove('green-box'); } } else { createEmptyPlot(asymmetryChartDivId, 'Enter Data', 300, 20); asymmetryPositionBoxDiv.classList.remove('green-box'); } if (bodyweightValid && positionData) { try { const config = createNormativeComparisonChart(positionData, bodyweight, pos); if (config?.data && config?.layout) Plotly.react(normativeChartDivId, config.data, config.layout, plotlyConfig); else throw new Error("Generated normative figure invalid."); } catch (error) { console.error(`Error creating normative chart for ${pos}:`, error); createEmptyPlot(normativeChartDivId, 'Error Loading Data', 250, 35); } } else if (!bodyweightValid) { createEmptyPlot(normativeChartDivId, 'Enter Bodyweight', 250, 35); } else { createEmptyPlot(normativeChartDivId, 'Enter Data', 250, 35); } }); setTimeout(() => window.dispatchEvent(new Event('resize')), 100); }
        // function togglePatientData() { /* Fjernet */ }
        function enterPreviewMode() { document.body.classList.add('pdf-preview-active'); if(previewExitButtonInline) previewExitButtonInline.style.display = 'inline-block'; if(explanationBox) explanationBox.style.display = 'block'; window.dispatchEvent(new Event('resize')); console.log("Entered PDF preview mode"); }
        function exitPreviewMode() { document.body.classList.remove('pdf-preview-active'); if(previewExitButtonInline) previewExitButtonInline.style.display = 'none'; if(explanationBox) explanationBox.style.display = 'none'; window.dispatchEvent(new Event('resize')); console.log("Exited PDF preview mode"); }
        function exportTableToCsv() { const fpNr = fpNrInput ? fpNrInput.value.trim() : ''; const age = ageInput ? ageInput.value.trim() : ''; const gender = genderSelect ? genderSelect.value : ''; const sport = sportInput ? sportInput.value.trim() : ''; const injury = injuryInput ? injuryInput.value.trim() : ''; const bodyweight = bodyweightInput ? bodyweightInput.value.trim() : ''; const injuredSide = injuredSideRadio ? injuredSideRadio.value : ''; const date = new Date(); const year = date.getFullYear(); const month = (date.getMonth() + 1).toString().padStart(2, '0'); const day = date.getDate().toString().padStart(2, '0'); const dateString = `${year}-${month}-${day}`; const safeFpNr = fpNr.replace(/[^a-z0-9]/gi, '_') || 'Unknown'; const filename = `ASH_${safeFpNr}_${dateString}.csv`; const headers = [ "Patient ID", "Age", "Gender", "Sport", "Injury", "Bodyweight (kg)", "Injured Side", "Position", "Metric", "Left Value", "Right Value" ]; let csv = [headers.join(',')]; const positions = ['I', 'Y', 'T']; const metricsForCsv = ['Max Force (N)', 'RFD 100ms (N/s)']; positions.forEach(pos => { const positionName = `ASH Test Position ${pos}`; const positionData = processInputAndCalculate(pos); metricsForCsv.forEach(metricDisplay => { let leftVal = ''; let rightVal = ''; let metricIdentifier = metricDisplay; if (metricDisplay === 'Max Force (N)') { if (positionData) { leftVal = positionData.left.max_force; rightVal = positionData.right.max_force; } } else if (metricDisplay === 'RFD 100ms (N/s)') { if (positionData) { leftVal = positionData.left.rfd; rightVal = positionData.right.rfd; } metricIdentifier = 'RFD 100ms (N/s)'; } const rowData = [ `"${fpNr}"`, `"${age}"`, `"${gender}"`, `"${sport}"`, `"${injury}"`, `"${bodyweight}"`, `"${injuredSide}"`, `"${positionName}"`, `"${metricIdentifier}"`, `"${leftVal}"`, `"${rightVal}"` ]; csv.push(rowData.join(',')); }); }); const csvString = "\uFEFF" + csv.join('\n'); const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); if (link.download !== undefined) { const url = URL.createObjectURL(blob); link.setAttribute('href', url); link.setAttribute('download', filename); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); console.log(`CSV export initiated: ${filename}`); } else { alert("CSV export is not directly supported in this browser. Please try a modern browser."); } }
        function clearAllFields() { console.log("Clearing all fields..."); if (fpNrInput) fpNrInput.value = ''; if (ageInput) ageInput.value = ''; if (genderSelect) genderSelect.value = ''; if (sportInput) sportInput.value = ''; if (injuryInput) injuryInput.value = ''; if (injuredSideRadio) injuredSideRadio.value = 'Left'; if (bodyweightInput) bodyweightInput.value = ''; allNumberInputs.forEach(input => { input.value = ''; }); if(selectedPatientTestsContainer) selectedPatientTestsContainer.style.display = 'none'; if(selectedPatientTestsListUL) selectedPatientTestsListUL.innerHTML = ''; updateGraphsAndTable(); saveInputsToLocalStorage(); console.log("Fields cleared."); }
        
        const localStorageKey = 'screeningAppData_v6_subcollection'; 
        function saveInputsToLocalStorage() { const dataToSave = { injuredSide: injuredSideRadio.value, bodyweight: bodyweightInput.value, fpNr: fpNrInput.value, age: ageInput.value, gender: genderSelect.value, sport: sportInput.value, injury: injuryInput.value, 'non-injured-max-force-i': inputFieldMap['I'].nonInjured[0].value, 'non-injured-rfd-i': inputFieldMap['I'].nonInjured[1].value, 'injured-max-force-i': inputFieldMap['I'].injured[0].value, 'injured-rfd-i': inputFieldMap['I'].injured[1].value, 'non-injured-max-force-y': inputFieldMap['Y'].nonInjured[0].value, 'non-injured-rfd-y': inputFieldMap['Y'].nonInjured[1].value, 'injured-max-force-y': inputFieldMap['Y'].injured[0].value, 'injured-rfd-y': inputFieldMap['Y'].injured[1].value, 'non-injured-max-force-t': inputFieldMap['T'].nonInjured[0].value, 'non-injured-rfd-t': inputFieldMap['T'].nonInjured[1].value, 'injured-max-force-t': inputFieldMap['T'].injured[0].value, 'injured-rfd-t': inputFieldMap['T'].injured[1].value, }; try { localStorage.setItem(localStorageKey, JSON.stringify(dataToSave)); } catch (error) { console.error('Error saving inputs:', error); } }
        function loadInputsFromLocalStorage() { try { const savedDataString = localStorage.getItem(localStorageKey); if (savedDataString) { const savedData = JSON.parse(savedDataString); console.log('Loading inputs from localStorage:', localStorageKey); injuredSideRadio.value = savedData.injuredSide || 'Left'; bodyweightInput.value = savedData.bodyweight || ''; fpNrInput.value = savedData.fpNr || ''; ageInput.value = savedData.age || ''; genderSelect.value = savedData.gender || ''; sportInput.value = savedData.sport || ''; injuryInput.value = savedData.injury || ''; inputFieldMap['I'].nonInjured[0].value = savedData['non-injured-max-force-i'] || ''; inputFieldMap['I'].nonInjured[1].value = savedData['non-injured-rfd-i'] || ''; inputFieldMap['I'].injured[0].value = savedData['injured-max-force-i'] || ''; inputFieldMap['I'].injured[1].value = savedData['injured-rfd-i'] || ''; inputFieldMap['Y'].nonInjured[0].value = savedData['non-injured-max-force-y'] || ''; inputFieldMap['Y'].nonInjured[1].value = savedData['non-injured-rfd-y'] || ''; inputFieldMap['Y'].injured[0].value = savedData['injured-max-force-y'] || ''; inputFieldMap['Y'].injured[1].value = savedData['injured-rfd-y'] || ''; inputFieldMap['T'].nonInjured[0].value = savedData['non-injured-max-force-t'] || ''; inputFieldMap['T'].nonInjured[1].value = savedData['non-injured-rfd-t'] || ''; inputFieldMap['T'].injured[0].value = savedData['injured-max-force-t'] || ''; inputFieldMap['T'].injured[1].value = savedData['injured-rfd-t'] || ''; 
            } } catch (error) { console.error('Error loading inputs:', error); } }

        // --- Firebase Auth State Change ---
        onAuthStateChanged(auth, async (user) => { 
            if (user) {
                console.log("Screening page (Firebase Auth): User is authenticated.", user.uid);
                
                if (loggedInUserNameSpan && loggedInUserEmailDisplaySpan) {
                    loggedInUserEmailDisplaySpan.textContent = user.email || 'No email';
                    try {
                        const userDocRef = doc(db, "users", user.uid);
                        const userDocSnap = await getDoc(userDocRef);
                        if (userDocSnap.exists()) {
                            const userData = userDocSnap.data();
                            const firstName = userData.firstName || '';
                            const lastName = userData.lastName || '';
                            loggedInUserNameSpan.textContent = `${firstName} ${lastName}`.trim() || 'User';
                        } else {
                            loggedInUserNameSpan.textContent = 'User Name Not Found';
                            console.warn("User document not found in Firestore for UID:", user.uid);
                        }
                    } catch (error) {
                        console.error("Error fetching user name from Firestore:", error);
                        loggedInUserNameSpan.textContent = 'Error loading name';
                    }
                }

                if (appLoadingMessage) appLoadingMessage.style.display = 'none';
                if (appLayout) appLayout.style.display = 'flex';
                if (patientDataContainer) patientDataContainer.style.display = 'block'; 
                
                populatePatientIdDatalist(); 
            } else {
                console.log("Screening page (Firebase Auth): User is NOT authenticated. Redirecting to login.");
                if (appLoadingMessage) appLoadingMessage.textContent = 'Redirecting to login... Please wait.';
                window.location.replace(loginPageUrl);
            }
        });

        // --- Firestore Data Functions (Oppdatert for undersamlinger) ---
        async function populatePatientIdDatalist() {
            if (!auth.currentUser || !existingPatientIdsDatalist) return;
            console.log("Populating patient ID datalist from subcollection...");
            try {
                const screeningsCollectionRef = collection(db, "users", auth.currentUser.uid, "screenings");
                const q = query(screeningsCollectionRef, orderBy("patientId"));
                const querySnapshot = await getDocs(q);
                const patientIds = new Set();
                querySnapshot.forEach((doc) => {
                    if (doc.data().patientId) {
                        patientIds.add(doc.data().patientId);
                    }
                });
                existingPatientIdsDatalist.innerHTML = '';
                if (patientIds.size === 0) {
                    console.log("No unique patient IDs found for this clinician in their subcollection.");
                }
                patientIds.forEach(id => {
                    const option = document.createElement('option');
                    option.value = id;
                    existingPatientIdsDatalist.appendChild(option);
                });
                console.log("Patient ID datalist populated with:", Array.from(patientIds));
            } catch (error) {
                console.error("Error populating patient ID datalist: ", error);
                if (error.code === 'failed-precondition' || (error.message && error.message.includes('index'))) {
                    showStatusMessage(`Error: Firestore index for users/${auth.currentUser.uid}/screenings (orderBy patientId) might be needed. Check console.`, "error", 10000);
                } else if (error.code === 'permission-denied') {
                     showStatusMessage(`Error: Missing permissions to read patient list. Check Firestore rules for path /users/${auth.currentUser.uid}/screenings.`, "error", 10000);
                } else {
                    showStatusMessage("Error loading patient list.", "error");
                }
            }
        }

        async function displayTestsForPatient(patientId) {
            console.log(`displayTestsForPatient CALLED with patientId: '${patientId}' (type: ${typeof patientId})`);
            if (!auth.currentUser || !selectedPatientTestsListUL || !selectedPatientTestsContainer || !currentPatientForTestsSpan) return;
            
            currentPatientForTestsSpan.textContent = patientId;
            selectedPatientTestsListUL.innerHTML = '<li>Loading tests...</li>';
            selectedPatientTestsContainer.style.display = 'block';

            try {
                const screeningsCollectionRef = collection(db, "users", auth.currentUser.uid, "screenings");
                const q = query(
                    screeningsCollectionRef, 
                    where("patientId", "==", patientId),
                    orderBy("testTimestamp", "desc")
                );

                const querySnapshot = await getDocs(q);
                console.log(`Query for patient ${patientId} found ${querySnapshot.size} tests.`); 

                selectedPatientTestsListUL.innerHTML = '';  
                if (querySnapshot.empty) {
                    selectedPatientTestsListUL.innerHTML = '<li>No tests found for this patient.</li>';
                    console.log(`No tests actually found in Firestore for patient ${patientId}`);
                    return;
                }
                querySnapshot.forEach((docSnap) => {
                    console.log("Found test document:", docSnap.id, docSnap.data()); 
                    const screening = docSnap.data();
                    const screeningId = docSnap.id;
                    const li = document.createElement('li');
                    li.addEventListener('click', () => { // Gjør hele li klikkbar for å laste
                        loadScreeningData(screeningId);
                    });

                    const dateSpan = document.createElement('span');
                    const screeningTimestamp = screening.testTimestamp; 
                    if (screeningTimestamp && typeof screeningTimestamp.toDate === 'function') {
                        const date = screeningTimestamp.toDate();
                        dateSpan.textContent = date.toLocaleString('nb-NO', { dateStyle: 'medium', timeStyle: 'short' });
                    } else {
                        dateSpan.textContent = "Invalid date";
                        console.warn("Invalid or missing testTimestamp for screening:", screeningId, screening);
                    }
                    dateSpan.title = "Load this test"; 
                    
                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>'; // Kun ikon
                    deleteButton.title = "Delete this test";
                    deleteButton.classList.add('delete-test-btn');
                    deleteButton.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        const dateForConfirm = screeningTimestamp && typeof screeningTimestamp.toDate === 'function' ? screeningTimestamp.toDate() : new Date();
                        confirmAndDeleteScreening(screeningId, patientId, dateForConfirm);
                    });

                    li.appendChild(dateSpan);
                    li.appendChild(deleteButton);
                    selectedPatientTestsListUL.appendChild(li);
                });

            } catch (error) {
                console.error(`Error loading tests for patient ${patientId}: `, error);
                selectedPatientTestsListUL.innerHTML = '<li>Error loading tests. Check console for details.</li>';
                if (error.code === 'failed-precondition' || (error.message && error.message.includes('index'))) {
                    showStatusMessage(`Error: Firestore index for users/${auth.currentUser.uid}/screenings (patientId ASC, testTimestamp DESC) is needed. Check console.`, "error", 10000);
                } else if (error.code === 'permission-denied') {
                     showStatusMessage(`Error: Missing permissions to read tests for patient ${patientId}. Check Firestore rules.`, "error", 10000);
                }
            }
        }
        
        if (fpNrInput) {
            fpNrInput.addEventListener('focus', populatePatientIdDatalist);
            fpNrInput.addEventListener('input', (e) => {
                const enteredPatientId = e.target.value.trim();
                if (enteredPatientId) {
                    const options = Array.from(existingPatientIdsDatalist.options).map(opt => opt.value);
                    if (options.includes(enteredPatientId)) {
                        displayTestsForPatient(enteredPatientId);
                    } else {
                        if(selectedPatientTestsContainer) selectedPatientTestsContainer.style.display = 'none';
                    }
                } else {
                     if(selectedPatientTestsContainer) selectedPatientTestsContainer.style.display = 'none';
                }
            });
        }

        async function loadScreeningData(screeningId) {
            if (!screeningId || !auth.currentUser) {
                console.error("Screening ID or user missing for loadScreeningData");
                return;
            }
            showStatusMessage("Loading test data...", "info", 1500);
            try {
                const docRef = doc(db, "users", auth.currentUser.uid, "screenings", screeningId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(fpNrInput) fpNrInput.value = data.patientId || '';  
                    if(ageInput) ageInput.value = data.age || '';  
                    if(genderSelect) genderSelect.value = data.gender || '';  
                    if(sportInput) sportInput.value = data.sport || '';  
                    if(injuryInput) injuryInput.value = data.injury || '';  
                    if(bodyweightInput) bodyweightInput.value = data.bodyweight || '';  
                    if(injuredSideRadio) injuredSideRadio.value = data.injuredSide || 'Left';
                    ['I', 'Y', 'T'].forEach(pos => {  
                        if (data.ashTest && data.ashTest[pos]) {  
                            if(inputFieldMap[pos].nonInjured[0]) inputFieldMap[pos].nonInjured[0].value = data.ashTest[pos].nonInjuredMaxForce || '';  
                            if(inputFieldMap[pos].nonInjured[1]) inputFieldMap[pos].nonInjured[1].value = data.ashTest[pos].nonInjuredRfd || '';  
                            if(inputFieldMap[pos].injured[0]) inputFieldMap[pos].injured[0].value = data.ashTest[pos].injuredMaxForce || '';  
                            if(inputFieldMap[pos].injured[1]) inputFieldMap[pos].injured[1].value = data.ashTest[pos].injuredRfd || '';  
                        } else {
                            if(inputFieldMap[pos].nonInjured[0]) inputFieldMap[pos].nonInjured[0].value = '';
                            if(inputFieldMap[pos].nonInjured[1]) inputFieldMap[pos].nonInjured[1].value = '';
                            if(inputFieldMap[pos].injured[0]) inputFieldMap[pos].injured[0].value = '';
                            if(inputFieldMap[pos].injured[1]) inputFieldMap[pos].injured[1].value = '';
                        }
                    });
                    updateGraphsAndTable();  
                    saveInputsToLocalStorage();  
                    showStatusMessage('Test data loaded successfully!', 'success');
                } else {  
                    console.log("No such screening document in subcollection!");  
                    showStatusMessage("Could not find the selected test data.", "error");
                }
            } catch (error) {  
                console.error("Error loading screening data: ", error);  
                showStatusMessage("Error loading test data. Please try again.", "error");
            }
        }
        
        async function confirmAndDeleteScreening(screeningId, patientId, dateObject) {
            if (!auth.currentUser) {
                 console.error("User not authenticated for deleting screening.");
                return;
            }
            const formattedDate = dateObject instanceof Date && !isNaN(dateObject) 
                ? dateObject.toLocaleString('nb-NO', { dateStyle: 'medium', timeStyle: 'short' }) 
                : "unknown date";

            if (confirm(`Are you sure you want to delete the test for patient "${patientId}" from ${formattedDate}? This action cannot be undone.`)) {
                if (!screeningId) return;
                showStatusMessage("Deleting test...", "info", 1500);
                try {
                    await deleteDoc(doc(db, "users", auth.currentUser.uid, "screenings", screeningId));
                    console.log("Screening deleted successfully from subcollection:", screeningId);
                    showStatusMessage('Test deleted successfully!', 'success');
                    if (fpNrInput.value === patientId) { 
                        displayTestsForPatient(patientId);
                    } else { 
                        if (selectedPatientTestsContainer) selectedPatientTestsContainer.style.display = 'none';
                    }
                    await populatePatientIdDatalist(); 
                } catch (error) {
                    console.error("Error during delete operation: ", error);
                    showStatusMessage('Failed to delete test.', 'error');
                }
            }
        }

        async function saveDataToFirestore() {
            if (!auth.currentUser) { showStatusMessage("You must be logged in to save data.", "error"); return; }
            if (!fpNrInput || !fpNrInput.value.trim()) { showStatusMessage("Patient ID is required to save data.", "error"); fpNrInput.focus(); return; }
            
            const currentPatientId = fpNrInput.value.trim();
            const screeningData = {
                patientId: currentPatientId,
                testTimestamp: serverTimestamp(),
                age: ageInput.value ? parseInt(ageInput.value) : null,
                gender: genderSelect.value || null,
                sport: sportInput.value.trim() || null,
                injury: injuryInput.value.trim() || null,
                bodyweight: bodyweightInput.value ? parseFloat(bodyweightInput.value) : null,
                injuredSide: injuredSideRadio.value,
                ashTest: {}
            };

            let dataEnteredForAsh = false;
            ['I', 'Y', 'T'].forEach(pos => { 
                const positionData = processInputAndCalculate(pos); 
                if (positionData) { 
                    let nonInjuredData, injuredData; 
                    if (injuredSideRadio.value === 'Left') { 
                        nonInjuredData = positionData.right; 
                        injuredData = positionData.left; 
                    } else { 
                        nonInjuredData = positionData.left; 
                        injuredData = positionData.right; 
                    } 
                    screeningData.ashTest[pos] = { 
                        nonInjuredMaxForce: nonInjuredData.max_force, 
                        nonInjuredRfd: nonInjuredData.rfd, 
                        injuredMaxForce: injuredData.max_force, 
                        injuredRfd: injuredData.rfd 
                    }; 
                    dataEnteredForAsh = true; 
                } else { 
                    screeningData.ashTest[pos] = { nonInjuredMaxForce: null, nonInjuredRfd: null, injuredMaxForce: null, injuredRfd: null }; 
                } 
            });
            
            if (!dataEnteredForAsh && (!screeningData.age && !screeningData.gender && !screeningData.sport && !screeningData.injury && !screeningData.bodyweight)) { 
                showStatusMessage("No data entered to save.", "warning"); return; 
            }
            
            try {
                const screeningCollectionRef = collection(db, "users", auth.currentUser.uid, "screenings");
                const docRef = await addDoc(screeningCollectionRef, screeningData);
                
                console.log("Screening data saved to subcollection with ID: ", docRef.id);
                showStatusMessage("Data saved successfully!", "success");
                
                await populatePatientIdDatalist(); 
                displayTestsForPatient(currentPatientId); 

            } catch (error) { 
                console.error("Error saving screening data: ", error); 
                showStatusMessage("Error saving data. Please try again.", "error"); 
            }
        }
        
        // --- Initialisering og Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            asymmetryChartDivs.forEach(divId => createEmptyPlot(divId, 'Enter Data', 300, 20));
            normativeChartDivs.forEach(divId => createEmptyPlot(divId, 'Enter Bodyweight', 250, 35));
            loadInputsFromLocalStorage();
            updateGraphsAndTable();
            if (patientDataContainer) { 
                 patientDataContainer.style.display = 'block';
            }
        });

        if (injuredSideRadio) injuredSideRadio.addEventListener('change', () => { updateGraphsAndTable(); saveInputsToLocalStorage(); });
        if (bodyweightInput) bodyweightInput.addEventListener('input', () => { updateGraphsAndTable(); saveInputsToLocalStorage(); });
        if (fpNrInput) fpNrInput.addEventListener('change', saveInputsToLocalStorage);
        if (ageInput) ageInput.addEventListener('change', saveInputsToLocalStorage);
        if (genderSelect) genderSelect.addEventListener('change', saveInputsToLocalStorage);
        if (sportInput) sportInput.addEventListener('change', saveInputsToLocalStorage);
        if (injuryInput) injuryInput.addEventListener('change', saveInputsToLocalStorage);
        allNumberInputs.forEach(input => { 
            input.addEventListener('input', updateGraphsAndTable); 
            input.addEventListener('change', saveInputsToLocalStorage); 
        });
        if (pdfPreviewButton) pdfPreviewButton.addEventListener('click', enterPreviewMode);
        if (exportExcelButton) exportExcelButton.addEventListener('click', exportTableToCsv);
        // if (registerPatientButton) registerPatientButton.addEventListener('click', togglePatientData); // Fjernet
        if (previewExitButtonInline) previewExitButtonInline.addEventListener('click', exitPreviewMode);
        if (clearAllButton) clearAllButton.addEventListener('click', clearAllFields);
        if(saveDataButton) saveDataButton.addEventListener('click', saveDataToFirestore);
        
        if(logoutButton) {
            logoutButton.addEventListener('click', () => {
                signOut(auth).then(() => {
                    console.log("User signed out successfully.");
                    localStorage.removeItem(localStorageKey); 
                    window.location.href = loginPageUrl;
                }).catch((error) => {
                    console.error("Sign out error", error);
                    showStatusMessage("Error signing out. Please try again.", "error");
                });
            });
        }
        window.addEventListener('load', () => { setTimeout(() => window.dispatchEvent(new Event('resize')), 200); });
        window.addEventListener('resize', () => {
            asymmetryChartDivs.concat(normativeChartDivs).forEach(divId => {
                const gd = document.getElementById(divId);
                if (gd && gd.classList.contains('js-plotly-plot')) { try { Plotly.Plots.resize(gd); } catch (e) { /* Ignorer */ } }
            });
        });

    </script>
</body>
</html>
