<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Functional Shoulder Screening</title>
    <script src="https://cdn.plot.ly/plotly-2.27.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Avenir:wght@400&family=Futura:wght@400&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --app-primary-color: #285484;
            --app-secondary-color: rgb(112, 188, 252);
            --app-tertiary-color: #121630;
            --app-text-on-primary: #ffffff;
            --app-text-on-secondary: var(--app-primary-color);
            --app-button-text-color: var(--app-text-on-primary);
            --app-button-icon-color: var(--app-secondary-color);
            --app-button-gradient-start: var(--app-primary-color);
            --app-button-gradient-end: var(--app-tertiary-color);
            --app-button-hover-gradient-start: #1e3a5c;
            --app-button-hover-gradient-end: var(--app-primary-color);
            --app-button-light-gradient-start: var(--app-secondary-color);
            --app-button-light-gradient-end: var(--app-primary-color);
            --app-button-light-hover-gradient-start: var(--app-primary-color);
            --app-button-light-hover-gradient-end: #1e3a5c;
            --light-gray: #f8f9fa;
            --medium-gray: #dee2e6;
            --dark-gray: #495057;
            --text-color: #212529;
            --success-color: #16a34a;
            --success-border-color: #15803d;
            --success-shadow-color: rgba(22, 163, 74, 0.45);
            --success-gradient-start-color: rgba(22, 163, 74, 1);
            --warning-color: #facc15;
            --danger-color-dark: #dc2626;
            --injured-input-bg: rgba(255, 224, 224, 0.7);
            --injured-input-border: #fca5a5;
            --white: #ffffff;
            --border-radius: 0px; /* Default, kan overstyres */
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --sidebar-border-color: var(--medium-gray);
            --header-border-color: var(--medium-gray);
            --subtle-shadow: 0 1px 3px rgba(0,0,0,0.1);
            --left-line-color: #ff7f0e;
            --right-line-color: #1f77b4;
            --norm-poor-bg: rgba(252, 165, 165, 0.5);
            --norm-average-bg: rgba(252, 211, 77, 0.5);
            --norm-good-bg: rgba(167, 243, 208, 0.5);
            --norm-excellent-bg: rgba(52, 211, 153, 0.5);
            --base-font-size: 16px;
            --graph-box-height: 340px;
            --sidebar-width: 180px;
            --normal-font-weight: 400;
            --semibold-font-weight: 400; /* Avenir er ofte lett, så 400 kan være normal/semibold */
            --bold-font-weight: 400;    /* Juster etter fontens faktiske vekter */
            --main-content-margin: 20px;
        }
        body {
            font-family: 'Avenir', sans-serif;
            background-color: var(--light-gray);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            width: 100%;
            box-sizing: border-box;
            line-height: 1.6;
            font-size: var(--base-font-size);
            font-weight: var(--normal-font-weight);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-synthesis: none;
        }
        .app-layout {
            display: none; /* Initially hidden until auth check */
            flex-direction: row;
            width: 100%;
            min-height: 100vh;
            margin-top: 0;
        }
        .loading-message, .status-message { /* ... (som før) ... */ }
        .status-message { /* ... (som før) ... */ }
        .status-message.success { background-color: var(--norm-good-bg); color: var(--text-color); }
        .status-message.error { background-color: var(--norm-poor-bg); color: var(--text-color); }
        .app-sidebar { /* ... (som før) ... */ }
        .sidebar-logo-placeholder { /* ... (som før) ... */ }
        .sidebar-buttons { /* ... (som før) ... */ }
        .sidebar-user-info { /* ... (som før) ... */ }
        .sidebar-social-links { /* ... (som før) ... */ }
        .app-main-content { /* ... (som før) ... */ }
        .app-sidebar button, .app-sidebar a button { /* ... (som før) ... */ }
        .content-container { max-width: 1100px; margin: 0 auto; }
        h1, h2, h3 { /* ... (som før) ... */ }
        h1 { /* ... (som før) ... */ }
        h2 { /* ... (som før) ... */ }
        h3.position-title, h3.normative-title { /* ... (som før) ... */ }
        #report-content { /* ... (som før) ... */ }
        #top-controls { /* ... (som før) ... */ }
        #patient-data-container { /* ... (som før) ... */ }
        #patient-data-grid { /* ... (som før) ... */ }
        .patient-data-item { /* ... (som før) ... */ }
        #patient-data-container input[type="text"], #patient-data-container input[type="number"], #patient-data-container select { /* ... (som før) ... */ }
        
        /* === Ny CSS for visning av lagrede tester === */
        #selected-patient-tests-container {
            background-color: #f0f4f8; 
            padding: 20px;
            margin-top: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border-radius: 4px;
            border: 1px solid var(--medium-gray);
        }

        #selected-patient-tests-container h3 { /* Stil for den nye H3 overskriften */
            margin-top: 0;
            margin-bottom: 18px;
            font-size: 1.25rem; 
            color: var(--app-primary-color);
            border-bottom: 1px solid var(--medium-gray);
            padding-bottom: 12px;
            font-weight: var(--normal-font-weight); /* Matcher andre H3 */
        }

        #selected-patient-tests-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 280px; 
            overflow-y: auto;
        }

        #selected-patient-tests-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border: 1px solid #dce1e6; 
            background-color: var(--white);
            border-radius: 3px;
            margin-bottom: 10px; 
            cursor: default; 
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        #selected-patient-tests-list li:hover { /* Generell hover for listeelementet */
            background-color: #eef2f7; /* En lysere hoverfarge */
        }

        #selected-patient-tests-list li:last-child {
            margin-bottom: 0;
        }

        #selected-patient-tests-list li span { /* Selve test-datoen/navnet */
            flex-grow: 1;
            color: var(--text-color);
            font-size: 0.95rem;
            cursor: pointer; 
            transition: color 0.2s ease;
        }
        #selected-patient-tests-list li span:hover {
            color: var(--app-primary-color); 
        }

        #selected-patient-tests-list button.delete-test-btn {
            background-color: transparent;
            border: none;
            color: var(--danger-color-dark);
            cursor: pointer;
            padding: 5px 8px;
            margin-left: 15px;
            font-size: 1rem; 
            transition: color 0.2s ease, transform 0.2s ease;
        }

        #selected-patient-tests-list button.delete-test-btn:hover {
            color: #a80000;
            transform: scale(1.1); 
        }
        #selected-patient-tests-list button.delete-test-btn i {
            pointer-events: none; 
        }
        /* === Slutt på ny CSS === */

        #save-data-button-container { /* ... (som før) ... */ }
        #input-section-container { /* ... (som før) ... */ }
        .input-position-box { /* ... (som før) ... */ }
        .position-row { /* ... (som før) ... */ }
        .asymmetry-graph-container, .normative-graph-container { /* ... (som før) ... */ }
        .position-box, .normative-box { /* ... (som før) ... */ }
        #normative-placeholder { /* ... (som før) ... */ }
        #bottom-area { /* ... (som før) ... */ }
        #preview-exit-button-inline { /* ... (som før) ... */ }
        .explanation-box { /* ... (som før) ... */ }
        
        /* Responsive Styles */
        @media (max-width: 992px) { /* ... (som før) ... */ }
        @media (max-width: 768px) { /* ... (som før) ... */ }
        @media (max-width: 480px) { /* ... (som før) ... */ }
        /* Print Styles */
        @media print { /* ... (som før) ... */ }
    </style>
</head>
<body>
<div id="appLoadingMessage" class="loading-message">Authenticating... Please wait.</div>
<div id="appStatusMessage" class="status-message"></div>

<div class="app-layout">
    <aside class="app-sidebar">
        <div class="sidebar-logo-placeholder"><i class="fas fa-bars"></i></div>
        <div class="sidebar-buttons">
            <button id="register-patient-button"><i class="fas fa-user-plus"></i><span class="button-text">Register Patient</span></button>
            <a href="assets/analysis.html" id="analysis-link-button"><button type="button" id="view-analysis-button"><i class="fas fa-history"></i> <span class="button-text">Patient History</span></button></a>
            <button id="pdf-preview-button"><i class="fas fa-file-pdf"></i><span class="button-text">PDF Preview</span></button>
            <button id="export-excel-button"><i class="fas fa-file-excel"></i><span class="button-text">Export Data</span></button>
            <button id="clear-all-button"><i class="fas fa-eraser"></i><span class="button-text">Clear All</span></button>
        </div>
        <div id="loggedInUserContainer" class="sidebar-user-info">
             <span id="loggedInUserEmail" style="font-weight: var(--semibold-font-weight);"></span>
        </div>
        <button id="logout-button" style="margin-top: 5px;"><i class="fas fa-sign-out-alt"></i><span class="button-text">Logout</span></button>
        <div class="sidebar-social-links">
            <a href="https://www.instagram.com/alphatekofficial" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
            <a href="https://www.alphatek.no" target="_blank" title="Website"><i class="fas fa-globe"></i></a>
            <a href="#" title="Info/Help"><i class="fas fa-circle-info"></i></a>
        </div>
    </aside>
    <main class="app-main-content">
        <button id="preview-exit-button-inline"><i class="fas fa-times-circle"></i> Exit Preview</button>
        <div class="content-container">
            <div id="report-content">
                <h1>Functional Shoulder Screening</h1>
                <h2 id="patient-details-title">Patient Details</h2>
                <div id="top-controls">
                    <div class="control-item"><label class="control-label" for="injured-side-radio">Injured Side:</label><select id="injured-side-radio"><option value="Left">Left</option><option value="Right">Right</option></select></div>
                    <div class="control-item"><label class="control-label" for="bodyweight-input">Bodyweight (kg):</label><input id="bodyweight-input" type="number" placeholder="kg"></div>
                </div>
                <div class="explanation-box"><h4>About This Report</h4> <p>This report summarizes the results of the Functional Shoulder Screening using the ASH test (Positions I, Y, T).</p><ul> <li><strong>Asymmetry Graphs:</strong> Show the percentage difference between the injured and uninjured side for key metrics (Max Force, RFD, % Max Force at 100ms). Values closer to 100% indicate better symmetry. Annotations above the bars show the percentage difference relative to the uninjured side (100%). Numbers inside the bars show the absolute values for each side.</li> <li><strong>Normative Graphs:</strong> Visually represent the estimated percentile rank for Max Force / Bodyweight (N/kg) for each side, based on normative thresholds. Background colors indicate performance zones (Poor, Average, Good, Excellent). Vertical dashed lines show the estimated percentile for the Left (Orange) and Right (Blue) values.</li> </ul><p><i>To save as PDF: Click 'PDF Preview', then use your browser's Print function (Ctrl+P or Cmd+P) and select 'Save as PDF'. Click 'Exit Preview' to return.</i></p></div>
                
                <div id="patient-data-container">
                    <div id="patient-data-grid">
                        <div class="patient-data-item">
                            <label for="fp-nr-input">Patient ID:</label>
                            <input id="fp-nr-input" type="text" placeholder="Enter or select Patient ID" list="existing-patient-ids">
                            <datalist id="existing-patient-ids"></datalist>
                            </div>
                        <div class="patient-data-item"><label for="age-input">Age:</label><input id="age-input" type="number" placeholder="Years"></div>
                        <div class="patient-data-item"><label for="gender-select">Gender:</label><select id="gender-select"><option value="">Select...</option><option value="Male">Male</option><option value="Female">Female</option><option value="Other">Other</option><option value="Prefer not to say">Prefer not to say</option></select></div>
                        <div class="patient-data-item"><label for="sport-input">Sport:</label><input id="sport-input" type="text" placeholder="Main Sport"></div>
                        <div class="patient-data-item"><label for="injury-input">Injury (Optional):</label><input id="injury-input" type="text" placeholder="e.g., Rotator Cuff Tear"></div>
                    </div>
                </div> <div id="selected-patient-tests-container" style="display: none;"> <h3 id="selected-patient-tests-title-new">Saved Tests for Patient: <span id="current-patient-for-tests"></span></h3>
                    <ul id="selected-patient-tests-list"></ul>
                </div>
                <h2 id="input-title">Input Overview</h2>
                <div id="input-section-container">
                    <div class="input-position-box"><h4>ASH Test Position I</h4><div class="input-row"> <label>Max Force</label> <div class="input-wrapper"> <input id="non-injured-max-force-i" type="number" class="number-input" placeholder="Non-Injured"> <span class="unit-text">- N</span> </div> </div><div class="input-row"> <label>RFD 100ms</label> <div class="input-wrapper"> <input id="non-injured-rfd-i" type="number" class="number-input" placeholder="Non-Injured"> <span class="unit-text">- Ns<sup>-1</sup></span> </div> </div><div class="input-row"> <label>Max Force</label> <div class="input-wrapper"> <input id="injured-max-force-i" type="number" class="number-input" placeholder="Injured"> <span class="unit-text">- N</span> </div> </div><div class="input-row"> <label>RFD 100ms</label> <div class="input-wrapper"> <input id="injured-rfd-i" type="number" class="number-input" placeholder="Injured"> <span class="unit-text">- Ns<sup>-1</sup></span> </div> </div></div>
                    <div class="input-position-box"><h4>ASH Test Position Y</h4><div class="input-row"> <label>Max Force</label> <div class="input-wrapper"><input id="non-injured-max-force-y" type="number" class="number-input" placeholder="Non-Injured"> <span class="unit-text">- N</span></div> </div><div class="input-row"> <label>RFD 100ms</label> <div class="input-wrapper"><input id="non-injured-rfd-y" type="number" class="number-input" placeholder="Non-Injured"> <span class="unit-text">- Ns<sup>-1</sup></span></div> </div><div class="input-row"> <label>Max Force</label> <div class="input-wrapper"><input id="injured-max-force-y" type="number" class="number-input" placeholder="Injured"> <span class="unit-text">- N</span></div> </div><div class="input-row"> <label>RFD 100ms</label> <div class="input-wrapper"><input id="injured-rfd-y" type="number" class="number-input" placeholder="Injured"> <span class="unit-text">- Ns<sup>-1</sup></span></div> </div></div>
                    <div class="input-position-box"><h4>ASH Test Position T</h4><div class="input-row"> <label>Max Force</label> <div class="input-wrapper"><input id="non-injured-max-force-t" type="number" class="number-input" placeholder="Non-Injured"> <span class="unit-text">- N</span></div> </div><div class="input-row"> <label>RFD 100ms</label> <div class="input-wrapper"><input id="non-injured-rfd-t" type="number" class="number-input" placeholder="Non-Injured"> <span class="unit-text">- Ns<sup>-1</sup></span></div> </div><div class="input-row"> <label>Max Force</label> <div class="input-wrapper"><input id="injured-max-force-t" type="number" class="number-input" placeholder="Injured"> <span class="unit-text">- N</span></div> </div><div class="input-row"> <label>RFD 100ms</label> <div class="input-wrapper"><input id="injured-rfd-t" type="number" class="number-input" placeholder="Injured"> <span class="unit-text">- Ns<sup>-1</sup></span></div> </div></div>
                </div>
                <div id="save-data-button-container">
                    <button id="save-data-button-main"><i class="fas fa-save"></i> Save Screening Data</button>
                </div>
                
                <h2 id="results-title">Results</h2>
                <div class="position-row"> <div class="asymmetry-graph-container"> <div id="position-box-I" class="position-box"> <h3 class="position-title">Position I - Asymmetry</h3> <div id="bar-chart-I" class="js-plotly-plot"></div> </div> </div> <div class="normative-graph-container"> <div id="normative-chart-container-I" class="normative-box"> <h3 class="normative-title">Position I - Normative Comparison</h3> <div id="normative-chart-I" class="js-plotly-plot"></div> </div> </div> </div>
                <div class="position-row"> <div class="asymmetry-graph-container"> <div id="position-box-Y" class="position-box"> <h3 class="position-title">Position Y - Asymmetry</h3> <div id="bar-chart-Y" class="js-plotly-plot"></div> </div> </div> <div class="normative-graph-container"> <div id="normative-chart-container-Y" class="normative-box"> <h3 class="normative-title">Position Y - Normative Comparison</h3> <div id="normative-chart-Y" class="js-plotly-plot"></div> </div> </div> </div>
                <div class="position-row"> <div class="asymmetry-graph-container"> <div id="position-box-T" class="position-box"> <h3 class="position-title">Position T - Asymmetry</h3> <div id="bar-chart-T" class="js-plotly-plot"></div> </div> </div> <div class="normative-graph-container"> <div id="normative-chart-container-T" class="normative-box"> <h3 class="normative-title">Position T - Normative Comparison</h3> <div id="normative-chart-T" class="js-plotly-plot"></div> </div> </div> </div>
                <div id="normative-placeholder" style="display: none;"> Enter bodyweight to see normative comparisons. </div>
                <div id="bottom-area"></div>
            </div>
        </div>
    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, orderBy, doc, getDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- Firebase Config & Init ---
    const firebaseConfig = {
        apiKey: "AIzaSyDhEihuoWm4c5MSOHrSqkkzca7tn86roq4", // OBS: Beskytt denne i produksjon
        authDomain: "pwr-analytics.firebaseapp.com",
        projectId: "pwr-analytics",
        storageBucket: "pwr-analytics.appspot.com",
        messagingSenderId: "9839468523",
        appId: "1:9839468523:web:1d994de254b2a24d91c3ae",
        measurementId: "G-N35HQ5CMD5"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const loginPageUrl = 'index.html';

    // --- UI Element References ---
    const appLayout = document.querySelector('.app-layout');
    const appLoadingMessage = document.getElementById('appLoadingMessage');
    const appStatusMessage = document.getElementById('appStatusMessage');
    const loggedInUserEmailSpan = document.getElementById('loggedInUserEmail');
    // ... (andre UI element referanser som før)
    const plotlyConfig = { /* ... (som før) ... */ };
    const normativeThresholds = { /* ... (som før) ... */ };
    const percentileZones = { /* ... (som før) ... */ };
    const percentileMidpoint = 50;
    const normZoneColors = { /* ... (som før) ... */ };
    const normativeLabels = { /* ... (som før) ... */ };
    const asymmetryChartDivs = ['bar-chart-I', 'bar-chart-Y', 'bar-chart-T'];
    const asymmetryPositionBoxDivs = ['position-box-I', 'position-box-Y', 'position-box-T'];
    const normativeChartDivs = ['normative-chart-I', 'normative-chart-Y', 'normative-chart-T'];
    const normativePlaceholder = document.getElementById('normative-placeholder');

    const injuredSideRadio = document.getElementById('injured-side-radio');
    const bodyweightInput = document.getElementById('bodyweight-input');
    const registerPatientButton = document.getElementById('register-patient-button');
    const saveDataButton = document.getElementById('save-data-button-main');
    const pdfPreviewButton = document.getElementById('pdf-preview-button');
    const exportExcelButton = document.getElementById('export-excel-button');
    const clearAllButton = document.getElementById('clear-all-button');
    const logoutButton = document.getElementById('logout-button');
    const previewExitButtonInline = document.getElementById('preview-exit-button-inline');
    const explanationBox = document.querySelector('.explanation-box');
    const patientDataContainer = document.getElementById('patient-data-container');
    const fpNrInput = document.getElementById('fp-nr-input');
    const ageInput = document.getElementById('age-input');
    const genderSelect = document.getElementById('gender-select');
    const sportInput = document.getElementById('sport-input');
    const injuryInput = document.getElementById('injury-input');
    const inputFieldMap = {
        'I': { nonInjured: [document.getElementById('non-injured-max-force-i'), document.getElementById('non-injured-rfd-i')], injured: [document.getElementById('injured-max-force-i'), document.getElementById('injured-rfd-i')] },
        'Y': { nonInjured: [document.getElementById('non-injured-max-force-y'), document.getElementById('non-injured-rfd-y')], injured: [document.getElementById('injured-max-force-y'), document.getElementById('injured-rfd-y')] },
        'T': { nonInjured: [document.getElementById('non-injured-max-force-t'), document.getElementById('non-injured-rfd-t')], injured: [document.getElementById('injured-max-force-t'), document.getElementById('injured-rfd-t')] }
    };
    const allNumberInputs = Array.from(document.querySelectorAll('#input-section-container input[type="number"]'));
    
    const existingPatientIdsDatalist = document.getElementById('existing-patient-ids');
    const selectedPatientTestsContainer = document.getElementById('selected-patient-tests-container'); // Referansen forblir den samme
    const selectedPatientTestsListUL = document.getElementById('selected-patient-tests-list');
    const currentPatientForTestsSpan = document.getElementById('current-patient-for-tests');


    // --- Utility Functions ---
    function showStatusMessage(message, type = 'info', duration = 3000) { /* ... (som før) ... */ }
    function hexToRgba(hex, alpha) { /* ... (som før) ... */ }
    function createEmptyPlot(targetDivId, title = 'Enter Data', height = 300, topMargin = 20) { /* ... (som før) ... */ }
    function processInputAndCalculate(position) { /* ... (som før) ... */ }
    function createAsymmetryChart(positionData, injuredSide, posLabel) { /* ... (som før) ... */ }
    function mapNkgToPercentile(nkgValue, positionLabel) { /* ... (som før) ... */ }
    function createNormativeComparisonChart(positionData, bodyweight, positionLabel) { /* ... (som før) ... */ }
    function updateGraphsAndTable() { /* ... (som før) ... */ }
    function togglePatientData() { /* ... (som før) ... */ }
    function enterPreviewMode() { /* ... (som før) ... */ }
    function exitPreviewMode() { /* ... (som før) ... */ }
    function exportTableToCsv() { /* ... (som før) ... */ }
    function clearAllFields() { /* ... (som før) ... */ }
    const localStorageKey = 'screeningAppData_v4_subcollection'; // Endret nøkkel for å unngå konflikt med gammel lagring
    function saveInputsToLocalStorage() { /* ... (som før, men bruker ny nøkkel) ... */ }
    function loadInputsFromLocalStorage() { /* ... (som før, men bruker ny nøkkel) ... */ }

    // --- Firebase Auth State Change ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("Screening page (Firebase Auth): User is authenticated.", user.uid);
            if(loggedInUserEmailSpan && user.email) {
                loggedInUserEmailSpan.textContent = user.email;
            }
            if (appLoadingMessage) appLoadingMessage.style.display = 'none';
            if (appLayout) appLayout.style.display = 'flex';
            populatePatientIdDatalist(); 
        } else {
            console.log("Screening page (Firebase Auth): User is NOT authenticated. Redirecting to login.");
            if (appLoadingMessage) appLoadingMessage.textContent = 'Redirecting to login... Please wait.';
            window.location.replace(loginPageUrl);
        }
    });

    // --- Firestore Data Functions (Oppdatert for undersamlinger) ---
    async function populatePatientIdDatalist() {
        if (!auth.currentUser || !existingPatientIdsDatalist) return;
        console.log("Populating patient ID datalist from subcollection...");
        try {
            const screeningsCollectionRef = collection(db, "users", auth.currentUser.uid, "screenings");
            const q = query(screeningsCollectionRef, orderBy("patientId"));
            // Firestore bør håndtere indeksen for `orderBy("patientId")` via enkeltfeltsindeksering.
            // Hvis ikke, vil feilmelding i konsollen gi lenke/instruks.

            const querySnapshot = await getDocs(q);
            const patientIds = new Set();
            querySnapshot.forEach((doc) => {
                if (doc.data().patientId) {
                    patientIds.add(doc.data().patientId);
                }
            });
            existingPatientIdsDatalist.innerHTML = '';
            if (patientIds.size === 0) {
                console.log("No unique patient IDs found for this clinician in their subcollection.");
            }
            patientIds.forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                existingPatientIdsDatalist.appendChild(option);
            });
            console.log("Patient ID datalist populated with:", Array.from(patientIds));
        } catch (error) {
            console.error("Error populating patient ID datalist: ", error);
            if (error.code === 'failed-precondition' || (error.message && error.message.includes('index'))) {
                showStatusMessage(`Error: Firestore index for users/${auth.currentUser.uid}/screenings (orderBy patientId) might be needed. Check console.`, "error", 10000);
            } else if (error.code === 'permission-denied') {
                 showStatusMessage(`Error: Missing permissions to read patient list. Check Firestore rules for path /users/${auth.currentUser.uid}/screenings.`, "error", 10000);
            } else {
                showStatusMessage("Error loading patient list.", "error");
            }
        }
    }

    async function displayTestsForPatient(patientId) {
        console.log(`displayTestsForPatient CALLED with patientId: '${patientId}' (type: ${typeof patientId})`);
        if (!auth.currentUser || !selectedPatientTestsListUL || !selectedPatientTestsContainer || !currentPatientForTestsSpan) return;
        
        currentPatientForTestsSpan.textContent = patientId;
        selectedPatientTestsListUL.innerHTML = '<li>Loading tests...</li>';
        selectedPatientTestsContainer.style.display = 'block'; // Gjør containeren synlig

        try {
            const screeningsCollectionRef = collection(db, "users", auth.currentUser.uid, "screenings");
            const q = query(
                screeningsCollectionRef, 
                where("patientId", "==", patientId),
                orderBy("testTimestamp", "desc")
            );
            // VIKTIG INDEKS: Du MÅ lage denne indeksen i Firebase Console for 'screenings' subcollection:
            // Fields: patientId (Ascending), testTimestamp (Descending)

            const querySnapshot = await getDocs(q);
            console.log(`Query for patient ${patientId} found ${querySnapshot.size} tests.`); 

            selectedPatientTestsListUL.innerHTML = '';  
            if (querySnapshot.empty) {
                selectedPatientTestsListUL.innerHTML = '<li>No tests found for this patient.</li>';
                console.log(`No tests actually found in Firestore for patient ${patientId}`);
                return;
            }
            querySnapshot.forEach((docSnap) => {
                console.log("Found test document:", docSnap.id, docSnap.data()); 
                const screening = docSnap.data();
                const screeningId = docSnap.id;
                const li = document.createElement('li');
                const dateSpan = document.createElement('span');
                const screeningTimestamp = screening.testTimestamp; 
                if (screeningTimestamp && typeof screeningTimestamp.toDate === 'function') {
                    const date = screeningTimestamp.toDate();
                    dateSpan.textContent = date.toLocaleString('nb-NO', { dateStyle: 'medium', timeStyle: 'short' });
                } else {
                    dateSpan.textContent = "Invalid date";
                    console.warn("Invalid or missing testTimestamp for screening:", screeningId, screening);
                }
                dateSpan.title = "Load this test";
                // dateSpan.style.cursor = 'pointer'; // Satt i CSS
                dateSpan.addEventListener('click', () => {
                    loadScreeningData(screeningId);
                    // Ikke skjul containeren her, brukeren vil kanskje se listen igjen
                });
                
                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
                deleteButton.title = "Delete this test";
                deleteButton.classList.add('delete-test-btn');
                deleteButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // Forhindre at li-klikket også fyrer
                    const dateForConfirm = screeningTimestamp && typeof screeningTimestamp.toDate === 'function' ? screeningTimestamp.toDate() : new Date();
                    confirmAndDeleteScreening(screeningId, patientId, dateForConfirm);
                });

                li.appendChild(dateSpan);
                li.appendChild(deleteButton);
                selectedPatientTestsListUL.appendChild(li);
            });

        } catch (error) {
            console.error(`Error loading tests for patient ${patientId}: `, error);
            selectedPatientTestsListUL.innerHTML = '<li>Error loading tests. Check console for details.</li>';
            if (error.code === 'failed-precondition' || (error.message && error.message.includes('index'))) {
                showStatusMessage(`Error: Firestore index for users/${auth.currentUser.uid}/screenings (patientId ASC, testTimestamp DESC) is needed. Check console.`, "error", 10000);
            } else if (error.code === 'permission-denied') {
                 showStatusMessage(`Error: Missing permissions to read tests for patient ${patientId}. Check Firestore rules.`, "error", 10000);
            }
        }
    }
    
    if (fpNrInput) {
        fpNrInput.addEventListener('focus', populatePatientIdDatalist);
        fpNrInput.addEventListener('input', (e) => {
            const enteredPatientId = e.target.value.trim();
            // console.log("Patient ID input event. Value:", enteredPatientId); 
            if (enteredPatientId) {
                const options = Array.from(existingPatientIdsDatalist.options).map(opt => opt.value);
                // console.log("Datalist options:", options);
                if (options.includes(enteredPatientId)) {
                    // console.log("Match found in datalist! Calling displayTestsForPatient with:", enteredPatientId);
                    displayTestsForPatient(enteredPatientId);
                } else {
                    // console.log("No match in datalist for:", enteredPatientId);
                    if(selectedPatientTestsContainer) selectedPatientTestsContainer.style.display = 'none';
                }
            } else {
                //  console.log("Patient ID input is empty.");
                 if(selectedPatientTestsContainer) selectedPatientTestsContainer.style.display = 'none';
            }
        });
    }

    async function loadScreeningData(screeningId) { /* ... (som i forrige svar, bruker ny subcollection path) ... */ }
    
    async function confirmAndDeleteScreening(screeningId, patientId, dateObject) { /* ... (som i forrige svar, bruker ny subcollection path og oppdaterer UI) ... */ }

    async function saveDataToFirestore() { /* ... (som i forrige svar, bruker ny subcollection path og oppdaterer UI) ... */ }
    
    // --- Initialisering og Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        asymmetryChartDivs.forEach(divId => createEmptyPlot(divId, 'Enter Data', 300, 20));
        normativeChartDivs.forEach(divId => createEmptyPlot(divId, 'Enter Bodyweight', 250, 35));
        loadInputsFromLocalStorage();
        updateGraphsAndTable();
    });

    // ... (resten av event listeners som før) ...
    if (injuredSideRadio) injuredSideRadio.addEventListener('change', () => { updateGraphsAndTable(); saveInputsToLocalStorage(); });
    if (bodyweightInput) bodyweightInput.addEventListener('input', () => { updateGraphsAndTable(); saveInputsToLocalStorage(); });
    if (fpNrInput) fpNrInput.addEventListener('change', saveInputsToLocalStorage);
    if (ageInput) ageInput.addEventListener('change', saveInputsToLocalStorage);
    if (genderSelect) genderSelect.addEventListener('change', saveInputsToLocalStorage);
    if (sportInput) sportInput.addEventListener('change', saveInputsToLocalStorage);
    if (injuryInput) injuryInput.addEventListener('change', saveInputsToLocalStorage);
    allNumberInputs.forEach(input => { 
        input.addEventListener('input', updateGraphsAndTable); 
        input.addEventListener('change', saveInputsToLocalStorage); 
    });
    if (pdfPreviewButton) pdfPreviewButton.addEventListener('click', enterPreviewMode);
    if (exportExcelButton) exportExcelButton.addEventListener('click', exportTableToCsv);
    if (registerPatientButton) registerPatientButton.addEventListener('click', togglePatientData);
    if (previewExitButtonInline) previewExitButtonInline.addEventListener('click', exitPreviewMode);
    if (clearAllButton) clearAllButton.addEventListener('click', clearAllFields);
    if(saveDataButton) saveDataButton.addEventListener('click', saveDataToFirestore);
    
    if(logoutButton) {
        logoutButton.addEventListener('click', () => {
            signOut(auth).then(() => {
                console.log("User signed out successfully.");
                localStorage.removeItem(localStorageKey); 
                window.location.href = loginPageUrl;
            }).catch((error) => {
                console.error("Sign out error", error);
                showStatusMessage("Error signing out. Please try again.", "error");
            });
        });
    }
    window.addEventListener('load', () => { setTimeout(() => window.dispatchEvent(new Event('resize')), 200); });
    window.addEventListener('resize', () => {
        asymmetryChartDivs.concat(normativeChartDivs).forEach(divId => {
            const gd = document.getElementById(divId);
            if (gd && gd.classList.contains('js-plotly-plot')) { try { Plotly.Plots.resize(gd); } catch (e) { /* Ignorer */ } }
        });
    });

</script>
</body>
</html>
